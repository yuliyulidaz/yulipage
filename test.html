<!DOCTYPE html>
<html lang="ko" class="h-full antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë°œì·Œ ë¬¸êµ¬ ìƒì„±ê¸°</title>
    
    <!-- í°íŠ¸ ë¡œë“œ (ìµœì í™”: ìš”ì²­ëœ êµµê¸° 200, 300 ë°˜ì˜) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300&family=Noto+Sans+KR:wght@200&family=Nanum+Myeongjo&family=Nanum+Gothic&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/kopubbatang.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Pretendard Variable', 'Pretendard', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'Roboto', 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'sans-serif'],
                        serif: ['Noto Serif KR', 'serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        dark: {
                            bg: '#0f0f11',
                            panel: '#18181b',
                            border: '#27272a'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Pickr (Color Picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <style>
        /* Custom Styles for inputs that Tailwind doesn't cover easily */
        input[type="range"] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
        .dark input[type="range"]::-webkit-slider-runnable-track {
            background: #3f3f46;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* Custom Scrollbar for sidebar (Dark mode compatible) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #3f3f46;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .dark .glass-panel {
            background: rgba(24, 24, 27, 0.7);
        }
        
        .pattern-grid {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .dark .pattern-grid {
            background-image: radial-gradient(#3f3f46 1px, transparent 1px);
        }

        /* Pickr Customization to Fill Container */
        .pickr {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pickr .pcr-button {
            width: 100% !important;
            height: 100% !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        .pickr .pcr-button::before {
            border-radius: 0 !important;
        }
        .pcr-app {
            z-index: 9999 !important;
            font-family: 'Pretendard', sans-serif !important;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0"
  }
}
</script>
</head>
<body class="h-full bg-slate-50 dark:bg-zinc-950 text-slate-900 dark:text-slate-100 transition-colors duration-300 overflow-hidden flex flex-col items-center justify-center">

    <!-- App Container (Centered on large screens) -->
    <div class="w-full h-full max-w-[1200px] mx-auto bg-white dark:bg-dark-panel shadow-2xl flex flex-col border-x border-slate-200 dark:border-zinc-800">
        
        <!-- Header -->
        <header class="h-14 border-b border-slate-200 dark:border-dark-border flex items-center justify-between px-4 lg:px-6 bg-white dark:bg-dark-panel z-40 flex-shrink-0">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-brand-500/30">
                    <i class="ph ph-quotes"></i>
                </div>
                <!-- Title hidden on mobile to make room for buttons -->
                <h1 class="font-bold text-lg tracking-tight hidden md:block">ë°œì·Œ ë¬¸êµ¬ ìƒì„±ê¸°</h1>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- Mobile & Desktop Actions -->
                
                <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all dark-mode-toggle mr-1">
                    <i class="ph ph-moon text-xl"></i>
                </button>

                <!-- Copy Button (Mobile Visible with Text) -->
                <button onclick="copyImage()" class="copy-btn md:hidden flex items-center gap-1.5 px-3 py-1.5 bg-slate-100 dark:bg-zinc-800 text-slate-700 dark:text-slate-200 text-xs font-bold rounded-lg border border-slate-200 dark:border-zinc-700 active:scale-95 transition-transform">
                    <i class="ph ph-copy text-base"></i>
                    <span>ë³µì‚¬</span>
                </button>

                <!-- Save Button (Mobile Visible with Text) -->
                <button onclick="downloadImage()" class="md:hidden flex items-center gap-1.5 px-3 py-1.5 bg-brand-600 text-white text-xs font-bold rounded-lg shadow-sm active:scale-95 transition-transform">
                    <i class="ph ph-download-simple text-base"></i>
                    <span>ì €ì¥</span>
                </button>
            </div>
        </header>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
            
            <!-- Workspace (Preview) - Mobile: Top (Order 1), Desktop: Right (Order 2) -->
            <section class="order-1 md:order-2 w-full md:flex-1 h-[40vh] md:h-auto bg-slate-100 dark:bg-[#09090b] relative flex flex-col items-center justify-center p-4 md:p-8 lg:p-12 pattern-grid overflow-hidden flex-shrink-0 z-0 border-b md:border-b-0 border-slate-200 dark:border-zinc-800">
                
                <div class="relative w-full h-full flex items-center justify-center">
                     <!-- Canvas Wrapper -->
                    <div class="relative shadow-[0_20px_60px_-15px_rgba(0,0,0,0.2)] dark:shadow-[0_20px_60px_-15px_rgba(0,0,0,0.5)] transition-all duration-300 transform" id="canvasContainer">
                        <canvas id="canvas" width="1080" height="1080" class="max-w-full max-h-[35vh] md:max-h-[85vh] object-contain bg-white rounded-sm"></canvas>
                    </div>
                </div>

                <!-- Floating Action Bar - Desktop Only -->
                <div class="hidden md:flex absolute bottom-6 left-1/2 -translate-x-1/2 items-center gap-2 p-1.5 bg-white/90 dark:bg-zinc-800/90 backdrop-blur shadow-xl border border-slate-200 dark:border-zinc-700 rounded-2xl z-20">
                    <button onclick="downloadImage()" class="flex items-center gap-2 px-5 py-2.5 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-medium transition-transform active:scale-95 shadow-lg shadow-brand-500/20">
                        <i class="ph ph-download-simple text-lg"></i>
                        <span>ì €ì¥</span>
                    </button>
                    <div id="desktop-action-divider" class="w-px h-6 bg-slate-200 dark:bg-zinc-600 mx-1"></div>
                    <button onclick="copyImage()" class="copy-btn p-2.5 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-zinc-700 rounded-xl transition-colors" title="ë³µì‚¬">
                        <i class="ph ph-copy text-xl"></i>
                    </button>
                </div>
                
            </section>

            <!-- Left Sidebar (Controls) - Mobile: Bottom (Order 2), Desktop: Left (Order 1) -->
            <aside class="order-2 md:order-1 w-full md:w-[400px] lg:w-[420px] bg-white dark:bg-dark-panel border-t md:border-t-0 md:border-r border-slate-200 dark:border-dark-border flex flex-col flex-1 md:flex-none md:h-full z-30 md:shadow-none relative overflow-hidden" id="sidebar">
                
                <div class="h-full overflow-y-auto custom-scrollbar p-5 space-y-8 pb-10 md:pb-5">

                    <!-- Section: Content -->
                    <section class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">ë‚´ìš© ì…ë ¥</h2>
                            <button onclick="clearQuoteTextOnly()" class="text-xs text-red-500 hover:text-red-600 font-medium flex items-center gap-1">
                                <i class="ph ph-eraser"></i> ë¬¸êµ¬ë§Œ ì§€ìš°ê¸°
                            </button>
                        </div>
                        
                        <div class="relative group">
                            <textarea id="quote" placeholder="ì—¬ê¸°ì— ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="w-full h-32 p-4 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 transition-all text-sm leading-relaxed placeholder:text-slate-400"></textarea>
                            <div class="absolute bottom-3 right-3 text-slate-400 pointer-events-none">
                                <i class="ph ph-pencil-simple"></i>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-500">ì œì‘ì</label>
                                <input type="text" id="author" placeholder="ì œì‘ì (ì„ íƒ)" class="w-full px-3 py-2.5 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 transition-all">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-500">ìºë¦­í„°/ì œëª©</label>
                                <input type="text" id="title" placeholder="ìºë¦­í„°/ì œëª© (ì„ íƒ)" class="w-full px-3 py-2.5 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/50 focus:border-brand-500 transition-all">
                            </div>
                        </div>
                    </section>

                    <hr class="border-slate-100 dark:border-slate-800">

                    <!-- Section: Canvas Settings -->
                    <section class="space-y-4">
                        <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">ìº”ë²„ìŠ¤ ë¹„ìœ¨</h2>
                        
                        <!-- Ratio Selection: Icons -->
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="setRatio('1:1')" id="btn-ratio-1-1" class="ratio-btn flex flex-col items-center justify-center gap-2 p-3 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all bg-brand-50 dark:bg-slate-800 border-brand-500 dark:border-slate-500 ring-1 ring-brand-500 dark:ring-slate-500">
                                <div class="w-6 h-6 border-2 border-current rounded-sm"></div>
                                <span class="text-[10px] font-medium">1:1</span>
                            </button>
                            <button onclick="setRatio('4:5')" id="btn-ratio-4-5" class="ratio-btn flex flex-col items-center justify-center gap-2 p-3 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                                <div class="w-5 h-6 border-2 border-current rounded-sm"></div>
                                <span class="text-[10px] font-medium">4:5</span>
                            </button>
                            <button onclick="setRatio('16:9')" id="btn-ratio-16-9" class="ratio-btn flex flex-col items-center justify-center gap-2 p-3 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                                <div class="w-8 h-5 border-2 border-current rounded-sm mt-1 mb-0.5"></div>
                                <span class="text-[10px] font-medium">16:9</span>
                            </button>
                        </div>
                    </section>

                    <hr class="border-slate-100 dark:border-slate-800">

                    <!-- Section: Typography -->
                    <section class="space-y-4">
                        <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼</h2>
                        
                        <!-- Font Family Selection -->
                        <div class="space-y-2">
                            <!-- Serif Group -->
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setFont('Noto Serif KR')" class="font-btn p-2 text-xs border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all active-font" data-font="Noto Serif KR" style="font-family: 'Noto Serif KR', serif;">Noto Serif</button>
                                <button onclick="setFont('KoPub Batang')" class="font-btn p-2 text-xs border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all" data-font="KoPub Batang" style="font-family: 'KoPub Batang', serif;">KoPub ë°”íƒ•</button>
                                <button onclick="setFont('Nanum Myeongjo')" class="font-btn p-2 text-xs border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all" data-font="Nanum Myeongjo" style="font-family: 'Nanum Myeongjo', serif;">ë‚˜ëˆ”ëª…ì¡°</button>
                            </div>
                            <!-- Sans-Serif Group -->
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setFont('Pretendard')" class="font-btn p-2 text-xs border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all" data-font="Pretendard" style="font-family: 'Pretendard', sans-serif;">Pretendard</button>
                                <button onclick="setFont('Noto Sans KR')" class="font-btn p-2 text-xs border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all" data-font="Noto Sans KR" style="font-family: 'Noto Sans KR', sans-serif;">Noto Sans</button>
                                <button onclick="setFont('Nanum Gothic')" class="font-btn p-2 text-xs border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all" data-font="Nanum Gothic" style="font-family: 'Nanum Gothic', sans-serif;">ë‚˜ëˆ”ê³ ë”•</button>
                            </div>
                        </div>

                        <!-- Alignment & Break -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-50 dark:bg-black/20 p-1 rounded-lg flex border border-slate-200 dark:border-slate-700">
                                <!-- Radio Group for Align -->
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="align" value="left" checked class="peer hidden" id="align-left">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        <i class="ph ph-text-align-left text-lg"></i>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="align" value="center" class="peer hidden" id="align-center">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        <i class="ph ph-text-align-center text-lg"></i>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="align" value="right" class="peer hidden" id="align-right">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        <i class="ph ph-text-align-right text-lg"></i>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="align" value="justify" class="peer hidden" id="align-justify">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        <i class="ph ph-text-align-justify text-lg"></i>
                                    </div>
                                </label>
                            </div>

                            <div class="bg-slate-50 dark:bg-black/20 p-1 rounded-lg flex border border-slate-200 dark:border-slate-700">
                                 <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="linebreak" value="char" checked class="peer hidden" id="linebreak-char">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-xs font-medium text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        ê¸€ì
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="linebreak" value="word" class="peer hidden" id="linebreak-word">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-xs font-medium text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        ë‹¨ì–´
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Sliders -->
                        <div class="space-y-5 pt-2">
                            <div class="relative">
                                <div class="flex justify-between text-xs mb-2">
                                    <span class="text-slate-500">ê¸€ì í¬ê¸°</span>
                                    <span class="font-mono text-brand-600"><span id="fontSizeValue">42</span>px</span>
                                </div>
                                <input type="range" id="fontSize" min="30" max="80" value="42" class="w-full">
                            </div>
                            <div class="relative">
                                <div class="flex justify-between text-xs mb-2">
                                    <span class="text-slate-500">ì¤„ ê°„ê²©</span>
                                    <span class="font-mono text-brand-600"><span id="lineHeightValue">1.5</span>x</span>
                                </div>
                                <input type="range" id="lineHeight" min="1.2" max="2.0" step="0.1" value="1.5" class="w-full">
                            </div>
                            <div class="relative">
                                <div class="flex justify-between text-xs mb-2">
                                    <span class="text-slate-500">ì—¬ë°±</span>
                                    <span class="font-mono text-brand-600"><span id="paddingValue">100</span>px</span>
                                </div>
                                <input type="range" id="padding" min="50" max="200" step="10" value="100" class="w-full">
                            </div>
                        </div>
                    </section>

                    <hr class="border-slate-100 dark:border-slate-800">

                    <!-- Section: Style & Color -->
                    <section class="space-y-4">
                        <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">ë°°ê²½ ë° ìŠ¤íƒ€ì¼</h2>
                        
                        <div class="space-y-4">
                            <!-- 1. Text Color -->
                            <div class="space-y-2">
                                <label class="text-xs font-medium text-slate-500">ê¸€ì ìƒ‰ìƒ</label>
                                <div class="relative w-full h-10 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
                                    <div id="textColorPicker"></div>
                                </div>
                            </div>

                            <!-- 2. Background Mode Toggle (Default to Gradient) -->
                            <div class="bg-slate-50 dark:bg-black/20 p-1 rounded-lg flex border border-slate-200 dark:border-slate-700">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="bgMode" value="solid" class="peer hidden">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-xs font-medium text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        ë‹¨ìƒ‰
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="bgMode" value="gradient" checked class="peer hidden">
                                    <div class="w-full h-8 flex items-center justify-center rounded text-xs font-medium text-slate-400 peer-checked:bg-white dark:peer-checked:bg-slate-700 peer-checked:text-brand-600 peer-checked:shadow-sm transition-all">
                                        ê·¸ë¼ë°ì´ì…˜
                                    </div>
                                </label>
                            </div>

                            <!-- 3. Solid Color Settings (Hidden by default) -->
                            <div id="solidColorPanel" class="space-y-2 hidden">
                                <label class="text-xs font-medium text-slate-500">ë°°ê²½ ìƒ‰ìƒ</label>
                                <div class="relative w-full h-10 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
                                    <div id="bgColorMainPicker"></div>
                                </div>
                            </div>

                            <!-- 4. Gradient Settings (Visible by default) -->
                            <div id="gradientColorPanel" class="space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-slate-500">ì‹œì‘ ìƒ‰ìƒ</label>
                                        <div class="relative w-full h-10 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
                                            <div id="gradStartColorPicker"></div>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-medium text-slate-500">ë ìƒ‰ìƒ</label>
                                        <div class="relative w-full h-10 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden shadow-sm">
                                            <div id="gradEndColorPicker"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-medium text-slate-500">ë°©í–¥</label>
                                    <!-- Direction Grid Icons -->
                                    <div class="grid grid-cols-4 gap-2">
                                        <!-- Top Row -->
                                        <button onclick="setDirection('to bottom')" class="dir-btn h-9 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center text-slate-500" data-dir="to bottom" title="ìƒ â†’ í•˜"><i class="ph ph-arrow-down"></i></button>
                                        <button onclick="setDirection('to top')" class="dir-btn h-9 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center text-slate-500" data-dir="to top" title="í•˜ â†’ ìƒ"><i class="ph ph-arrow-up"></i></button>
                                        <button onclick="setDirection('to right')" class="dir-btn h-9 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center text-slate-500" data-dir="to right" title="ì¢Œ â†’ ìš°"><i class="ph ph-arrow-right"></i></button>
                                        <button onclick="setDirection('to left')" class="dir-btn h-9 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center text-slate-500" data-dir="to left" title="ìš° â†’ ì¢Œ"><i class="ph ph-arrow-left"></i></button>
                                        
                                        <!-- Bottom Row -->
                                        <button onclick="setDirection('to bottom right')" class="dir-btn h-9 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center text-slate-500 active-dir bg-brand-50 dark:bg-slate-800 border-brand-500 dark:border-slate-500 text-brand-600 dark:text-brand-400" data-dir="to bottom right" title="ì¢Œìƒ â†’ ìš°í•˜"><i class="ph ph-arrow-down-right"></i></button>
                                        <button onclick="setDirection('to top right')" class="dir-btn h-9 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center text-slate-500" data-dir="to top right" title="ì¢Œí•˜ â†’ ìš°ìƒ"><i class="ph ph-arrow-up-right"></i></button>
                                        <button onclick="setDirection('to bottom left')" class="dir-btn h-9 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center text-slate-500" data-dir="to bottom left" title="ìš°ìƒ â†’ ì¢Œí•˜"><i class="ph ph-arrow-down-left"></i></button>
                                        <button onclick="setDirection('to top left')" class="dir-btn h-9 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center justify-center text-slate-500" data-dir="to top left" title="ìš°í•˜ â†’ ì¢Œìƒ"><i class="ph ph-arrow-up-left"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 5. Color Presets (Split: Solid vs Gradient) -->
                        <div class="pt-1">
                            <!-- Gradient Palette -->
                            <div id="gradientPalette" class="flex gap-2 overflow-x-auto no-scrollbar py-1">
                                <button onclick="setPreset('gradient', '#a18cd1', '#fbc2eb', '#4A4A4A')" class="w-8 h-8 rounded-full border border-slate-200 shadow-sm flex-shrink-0" style="background: linear-gradient(to bottom right, #a18cd1, #fbc2eb)" title="Dreamy Purple"></button>
                                <button onclick="setPreset('gradient', '#0f2027', '#203a43', '#ffffff')" class="w-8 h-8 rounded-full border border-slate-200 shadow-sm flex-shrink-0" style="background: linear-gradient(to bottom right, #0f2027, #2c5364)" title="Deep Sea"></button>
                                <button onclick="setPreset('gradient', '#232526', '#414345', '#ffffff')" class="w-8 h-8 rounded-full border border-slate-200 shadow-sm flex-shrink-0" style="background: linear-gradient(to bottom right, #232526, #414345)" title="Midnight"></button>
                                <button onclick="setPreset('gradient', '#4b1248', '#f0c27b', '#ffffff')" class="w-8 h-8 rounded-full border border-slate-200 shadow-sm flex-shrink-0" style="background: linear-gradient(to bottom right, #4b1248, #f0c27b)" title="Sunset"></button>
                                <button onclick="setPreset('gradient', '#141E30', '#243B55', '#ffffff')" class="w-8 h-8 rounded-full border border-slate-200 shadow-sm flex-shrink-0" style="background: linear-gradient(to bottom right, #141E30, #243B55)" title="Royal Blue"></button>
                                <button onclick="setPreset('gradient', '#1a2a6c', '#b21f1f', '#ffffff')" class="w-8 h-8 rounded-full border border-slate-200 shadow-sm flex-shrink-0" style="background: linear-gradient(to bottom right, #1a2a6c, #b21f1f)" title="Mystic"></button>
                                <button onclick="setPreset('gradient', '#000000', '#434343', '#ffffff')" class="w-8 h-8 rounded-full border border-slate-200 shadow-sm flex-shrink-0" style="background: linear-gradient(to bottom right, #000000, #434343)" title="Charcoal"></button>
                            </div>
                            
                            <!-- Solid Palette (Hidden initially if gradient is default) -->
                            <div id="solidPalette" class="flex gap-2 overflow-x-auto no-scrollbar py-1 hidden">
                                <button onclick="setPreset('solid', '#E6E6FA', null, '#000000')" class="w-8 h-8 rounded-full bg-[#E6E6FA] border border-slate-200 shadow-sm flex-shrink-0" title="Lavender"></button>
                                <button onclick="setPreset('solid', '#000000', null, '#ffffff')" class="w-8 h-8 rounded-full bg-black border border-slate-200 shadow-sm flex-shrink-0" title="Black"></button>
                                <button onclick="setPreset('solid', '#1a1a1a', null, '#ffffff')" class="w-8 h-8 rounded-full bg-[#1a1a1a] border border-slate-200 shadow-sm flex-shrink-0" title="Dark Gray"></button>
                                <button onclick="setPreset('solid', '#1e293b', null, '#ffffff')" class="w-8 h-8 rounded-full bg-[#1e293b] border border-slate-200 shadow-sm flex-shrink-0" title="Slate"></button>
                                <button onclick="setPreset('solid', '#312e81', null, '#ffffff')" class="w-8 h-8 rounded-full bg-[#312e81] border border-slate-200 shadow-sm flex-shrink-0" title="Indigo"></button>
                                <button onclick="setPreset('solid', '#4a044e', null, '#ffffff')" class="w-8 h-8 rounded-full bg-[#4a044e] border border-slate-200 shadow-sm flex-shrink-0" title="Fuchsia"></button>
                                <button onclick="setPreset('solid', '#365314', null, '#ffffff')" class="w-8 h-8 rounded-full bg-[#365314] border border-slate-200 shadow-sm flex-shrink-0" title="Olive"></button>
                                <button onclick="setPreset('solid', '#881337', null, '#ffffff')" class="w-8 h-8 rounded-full bg-[#881337] border border-slate-200 shadow-sm flex-shrink-0" title="Rose"></button>
                            </div>
                        </div>

                        <!-- 6. Background Image -->
                        <div class="pt-2">
                            <label class="flex items-center justify-center w-full h-24 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl hover:border-brand-500 dark:hover:border-brand-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all cursor-pointer group">
                                <div class="text-center">
                                    <div class="text-slate-400 group-hover:text-brand-500 transition-colors mb-1">
                                        <i class="ph ph-image text-2xl"></i>
                                    </div>
                                    <span class="text-xs text-slate-500 group-hover:text-slate-700 dark:group-hover:text-slate-300">ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ</span>
                                </div>
                                <input type="file" id="bgImageUpload" accept="image/*" class="hidden">
                            </label>
                            
                            <div id="imageControlPanel" class="hidden mt-3 p-3 bg-slate-50 dark:bg-black/20 rounded-xl border border-slate-200 dark:border-slate-700 space-y-3">
                                <div class="flex justify-between items-center">
                                    <span id="imageFileName" class="text-xs text-slate-500 truncate max-w-[150px]"></span>
                                    <button id="btnImageDelete" onclick="deleteBackgroundImage()" class="text-xs text-red-500 hover:bg-red-50 p-1 rounded transition-colors"><i class="ph ph-trash"></i> ì‚­ì œ</button>
                                </div>
                                
                                <!-- Image Controls -->
                                <div id="imageOptions" class="space-y-3">
                                    <div class="flex bg-white dark:bg-slate-800 rounded-lg p-1 border border-slate-200 dark:border-slate-700">
                                        <label class="flex-1 cursor-pointer text-center">
                                            <input type="radio" name="imageFit" value="cover" checked class="peer hidden" id="fit-cover">
                                            <span class="block text-xs py-1 rounded text-slate-500 peer-checked:bg-brand-50 peer-checked:text-brand-600 font-medium">ì±„ìš°ê¸°</span>
                                        </label>
                                        <label class="flex-1 cursor-pointer text-center">
                                            <input type="radio" name="imageFit" value="contain" class="peer hidden" id="fit-contain">
                                            <span class="block text-xs py-1 rounded text-slate-500 peer-checked:bg-brand-50 peer-checked:text-brand-600 font-medium">ë§ì¶”ê¸°</span>
                                        </label>
                                    </div>
                                    
                                    <div class="grid grid-cols-3 gap-1 max-w-[120px] mx-auto">
                                        <!-- 3x3 Grid for Position -->
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="top-left" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="top-center" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="top-right" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="middle-left" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="middle-center" checked class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="middle-right" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="bottom-left" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="bottom-center" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                        <label class="aspect-square cursor-pointer"><input type="radio" name="imagePosition" value="bottom-right" class="peer hidden"><div class="w-full h-full border border-slate-200 rounded hover:bg-slate-100 peer-checked:bg-brand-500 peer-checked:border-brand-500"></div></label>
                                    </div>
                                    
                                    <div class="relative pt-2">
                                         <div class="flex justify-between text-xs mb-1">
                                            <span class="text-slate-500">ì´ë¯¸ì§€ í¬ê¸°</span>
                                            <span class="font-mono text-brand-600"><span id="scaleValue">100</span>%</span>
                                        </div>
                                        <input type="range" id="bgImageScale" min="10" max="200" value="100" class="w-full">
                                    </div>

                                    <div class="relative">
                                         <div class="flex justify-between text-xs mb-1">
                                            <span class="text-slate-500">ì˜¤ë²„ë ˆì´</span>
                                            <span class="font-mono text-brand-600" id="overlayValueText">ì›ë³¸</span>
                                        </div>
                                        <input type="range" id="overlayOpacity" min="-80" max="80" value="0" class="w-full">
                                        <div class="flex justify-between text-[10px] text-slate-400 mt-1 px-1">
                                            <span>ë°ê²Œ</span>
                                            <span>ì›ë³¸</span>
                                            <span>ì–´ë‘¡ê²Œ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <hr class="border-slate-100 dark:border-slate-800">

                    <!-- Section: Logo Settings -->
                    <section class="space-y-4">
                        <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">ë¡œê³  ì„¤ì •</h2>
                        
                         <div class="space-y-2">
                            <label class="text-xs font-medium text-slate-500">í”Œë«í¼ ë¡œê³ </label>
                            <select id="platformSelect" class="w-full appearance-none px-3 py-2.5 bg-slate-50 dark:bg-black/20 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500">
                                <option value="">ì„ íƒ ì•ˆí•¨</option>
                                <option value="dokiChat">ë„í‚¤ì±—</option>
                                <option value="luvDuv">ëŸ¬ë¹„ë”ë¹„</option>
                                <option value="reppley">ë ˆí”Œë¦¬</option>
                                <option value="rplay">ë¡œë§¨í‹±í”Œë ˆì´</option>
                                <option value="ropanAI">ë¡œíŒAI</option>
                                <option value="melting">ë©œíŒ…</option>
                                <option value="bloom">ë¸”ë£¸</option>
                                <option value="inkChat">ì‰í¬ì±—</option>
                                <option value="zeta">ì œíƒ€</option>
                                <option value="carat">ìºëŸ¿</option>
                                <option value="chemi">ì¼€ë°</option>
                                <option value="caveDuck">ì¼€ì´ë¸Œë•</option>
                                <option value="crack">í¬ë™</option>
                                <option value="pulse">í„ìŠ¤</option>
                                <option value="Fizzchat">í”¼ì¦ˆì±—</option>
                                <option value="whif">WHIF</option> 
                            </select>
                        </div>

                        <div class="space-y-1">
                             <div class="flex justify-between text-xs mb-1">
                                <span class="text-slate-500">ë¡œê³  í¬ê¸°</span>
                                <span class="font-mono text-brand-600"><span id="logoSizeValue">80</span>px</span>
                            </div>
                            <input type="range" id="logoSize" min="50" max="200" step="10" value="80" class="w-full">
                        </div>
                    </section>
                    
                    <!-- Footer Info -->
                    <footer class="mt-8 pt-8 border-t border-slate-100 dark:border-slate-800 text-xs text-slate-400 dark:text-slate-500 space-y-4 pb-8">
                         <!-- Sister Site Link -->
                        <a href="https://yuliyulidaz.github.io/yulipage/" target="_blank" class="block w-full p-3 bg-brand-50/50 dark:bg-brand900/10 border border-brand-100 dark:border-brand-800/30 rounded-xl hover:bg-brand-50 dark:hover:bg-brand-900/20 transition-all group">
                            <div class="flex items-center gap-2 text-brand-600 dark:text-brand-400 font-bold mb-0.5">
                                <i class="ph ph-file-text text-lg"></i>
                                <span>ë‚´ì§€ ìƒì„±ê¸°</span>
                            </div>
                            <p class="text-[11px] text-slate-500 dark:text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300">ì†Œì„¤ ë‚´ì§€ ì´ë¯¸ì§€ê°€ í•„ìš”í•˜ì‹ ê°€ìš”? ì—¬ê¸°ì„œ ë§Œë“¤ì–´ë³´ì„¸ìš”.</p>
                        </a>
                        
                        <div>
                            <h3 class="font-bold text-slate-500 dark:text-slate-400 mb-1">ğŸ“– ë°œì·Œ ë¬¸êµ¬ ìƒì„±ê¸° v1.3.1</h3>
                            <p>ë³¸ ì‚¬ì´íŠ¸ëŠ” ì–´ë– í•œ ê°œì¸ì •ë³´ë„ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ëª¨ë“  ì‘ì—…ì€ ê·€í•˜ì˜ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</p>
                        </div>
                        
                        <div class="space-y-2">
                            <h4 class="font-bold text-slate-500 dark:text-slate-400">âš ï¸ ì´ìš© ì‹œ ì£¼ì˜ì‚¬í•­</h4>
                            <ul class="list-disc list-outside pl-3 space-y-1 text-[11px] leading-relaxed">
                                <li><strong>ì €ì‘ê¶Œ ì±…ì„:</strong> ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ ë° í…ìŠ¤íŠ¸ì˜ ì €ì‘ê¶Œì€ ì‚¬ìš©ìì—ê²Œ ìˆìœ¼ë©°, ì €ì‘ê¶Œ ì¹¨í•´ì— ëŒ€í•œ ëª¨ë“  ë²•ì  ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.</li>
                                <li><strong>ì´ë¯¸ì§€ ì‚¬ìš©:</strong> íƒ€ì¸ì˜ ì €ì‘ë¬¼(ì‚¬ì§„, ì¼ëŸ¬ìŠ¤íŠ¸ ë“±)ì„ ë¬´ë‹¨ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. ì €ì‘ê¶Œìì˜ í—ˆë½ì„ ë°›ê±°ë‚˜ ì €ì‘ê¶Œì´ ì—†ëŠ” ì´ë¯¸ì§€ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</li>
                                <li><strong>í…ìŠ¤íŠ¸ ì¸ìš©:</strong> ì±…ì´ë‚˜ ê¸°íƒ€ ì €ì‘ë¬¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ë°œì·Œí•  ê²½ìš°, ì €ì‘ê¶Œë²•ìƒ í—ˆìš© ë²”ìœ„ ë‚´ì—ì„œ ì‚¬ìš©í•˜ê³  ì¶œì²˜ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.</li>
                                <li><strong>í”Œë«í¼ ë¡œê³ :</strong> ê° í”Œë«í¼ì˜ ë¡œê³ ëŠ” í•´ë‹¹ í”Œë«í¼ì˜ ìƒí‘œì´ë©°, ì‚¬ìš© ì‹œ ê° í”Œë«í¼ì˜ ë¸Œëœë“œ ê°€ì´ë“œë¼ì¸ì„ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                                <li><strong>ìƒì—…ì  ì´ìš©:</strong> ìƒì„±ëœ ì´ë¯¸ì§€ëŠ” ìƒì—…ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
                            </ul>
                            <p class="text-[10px] pt-1">ë³¸ ë„êµ¬ì˜ ì œì‘ìëŠ” ì‚¬ìš©ìê°€ ìƒì„±í•œ ì½˜í…ì¸ ì— ëŒ€í•´ ì–´ë– í•œ ì±…ì„ë„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ì´ë¯¸ì§€ ë° í…ìŠ¤íŠ¸ ì‚¬ìš©ìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ëª¨ë“  ë²•ì  ë¬¸ì œëŠ” ì‚¬ìš©ì ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤.</p>
                        </div>
                    </footer>
                </div>
                
            </aside>

        </main>
    </div>

    <!-- Scripts -->
    <script>
        // --- 1. State Management & Constants ---
        const state = {
            canvas: null,
            ctx: null,
            bgImage: null,
            bgImageName: null,
            logoImages: {}, // Preloaded logos
            platform: '',
            isDarkMode: localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches),
            // Colors managed by state now (synced with Pickr)
            bgType: 'gradient', // Default to Gradient
            gradDirection: 'to bottom right',
            canvasRatio: '1:1',
            fontFamily: 'Noto Serif KR',
            colors: {
                text: '#4A4A4A', // Default Text Color Changed to Dark Grey for Dreamy Purple
                bgMain: '#E6E6FA', // Default Solid Color: Lavender
                gradStart: '#a18cd1', // Default Gradient Start (Dreamy Purple)
                gradEnd: '#fbc2eb',   // Default Gradient End (Dreamy Purple)
            },
            pickrs: {}
        };

        const LOGO_URLS = {
            bloom: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/bloom.jpg',
            carat: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/carat.png',
            caveDuck: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/Caveduck.jpg',  
    	    dokiChat: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/dokichat.jpg',
            inkChat: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/inkchat.jpg',
            zeta: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/zeta.jpg',
            luvDuv: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/LoveyDovey.jpg',
            melting: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/melting.jpg',
            pulse: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/pulse.jpg',
            ropanAI: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/rofan.png',
            crack: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/crack.png',
            whif: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/whif.jpg',
            chemi: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/chemi.png',
            Fizzchat: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/Fizzchat.png',
            reppley: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/reppley.jpg',
            rplay: 'https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/rplay.png'
        };
        
        // --- 2. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initCanvas();
            initColorPickers();
            loadLogos();
            bindEvents();
            
            // Set default styling in UI
            updateRatioUI();
            updateFontUI();
            updateDirectionUI();

            // iOS Check to hide Copy buttons
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
                document.querySelectorAll('.copy-btn').forEach(el => el.style.display = 'none');
                const divider = document.getElementById('desktop-action-divider');
                if(divider) divider.style.display = 'none';
            }

            // Font Loading Fix: Wait for fonts to load before drawing
            document.fonts.ready.then(() => {
                updateCanvas();
            });
            // Fallback: Redraw after short delay to ensure fonts are applied
            setTimeout(updateCanvas, 500);
            setTimeout(updateCanvas, 1000);
            
            updateCanvas(); // Initial draw attempt
        });

        function initTheme() {
            if (state.isDarkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleDarkMode() {
            state.isDarkMode = !state.isDarkMode;
            localStorage.setItem('theme', state.isDarkMode ? 'dark' : 'light');
            initTheme();
        }

        function initCanvas() {
            state.canvas = document.getElementById('canvas');
            state.ctx = state.canvas.getContext('2d');
        }

        function initColorPickers() {
            const createPickr = (elId, defaultColor, key) => {
                let initialColor = defaultColor;

                const pickr = Pickr.create({
                    el: elId,
                    theme: 'classic',
                    default: defaultColor,
                    swatches: [
                        '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#22c55e', '#06b6d4',
                        '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef', '#f43f5e', '#000000', '#ffffff',
                        '#1a1a1a', '#0f2027', '#4b1248', '#203a43', '#2c5364', '#f0c27b'
                    ],
                    components: {
                        preview: true,
                        opacity: true,
                        hue: true,
                        interaction: {
                            hex: true,
                            input: true,
                            save: true,
                            cancel: true // ì·¨ì†Œ ë²„íŠ¼
                        }
                    },
                    i18n: {
                        'btn:save': 'í™•ì¸',
                        'btn:cancel': 'ì·¨ì†Œ',
                        'btn:clear': 'ì§€ìš°ê¸°'
                    }
                });

                // ì—´ë¦´ ë•Œ ìƒ‰ìƒ ì €ì¥
                pickr.on('show', (color, instance) => {
                    initialColor = state.colors[key];
                });

                // ìƒ‰ìƒ ë³€ê²½ ì‹œ (ë“œë˜ê·¸ ë“±) - ì¦‰ì‹œ ë°˜ì˜
                pickr.on('change', (color, source, instance) => {
                    const hex = color.toHEXA().toString();
                    state.colors[key] = hex;
                    updateCanvas();     
                });

                // ì €ì¥ ë²„íŠ¼ í´ë¦­
                pickr.on('save', (color, instance) => {
                    const hex = color.toHEXA().toString();
                    state.colors[key] = hex;
                    instance.applyColor(true); // ë²„íŠ¼ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
                    instance.hide();
                });

                // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ - ì´ì „ ìƒ‰ìœ¼ë¡œ ë³µêµ¬
                pickr.on('cancel', (instance) => {
                    state.colors[key] = initialColor;
                    pickr.setColor(initialColor, true); 
                    updateCanvas();
                    instance.hide();
                });
                
                // ì°½ì´ ë‹«í ë•Œ (ì €ì¥, ì·¨ì†Œ, ì™¸ë¶€í´ë¦­ ëª¨ë‘ í¬í•¨)
                pickr.on('hide', (instance) => {
                     // í•µì‹¬ ìˆ˜ì •: ì°½ì´ ë‹«í ë•Œ í˜„ì¬ í”¼ì»¤ì˜ ìƒ‰ìƒì„ ë²„íŠ¼ì— ê°•ì œ ì ìš©í•˜ì—¬
                     // "ì™¸ë¶€ í´ë¦­ ì‹œì—ë„ ìƒ‰ìƒì´ ì„ íƒëœ ìƒíƒœ"ë¡œ ë§Œë“¦.
                     // (ì·¨ì†Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•ŒëŠ” ìœ„ 'cancel' ì´ë²¤íŠ¸ì—ì„œ ì´ë¯¸ ì›ë³µí–ˆìœ¼ë¯€ë¡œ ê´œì°®ìŒ)
                     const currentColor = instance.getColor().toHEXA().toString();
                     // ë§Œì•½ ì·¨ì†Œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ë‹«íŒê²Œ ì•„ë‹ˆë¼ë©´ (ì™¸ë¶€ í´ë¦­ ë“±)
                     if (state.colors[key] === currentColor) {
                        instance.applyColor(true);
                     }
                });

                // íŒ”ë ˆíŠ¸(Swatch) í´ë¦­ ì‹œ
                pickr.on('swatchselect', (color) => {
                    const hex = color.toHEXA().toString();
                    state.colors[key] = hex;
                    pickr.setColor(hex); 
                    updateCanvas();
                });

                return pickr;
            };

            state.pickrs.text = createPickr('#textColorPicker', state.colors.text, 'text');
            state.pickrs.bgMain = createPickr('#bgColorMainPicker', state.colors.bgMain, 'bgMain');
            state.pickrs.gradStart = createPickr('#gradStartColorPicker', state.colors.gradStart, 'gradStart');
            state.pickrs.gradEnd = createPickr('#gradEndColorPicker', state.colors.gradEnd, 'gradEnd');
        }

        function loadLogos() {
            for (const [key, url] of Object.entries(LOGO_URLS)) {
                const img = new Image();
                img.crossOrigin = "Anonymous"; 
                img.src = url;
                state.logoImages[key] = img;
                // Redraw when loaded if this is the selected platform
                img.onload = () => {
                    if (state.platform === key) updateCanvas();
                };
            }
        }

        // --- 3. Event Binding ---
        function bindEvents() {
            // Text Inputs
            ['quote', 'author', 'title'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateCanvas);
            });

            // Style Inputs
            ['fontSize', 'lineHeight', 'padding', 'logoSize', 'overlayOpacity', 'bgImageScale'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('input', (e) => {
                    // Update value displays
                    if(id === 'fontSize') document.getElementById('fontSizeValue').innerText = e.target.value;
                    if(id === 'lineHeight') document.getElementById('lineHeightValue').innerText = e.target.value;
                    if(id === 'padding') document.getElementById('paddingValue').innerText = e.target.value;
                    if(id === 'logoSize') document.getElementById('logoSizeValue').innerText = e.target.value;
                    if(id === 'bgImageScale') document.getElementById('scaleValue').innerText = e.target.value;
                    if(id === 'overlayOpacity') {
                         const val = parseInt(e.target.value);
                         let text = "ì›ë³¸";
                         if(val < 0) text = `ë°ê²Œ ${Math.abs(val)}%`;
                         if(val > 0) text = `ì–´ë‘¡ê²Œ ${val}%`;
                         document.getElementById('overlayValueText').innerText = text;
                    }
                    updateCanvas();
                });
            });

            // Radio Groups
            document.querySelectorAll('input[name="align"], input[name="linebreak"], input[name="imageFit"], input[name="imagePosition"]').forEach(el => {
                el.addEventListener('change', updateCanvas);
            });
            
            // Background Mode Toggle
            document.querySelectorAll('input[name="bgMode"]').forEach(el => {
                el.addEventListener('change', (e) => {
                    state.bgType = e.target.value;
                    togglePaletteVisibility();
                    updateCanvas();
                });
            });

            // Platform Select
            document.getElementById('platformSelect').addEventListener('change', (e) => {
                state.platform = e.target.value;
                updateCanvas();
            });

            // Image Upload
            document.getElementById('bgImageUpload').addEventListener('change', handleImageUpload);
        }

        // --- 4. Logic Functions (Updated) ---
        
        function setRatio(ratio) {
            state.canvasRatio = ratio;
            updateRatioUI();
            resizeCanvas();
            updateCanvas();
        }

        function updateRatioUI() {
            // Remove active classes
            document.querySelectorAll('.ratio-btn').forEach(btn => {
                btn.classList.remove('bg-brand-50', 'dark:bg-slate-800', 'border-brand-500', 'dark:border-slate-500', 'ring-1', 'ring-brand-500', 'dark:ring-slate-500');
            });
            // Add active class
            const idMap = { '1:1': 'btn-ratio-1-1', '4:5': 'btn-ratio-4-5', '16:9': 'btn-ratio-16-9' };
            const activeBtn = document.getElementById(idMap[state.canvasRatio]);
            if(activeBtn) {
                activeBtn.classList.add('bg-brand-50', 'dark:bg-slate-800', 'border-brand-500', 'dark:border-slate-500', 'ring-1', 'ring-brand-500', 'dark:ring-slate-500');
            }
        }

        function setFont(fontName) {
            state.fontFamily = fontName;
            updateFontUI();
            
            // Improved Font Loading:
            // Explicitly load the font string before updating canvas to prevent "double click" issue.
            // Construct a font string similar to what is used in drawContent
            let fontWeight = '400';
            if (fontName === 'Noto Serif KR' || fontName === 'KoPub Batang') fontWeight = '300';
            else if (fontName === 'Noto Sans KR' || fontName === 'Pretendard') fontWeight = '200';
            
            const fontString = `${fontWeight} 40px '${fontName}'`;
            
            document.fonts.load(fontString).then(() => {
                updateCanvas();
            }).catch(() => {
                 // Fallback if load fails (or already loaded)
                 updateCanvas();
            });
            
            // Safety redraw for stubborn browsers
            setTimeout(updateCanvas, 100);
        }

        function updateFontUI() {
            document.querySelectorAll('.font-btn').forEach(btn => {
                if(btn.dataset.font === state.fontFamily) {
                    btn.classList.add('bg-brand-50', 'dark:bg-slate-800', 'border-brand-500', 'dark:border-slate-500', 'text-brand-600', 'dark:text-brand-400', 'ring-1', 'ring-brand-500', 'dark:ring-slate-500');
                } else {
                    btn.classList.remove('bg-brand-50', 'dark:bg-slate-800', 'border-brand-500', 'dark:border-slate-500', 'text-brand-600', 'dark:text-brand-400', 'ring-1', 'ring-brand-500', 'dark:ring-slate-500');
                }
            });
        }

        function setDirection(direction) {
            state.gradDirection = direction;
            updateDirectionUI();
            updateCanvas();
        }

        function updateDirectionUI() {
            document.querySelectorAll('.dir-btn').forEach(btn => {
                if(btn.dataset.dir === state.gradDirection) {
                    btn.classList.add('active-dir', 'bg-brand-50', 'dark:bg-slate-800', 'border-brand-500', 'dark:border-slate-500', 'text-brand-600', 'dark:text-brand-400');
                } else {
                    btn.classList.remove('active-dir', 'bg-brand-50', 'dark:bg-slate-800', 'border-brand-500', 'dark:border-slate-500', 'text-brand-600', 'dark:text-brand-400');
                }
            });
        }

        function togglePaletteVisibility() {
            const solidPanel = document.getElementById('solidColorPanel');
            const gradPanel = document.getElementById('gradientColorPanel');
            const solidPalette = document.getElementById('solidPalette');
            const gradPalette = document.getElementById('gradientPalette');

            if (state.bgType === 'solid') {
                solidPanel.classList.remove('hidden');
                gradPanel.classList.add('hidden');
                solidPalette.classList.remove('hidden');
                gradPalette.classList.add('hidden');
            } else {
                solidPanel.classList.add('hidden');
                gradPanel.classList.remove('hidden');
                solidPalette.classList.add('hidden');
                gradPalette.classList.remove('hidden');
            }
        }

        function resizeCanvas() {
            let width = 1080;
            let height = 1080;

            if (state.canvasRatio === '4:5') height = 1350;
            else if (state.canvasRatio === '16:9') { width = 1920; height = 1080; }

            state.canvas.width = width;
            state.canvas.height = height;
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    state.bgImage = img;
                    state.bgImageName = file.name;
                    document.getElementById('imageFileName').innerText = file.name;
                    document.getElementById('imageControlPanel').classList.remove('hidden');
                    updateCanvas();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function deleteBackgroundImage() {
            state.bgImage = null;
            state.bgImageName = null;
            document.getElementById('bgImageUpload').value = '';
            document.getElementById('imageControlPanel').classList.add('hidden');
            
            // Reset Overlay Settings
            document.getElementById('overlayOpacity').value = 0;
            document.getElementById('overlayValueText').innerText = "ì›ë³¸";
            
            updateCanvas();
        }
        
        function clearQuoteTextOnly() {
            document.getElementById('quote').value = '';
            // Author and Title are preserved
            updateCanvas();
        }

        function setPreset(type, color1, color2, textColor) {
            state.bgType = type;
            state.colors.text = textColor;
            
            if (type === 'solid') {
                state.colors.bgMain = color1;
                document.querySelector('input[name="bgMode"][value="solid"]').checked = true;
                if(state.pickrs.bgMain) state.pickrs.bgMain.setColor(color1, true);
            } else {
                state.colors.gradStart = color1;
                state.colors.gradEnd = color2;
                document.querySelector('input[name="bgMode"][value="gradient"]').checked = true;
                if(state.pickrs.gradStart) state.pickrs.gradStart.setColor(color1, true);
                if(state.pickrs.gradEnd) state.pickrs.gradEnd.setColor(color2, true);
            }

            if(state.pickrs.text) state.pickrs.text.setColor(textColor, true);
            togglePaletteVisibility();
            updateCanvas();
        }

        // --- 5. Drawing Core ---
        function updateCanvas() {
            if (!state.ctx) return;
            const ctx = state.ctx;
            const width = state.canvas.width;
            const height = state.canvas.height;

            // Clear
            ctx.clearRect(0, 0, width, height);

            // 1. Background
            drawBackground(ctx, width, height);

            // 2. Content (Text + Logo)
            drawContent(ctx, width, height);
        }

        function normalizeColor(color) {
            if (!color) return '#000000';
            // Check for 8-digit hex (e.g. #RRGGBBAA)
            if (/^#[0-9A-F]{8}$/i.test(color)) {
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                const a = parseInt(color.slice(7, 9), 16) / 255;
                return `rgba(${r}, ${g}, ${b}, ${a.toFixed(2)})`;
            }
            return color;
        }

        function drawBackground(ctx, width, height) {
            // Force reset alpha to prevent ghosting
            ctx.globalAlpha = 1;
            
            if (state.bgType === 'solid') {
                // Color Only
                let colorMain = normalizeColor(state.colors.bgMain);
                ctx.fillStyle = colorMain;
            } else {
                // Gradient Mode
                let x0 = 0, y0 = 0, x1 = 0, y1 = 0;
                
                switch(state.gradDirection) {
                    case 'to bottom': y1 = height; break;
                    case 'to top': y0 = height; y1 = 0; break;
                    case 'to right': x1 = width; break;
                    case 'to left': x0 = width; x1 = 0; break;
                    case 'to bottom right': x1 = width; y1 = height; break;
                    case 'to top right': y0 = height; x1 = width; y1 = 0; break;
                    case 'to bottom left': x0 = width; y1 = height; break;
                    case 'to top left': x0 = width; y0 = height; break;
                }
                
                const grad = ctx.createLinearGradient(x0, y0, x1, y1);
                grad.addColorStop(0, normalizeColor(state.colors.gradStart));
                grad.addColorStop(1, normalizeColor(state.colors.gradEnd));
                ctx.fillStyle = grad;
            }
            
            // Always fill the rect
            ctx.fillRect(0, 0, width, height);

            // Background Image
            if (state.bgImage) {
                drawImage(ctx, width, height);
            }

            // Overlay
            const overlayVal = parseInt(document.getElementById('overlayOpacity').value);
            
            if (overlayVal !== 0) {
                ctx.save();
                if (overlayVal < 0) {
                    // Light (White)
                    ctx.fillStyle = `rgba(255, 255, 255, ${Math.abs(overlayVal) / 100})`;
                } else {
                    // Dark (Black)
                    ctx.fillStyle = `rgba(0, 0, 0, ${overlayVal / 100})`;
                }
                ctx.fillRect(0, 0, width, height);
                ctx.restore();
            }
        }

        function drawImage(ctx, width, height) {
            const img = state.bgImage;
            const fit = document.querySelector('input[name="imageFit"]:checked').value;
            const position = document.querySelector('input[name="imagePosition"]:checked').value;
            const scalePercent = parseInt(document.getElementById('bgImageScale').value);
            const scale = scalePercent / 100;

            let sWidth = img.width;
            let sHeight = img.height;
            
            // Calculate draw dimensions based on fit mode (base size)
            let dWidth, dHeight;
            const imgRatio = sWidth / sHeight;
            const canvasRatio = width / height;

            if (fit === 'cover') {
                if (imgRatio > canvasRatio) {
                    dHeight = height;
                    dWidth = height * imgRatio;
                } else {
                    dWidth = width;
                    dHeight = width / imgRatio;
                }
            } else { // contain
                 if (imgRatio > canvasRatio) {
                    dWidth = width;
                    dHeight = width / imgRatio;
                } else {
                    dHeight = height;
                    dWidth = height * imgRatio;
                }
            }

            // Apply Scale
            dWidth *= scale;
            dHeight *= scale;

            // Calculate Position
            let dx, dy;
            const [vPos, hPos] = position.split('-');

            if (hPos === 'left') dx = 0;
            else if (hPos === 'center') dx = (width - dWidth) / 2;
            else if (hPos === 'right') dx = width - dWidth;

            if (vPos === 'top') dy = 0;
            else if (vPos === 'middle') dy = (height - dHeight) / 2;
            else if (vPos === 'bottom') dy = height - dHeight;

            ctx.drawImage(img, dx, dy, dWidth, dHeight);
        }

        function drawContent(ctx, width, height) {
            const quote = document.getElementById('quote').value;
            const author = document.getElementById('author').value;
            const title = document.getElementById('title').value;
            const platform = state.platform;
            
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const lineHeightMultiplier = parseFloat(document.getElementById('lineHeight').value);
            const padding = parseInt(document.getElementById('padding').value);
            const align = document.querySelector('input[name="align"]:checked').value;
            const fontFamily = state.fontFamily; // Use state, not select
            const breakMode = document.querySelector('input[name="linebreak"]:checked').value;
            const logoSize = parseInt(document.getElementById('logoSize').value);

            ctx.fillStyle = state.colors.text;
            ctx.textBaseline = 'middle';

            // --- Footer Metrics (Increased Size) ---
            const footerFontSize = Math.max(24, fontSize * 0.8);
            const footerLineHeight = footerFontSize * 1.5;

            // --- Quote Calculation ---
            // Determine font weight based on family for the thinnest look (Thin/Light Application)
            // Modified weights as requested (+100)
            let fontWeight = 400; // Default
            if (fontFamily === 'Noto Serif KR') fontWeight = 300;       // Light (was 200)
            else if (fontFamily === 'Noto Sans KR') fontWeight = 200;    // ExtraLight (was 100)
            else if (fontFamily === 'Pretendard') fontWeight = 200;      // ExtraLight (was 100)
            else if (fontFamily === 'KoPub Batang') fontWeight = 300;    // Light
            
            ctx.font = `${fontWeight} ${fontSize}px '${fontFamily}'`;
            const contentWidth = width - (padding * 2);
            
            const lineHeight = fontSize * lineHeightMultiplier;
            const lines = getLines(ctx, quote, contentWidth, breakMode);
            
            // --- Vertical Layout ---
            const hasFooterText = !!(author || title);
            const quoteBlockHeight = lines.length * lineHeight;
            const spacing = hasFooterText ? (fontSize * 1.0) : 0;
            const totalContentHeight = quoteBlockHeight + spacing + (hasFooterText ? footerLineHeight : 0);
            
            let currentY = (height - totalContentHeight) / 2 + (lineHeight / 2);

            // --- Draw Quote ---
            if (quote) {
                lines.forEach(line => {
                    let x;
                    if (align === 'left') x = padding;
                    else if (align === 'center') x = width / 2;
                    else if (align === 'right') x = width - padding;
                    else if (align === 'justify') x = width / 2; 

                    if (align === 'justify' && lines.length > 1) {
                         ctx.textAlign = 'center';
                         ctx.fillText(line, x, currentY);
                    } else {
                        ctx.textAlign = align === 'justify' ? 'center' : align;
                        ctx.fillText(line, x, currentY);
                    }
                    currentY += lineHeight;
                });
            }

            // --- Draw Footer Text (Fixed to Pretendard, Mixed Styles) ---
            if (hasFooterText) {
                currentY = currentY - (lineHeight/2) + spacing + (footerLineHeight / 2);
                
                // Prepare parts
                const authorPart = author || '';
                const separator = (author && title) ? ' | ' : '';
                const titlePart = title || '';

                // Force Fonts to Pretendard
                const footerFontFamily = 'Pretendard';
                const fontNormal = `200 ${footerFontSize}px '${footerFontFamily}'`;
                const fontBold = `400 ${footerFontSize}px '${footerFontFamily}'`;

                // Measure widths
                ctx.font = fontNormal;
                const wAuthor = ctx.measureText(authorPart).width;
                const wSep = ctx.measureText(separator).width;
                ctx.font = fontBold;
                const wTitle = ctx.measureText(titlePart).width;
                
                const totalFooterWidth = wAuthor + wSep + wTitle;

                // Calculate Start X
                let startX;
                if (align === 'left') {
                    startX = padding;
                } else if (align === 'center' || align === 'justify') {
                    startX = (width - totalFooterWidth) / 2;
                } else if (align === 'right') {
                    startX = width - padding - totalFooterWidth;
                }

                // Draw Parts
                ctx.textAlign = 'left'; // Always draw left-to-right from startX
                
                // 1. Author (Normal)
                ctx.font = fontNormal;
                ctx.fillText(authorPart, startX, currentY);
                
                // 2. Separator (Normal)
                ctx.fillText(separator, startX + wAuthor, currentY);

                // 3. Title (Bold)
                ctx.font = fontBold;
                ctx.fillText(titlePart, startX + wAuthor + wSep, currentY);
            }

            // --- Draw Logo (Fixed Position: Bottom Right) ---
            const logoImg = platform ? state.logoImages[platform] : null;
            if (logoImg && logoImg.complete && logoImg.naturalHeight !== 0) {
                const radius = logoSize / 2;
                const margin = 60; // Fixed margin from edges
                
                // Absolute Position: Bottom Right
                const logoX = width - margin - radius;
                const logoY = height - margin - radius;

                ctx.save();
                
                // Apply 20% Transparency (80% Opacity)
                ctx.globalAlpha = 0.8;
                
                ctx.beginPath();
                ctx.arc(logoX, logoY, radius, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();
                
                // Image fitting (cover)
                const aspect = logoImg.width / logoImg.height;
                let sw, sh, sx, sy;
                if (aspect > 1) {
                    sh = logoImg.height; sw = sh; sx = (logoImg.width - sw) / 2; sy = 0;
                } else {
                    sw = logoImg.width; sh = sw; sx = 0; sy = (logoImg.height - sh) / 2;
                }

                ctx.drawImage(logoImg, sx, sy, sw, sh, logoX - radius, logoY - radius, logoSize, logoSize);
                ctx.restore();
            }
        }

        function getLines(ctx, text, maxWidth, breakMode) {
            if (!text) return [];
            
            const paragraphs = text.split('\n');
            let lines = [];

            paragraphs.forEach(para => {
                if (breakMode === 'word') {
                    const words = para.split(' ');
                    let currentLine = words[0];

                    for (let i = 1; i < words.length; i++) {
                        const word = words[i];
                        const width = ctx.measureText(currentLine + " " + word).width;
                        if (width < maxWidth) {
                            currentLine += " " + word;
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    }
                    lines.push(currentLine);
                } else {
                    let currentLine = para[0] || '';
                    for (let i = 1; i < para.length; i++) {
                        const char = para[i];
                        const width = ctx.measureText(currentLine + char).width;
                        if (width < maxWidth) {
                            currentLine += char;
                        } else {
                            lines.push(currentLine);
                            currentLine = char;
                        }
                    }
                    lines.push(currentLine);
                }
            });
            return lines;
        }

        // --- 6. Export ---
        async function downloadImage() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isIOS && navigator.share) {
                 state.canvas.toBlob(async (blob) => {
                    const file = new File([blob], "lumina_quote.png", { type: "image/png" });
                    try {
                        await navigator.share({
                            files: [file],
                        });
                    } catch (err) {
                        console.log("Share failed or canceled", err);
                    }
                });
            } else {
                const link = document.createElement('a');
                link.download = `lumina_quote_${Date.now()}.png`;
                link.href = state.canvas.toDataURL('image/png');
                link.click();
            }
        }

        function copyImage() {
            state.canvas.toBlob(blob => {
                const item = new ClipboardItem({ "image/png": blob });
                navigator.clipboard.write([item]).then(() => {
                    alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                    alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            });
        }
    </script>
</body>
</html>
