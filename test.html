<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÏÜåÏÑ§ ÎÇ¥ÏßÄ ÏÉùÏÑ±Í∏∞ (A6 Î¨∏Í≥†Ìåê)</title>
    
    <!-- 1. Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Noto Serif KR (Î≥∏Î¨∏ Î™ÖÏ°∞) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400;500&display=swap" rel="stylesheet">
    <!-- Gowun Batang (Í≥†Ïö¥ Î∞îÌÉï) -->
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">
    <!-- Nanum Myeongjo (ÎÇòÎàî Î™ÖÏ°∞) -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- Hahmlet (Ìï®Î†õ) -->
    <link href="https://fonts.googleapis.com/css2?family=Hahmlet:wght@100;200;300;400;500;600&display=swap" rel="stylesheet">
    <!-- Noto Sans KR (ÏÜçÏßÄÏö© Í≥†Îîï) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400&display=swap" rel="stylesheet">
    
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 3. Libraries (React, ReactDOM, Babel, html-to-image) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"></script>

    <style>
        /* Ìè∞Ìä∏ Í∞ïÏ†ú Ï†ÅÏö© */
        * {
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            background: #f0f2f5;
            color: #1a1a1a;
            overscroll-behavior: none; /* Ïä§ÌÅ¨Î°§ ÌäïÍπÄ Î∞©ÏßÄ */
        }

        /* ÌïòÏù¥ÎùºÏù¥Ìä∏ Ïä§ÌÉÄÏùº - Í∑∏Î£π ID ÏÜçÏÑ± ÌôúÏö© */
        .highlight {
            display: inline;
            background: rgba(255, 235, 59, 0.4);
            padding: 0;
            margin: 0;
            line-height: inherit;
            letter-spacing: inherit;
            vertical-align: baseline;
            border: none;
            outline: none;
            cursor: pointer;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }
        
        .highlight-yellow { background: rgba(255, 235, 59, 0.4); }
        .highlight-pink { background: rgba(255, 182, 193, 0.4); }
        .highlight-mint { background: rgba(178, 255, 222, 0.4); }
        .highlight-blue { background: rgba(173, 216, 230, 0.4); }

        /* Í∏ÄÏûê ÏÉâ Ïä§ÌÉÄÏùº */
        .colored-text {
            display: inline;
            cursor: pointer;
            line-height: inherit;
            letter-spacing: inherit;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }
        .text-crimson { color: #be123c; } 
        .text-navy { color: #1e3a8a; }    
        .text-forest { color: #15803d; }
        .text-purple { color: #6b21a8; }
        .text-brown { color: #78350f; }
        .text-teal { color: #0f766e; }
        .text-gray { color: #9ca3af; }    
        
        /* Í∏ÄÏûê ÏÉâ ÏÑ†ÌÉù Î≤ÑÌäº (Î∞∞Í≤ΩÏÉâ) */
        .bg-text-crimson { background-color: #be123c; }
        .bg-text-navy { background-color: #1e3a8a; }
        .bg-text-forest { background-color: #15803d; }
        .bg-text-purple { background-color: #6b21a8; }
        .bg-text-brown { background-color: #78350f; }
        .bg-text-teal { background-color: #0f766e; }
        .bg-text-gray { background-color: #9ca3af; }

        /* ÌôîÎ©¥Ïö© Ïä§ÌÉÄÏùº - A6 ÎπÑÏú® (105:148) */
        .page-container {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: white;
            margin: 0 auto;
            width: 420px;  
            min-width: 420px; 
            flex-shrink: 0;
            height: 600px; 
            padding: 60px 60px 50px 60px; 
            position: relative;
            display: flex;
            flex-direction: column;
            transform-origin: top center;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* ÌÖåÎßàÎ≥Ñ Ïä§ÌÉÄÏùº */
        .theme-white.page-container { background: #ffffff; color: #1a1a1a; }
        .theme-cream.page-container { background: #fdfbf7; color: #2c241b; }
        .theme-kraft.page-container { background: #e6dac3; color: #3e2723; background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E"); }
        .theme-dark.page-container { background: #1a1a1a; color: #e5e5e5; }

        .page-content {
            height: 460px; 
            overflow: hidden;
            font-size: 12px;
            line-height: 1.8 !important;
            text-align: justify;
            letter-spacing: -0.02em;
            word-break: break-all;
            overflow-wrap: anywhere;
            font-weight: 300;
            cursor: text;
        }

        .page-content p {
            margin-bottom: 0;
            padding: 0;
            text-indent: 1em;
            line-height: 1.8 !important;
        }

        .page-content p.continued {
            text-indent: 0 !important;
        }
        
        .page-footer-area {
            height: 30px;
            margin-top: auto;
            display: flex;
            align-items: flex-end;
            padding-bottom: 0px;
        }

        /* ÏûÖÎ†• ÌôîÎ©¥ */
        .input-area {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .hidden-measure {
            position: absolute;
            visibility: hidden;
            top: -9999px;
            left: -9999px;
            width: 300px;
            font-size: 12px;
            line-height: 1.8 !important;
            text-align: justify;
            letter-spacing: -0.02em;
            word-break: break-all;
            overflow-wrap: anywhere;
            font-weight: 300;
        }
        
        .hidden-measure p {
            margin-bottom: 0;
            line-height: 1.8 !important;
        }

        .circle-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        .circle-btn:hover { transform: scale(1.1); }
        .circle-btn.active { border-color: #333; transform: scale(1.1); }
        
        .theme-btn-white { background: #ffffff; border: 1px solid #ddd; }
        .theme-btn-cream { background: #fdfbf7; border: 1px solid #e6e0d4; }
        .theme-btn-kraft { background: #e6dac3; border: 1px solid #cbbba0; }
        .theme-btn-dark { background: #1a1a1a; border: 1px solid #444; }

        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        
        .custom-placeholder {
            position: absolute;
            top: 24px; left: 24px; right: 24px; bottom: 24px;
            pointer-events: none;
            color: #94a3b8;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        @media (max-width: 450px) {
            #bookViewerWrapper {
                transform: scale(0.85);
                transform-origin: top center;
                height: 520px; 
            }
        }

        /* ----------------------------------------------------------------- */
        /* MOCKUP STYLES (Added) */
        /* ----------------------------------------------------------------- */
        .mockup-container {
            background-color: #F2F0E9; /* Warm Beige */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 80px;
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        .mockup-book-wrapper {
            position: relative;
            width: 840px; 
            height: 600px;
            /* Simple shadow (No stack effect) */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            transition: transform 0.3s ease;
        }

        .mockup-page {
            width: 420px;
            height: 600px;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        /* Gutter Shadows */
        .effect-gutter-left {
            position: absolute; top: 0; bottom: 0; right: 0; width: 60px;
            background: linear-gradient(to right, transparent, rgba(0,0,0,0.15));
            pointer-events: none; z-index: 20; mix-blend-mode: multiply;
        }
        .effect-gutter-right {
            position: absolute; top: 0; bottom: 0; left: 0; width: 60px;
            background: linear-gradient(to left, transparent, rgba(0,0,0,0.15));
            pointer-events: none; z-index: 20; mix-blend-mode: multiply;
        }

        /* Flyleaf Styles (Colophon) */
        .flyleaf {
            width: 100%; height: 100%;
            background-color: #1a2233; /* Deep Navy */
            padding: 60px;
            display: flex; flex-direction: column;
            justify-content: flex-end;
            position: relative;
            cursor: text;
        }
        .flyleaf.front { align-items: flex-start; text-align: left; }
        .flyleaf.back { align-items: flex-end; text-align: right; }

        .flyleaf textarea {
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: 300;
        }

        .flyleaf-hint {
            position: absolute; top: 24px; 
            color: rgba(255,255,255,0.3); font-size: 10px;
            pointer-events: none; white-space: nowrap;
        }
        .flyleaf.front .flyleaf-hint { left: 0; }
        .flyleaf.back .flyleaf-hint { right: 0; }

        .mockup-scaler { transform-origin: top center; }
        @media (max-width: 900px) {
            .mockup-scaler { transform: scale(0.45); margin-bottom: -300px; }
            .mockup-container { padding-top: 40px; }
        }
    </style>

</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
        const { useState, useRef, useEffect, useCallback } = React;

        // ----------------------------------------------------------------------
        // 1. Utils & Helpers
        // ----------------------------------------------------------------------

        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }
        
        function isIPad() {
            return /iPad/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }
        
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        async function ensureFontsLoaded() {
            try { await document.fonts.ready; } catch (e) { console.warn('Ìè∞Ìä∏ API ÌôïÏù∏ Ïã§Ìå®', e); }
        }

        const fontCache = new Map();
        
        const FONT_MAP = {
            'noto': { name: 'Î≥∏Î¨∏ Î™ÖÏ°∞', family: "'Noto Serif KR', serif", url: 'https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400;500&display=swap' },
            'nanum': { name: 'ÎÇòÎàî Î™ÖÏ°∞', family: "'Nanum Myeongjo', serif", url: 'https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap' },
            'hahmlet': { name: 'Ìï®Î†õ', family: "'Hahmlet', serif", url: 'https://fonts.googleapis.com/css2?family=Hahmlet:wght@100;200;300;400;500;600&display=swap' },
            'gowun': { name: 'Í≥†Ïö¥ Î∞îÌÉï', family: "'Gowun Batang', serif", url: 'https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap' }
        };

        async function prepareFontEmbedCSS(activeFontKey) {
            if (fontCache.has(activeFontKey)) return fontCache.get(activeFontKey);
            try {
                const fontInfo = FONT_MAP[activeFontKey];
                if (!fontInfo) return null;
                const cssRes = await fetch(fontInfo.url);
                let cssText = await cssRes.text();
                const urlRegex = /url\(([^)]+)\)/g;
                let match;
                const replacements = [];
                while ((match = urlRegex.exec(cssText)) !== null) {
                    const fullUrl = match[1].replace(/['"]/g, ''); 
                    replacements.push({ original: match[0], url: fullUrl });
                }
                await Promise.all(replacements.map(async (item) => {
                    try {
                        const fontRes = await fetch(item.url);
                        const fontBlob = await fontRes.blob();
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                cssText = cssText.replace(item.url, reader.result);
                                resolve();
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(fontBlob);
                        });
                    } catch (e) {}
                }));
                fontCache.set(activeFontKey, cssText);
                return cssText;
            } catch (e) { return null; }
        }

        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => { setDebouncedValue(value); }, delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        }

        // Generic Capture Function
        async function captureNode(node, fileName, width, height) {
            await ensureFontsLoaded();
            // Wait for font load
            if(isIOS()) await new Promise(r => setTimeout(r, 800));

            const options = {
                quality: 1.0, pixelRatio: 3, cacheBust: false,
                width: width, height: height,
                style: { transform: 'none', margin: '0' }
            };

            // iPad Double Shot
            if (isIPad()) {
                try { await htmlToImage.toBlob(node, options); } catch(e){}
                await new Promise(r => setTimeout(r, 200));
            }

            const blob = await htmlToImage.toBlob(node, options);
            if (!blob) throw new Error('Blob creation failed');

            if (isIOS() && navigator.share && navigator.canShare) {
                const file = new File([blob], fileName, { type: 'image/png' });
                if (navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: fileName });
                    return;
                }
            }
            
            // Fallback / PC / Android
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = fileName;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ----------------------------------------------------------------------
        // 2. Extracted Components (For Mockup & Preview)
        // ----------------------------------------------------------------------
        
        const PageContent = ({ pageIdx, pages, pageHighlights, metadata, activeFont, onMouseUp, onTouchEnd, onClick, contentRef }) => {
            const page = pages[pageIdx];
            if (!page) return null;

            if (pageHighlights && pageHighlights[pageIdx]) {
                return (
                    <div 
                        ref={contentRef}
                        className="page-content"
                        onMouseUp={onMouseUp}
                        onTouchEnd={onTouchEnd}
                        onClick={onClick}
                        dangerouslySetInnerHTML={{ __html: pageHighlights[pageIdx] }}
                    />
                );
            }

            return (
                <div ref={contentRef} className="page-content" onMouseUp={onMouseUp} onTouchEnd={onTouchEnd} onClick={onClick}>
                    {pageIdx === 0 && metadata.title && (
                        <div style={{height: '200px', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', marginBottom: 0}}>
                            <h1 className="text-base tracking-[0.1em] font-normal text-center px-4" style={{lineHeight: 1.8, maxHeight: '70px', overflow: 'hidden', opacity: 0.8}}>
                                {metadata.title}
                            </h1>
                            <div className="w-8 h-[1px] bg-current opacity-30 mx-auto mt-14"></div>
                        </div>
                    )}
                    {page.paragraphs.map((p, i) => (
                        <p key={i} className={p.isContinued ? 'continued' : ''} style={{ lineHeight: 1.8, textAlign: p.isSceneBreak ? 'center' : undefined, textIndent: p.isSceneBreak ? '0' : undefined }}>
                            {p.text}
                        </p>
                    ))}
                </div>
            );
        };

        const PageFooter = ({ pageIdx, isRight, metadata }) => {
            // Mockup spreads pass direct isRight boolean. Preview mode calculates based on index.
            const isOdd = (pageIdx + 1) % 2 !== 0;
            const alignRight = isRight !== undefined ? isRight : isOdd;

            return (
                <div className={`page-footer-area text-[9px] opacity-50 ${alignRight ? 'justify-end' : 'justify-start'}`}>
                    <div className={`flex items-center gap-2 ${alignRight ? 'flex-row' : 'flex-row-reverse'}`}>
                        {(metadata.producer || metadata.author) && (
                            <span>{[metadata.producer, metadata.author].filter(Boolean).join(' ¬∑ ')}</span>
                        )}
                        <span className="font-normal opacity-70">{pageIdx + 1}</span>
                    </div>
                </div>
            );
        };

        const Flyleaf = ({ isFront, isHidden, text, setText }) => {
            const hasContent = text && text.trim().length > 0;
            
            if (isHidden && !hasContent) {
                return <div className={`flyleaf ${isFront ? 'front' : 'back'}`}></div>;
            }

            const handleChange = (e) => {
                const val = e.target.value;
                const lines = val.split('\n');
                if (lines.length > 6) {
                    const truncated = lines.slice(0, 6).join('\n');
                    setText(truncated);
                } else {
                    setText(val);
                }
            };

            return (
                <div className={`flyleaf ${isFront ? 'front' : 'back'}`}>
                    <div className="w-1/2 relative z-10 flex flex-col" style={{ maxWidth: '50%' }}>
                        <div className={`w-[30px] h-px bg-white/50 mb-4 ${!isFront ? 'ml-auto' : ''}`}></div>
                        {!isHidden && !hasContent && (
                            <div className={`flyleaf-hint ${isFront ? 'text-left' : 'text-right'}`}>
                                ÌÅ¥Î¶≠ÌïòÏó¨ Î¨∏Íµ¨ ÏûÖÎ†•
                            </div>
                        )}
                        {(!isHidden || hasContent) && (
                            <textarea
                                value={text}
                                onChange={handleChange}
                                className={`w-full bg-transparent border-none text-white/70 text-[10px] p-0 focus:outline-none placeholder:text-transparent resize-none overflow-hidden ${isFront ? 'text-left' : 'text-right'}`}
                                rows={6}
                                spellCheck={false}
                                disabled={isHidden}
                                style={{ lineHeight: '1.6', maxHeight: '96px' }}
                            />
                        )}
                    </div>
                </div>
            );
        };

        const MockupBookRenderer = ({ spreadIdx, spreads, isCaptureMode = false, activeTheme, activeFont, frontFlyleafText, setFrontFlyleafText, backFlyleafText, setBackFlyleafText, pageHighlights, pages, metadata }) => {
            const spread = spreads[spreadIdx];
            if (!spread) return null;

            const renderSide = (sideData, isRight) => {
                if (!sideData) return <div className="mockup-page bg-transparent"></div>;

                if (sideData.type === 'flyleaf-front') {
                    return (
                        <div className="mockup-page">
                            <Flyleaf isFront={true} isHidden={isCaptureMode} text={frontFlyleafText} setText={setFrontFlyleafText} />
                            <div className="effect-gutter-left"></div>
                        </div>
                    );
                }
                if (sideData.type === 'flyleaf-back') {
                    return (
                        <div className="mockup-page">
                            <Flyleaf isFront={false} isHidden={isCaptureMode} text={backFlyleafText} setText={setBackFlyleafText} />
                            <div className="effect-gutter-right"></div>
                        </div>
                    );
                }
                if (sideData.type === 'page') {
                    return (
                        <div className={`mockup-page page-container theme-${activeTheme}`} style={{ fontFamily: FONT_MAP[activeFont].family }}>
                            <PageContent pageIdx={sideData.index} pages={pages} pageHighlights={pageHighlights} metadata={metadata} activeFont={activeFont} />
                            <PageFooter pageIdx={sideData.index} isRight={isRight} metadata={metadata} />
                            {isRight ? <div className="effect-gutter-right"></div> : <div className="effect-gutter-left"></div>}
                        </div>
                    );
                }
                return null;
            };

            return (
                <div className="mockup-book-wrapper">
                    {renderSide(spread.left, false)}
                    {renderSide(spread.right, true)}
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 3. Main Application Component
        // ----------------------------------------------------------------------

        const PAGE_CONTENT_HEIGHT = 460;
        const BOTTOM_BUFFER_P1 = 15;

        function App() {
            // -- State --
            const [step, setStep] = useState('input'); // 'input' | 'preview' | 'mockup'
            const [textInput, setTextInput] = useState('');
            const [metadata, setMetadata] = useState({ title: '', author: '', producer: '' });
            
            // Settings
            const [activeTheme, setActiveTheme] = useState('white'); 
            const [activeFont, setActiveFont] = useState('noto'); 
            
            // UI State
            const [activeTab, setActiveTab] = useState(null); 
            const [toolMode, setToolMode] = useState('highlight'); 
            
            const [pages, setPages] = useState([]);
            const [currentPageIdx, setCurrentPageIdx] = useState(0);
            const [pageHighlights, setPageHighlights] = useState({});
            
            const [currentHighlightColor, setCurrentHighlightColor] = useState('highlight-yellow');
            const [currentTextColor, setCurrentTextColor] = useState('text-crimson');
            
            const [isGenerating, setIsGenerating] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [loadingProgress, setLoadingProgress] = useState(0);
            
            const debouncedText = useDebounce(textInput, 500);
            const [estimatedPages, setEstimatedPages] = useState(0);

            // MOCKUP STATE
            const [mockupSpreadIdx, setMockupSpreadIdx] = useState(0);
            const [frontFlyleafText, setFrontFlyleafText] = useState('');
            const [backFlyleafText, setBackFlyleafText] = useState('');

            const measureContainerRef = useRef(null);
            const viewerRef = useRef(null);
            const contentRef = useRef(null);

            // -- Logic: Pagination --
            const calculatePages = (text, fontKey) => {
                const measureBox = measureContainerRef.current;
                if (!measureBox) return [];
                measureBox.style.fontFamily = FONT_MAP[fontKey].family;
                const rawParagraphs = text.split('\n');
                let currentParagraphs = [];
                let pageNum = 1;
                let resultPages = [];
                let queue = rawParagraphs.map(text => {
                    const trimmed = text.trim();
                    if (trimmed === '***') return { text: '*\u00A0\u00A0\u00A0\u00A0\u00A0*\u00A0\u00A0\u00A0\u00A0\u00A0*', isContinued: false, isSceneBreak: true };
                    return { text: text, isContinued: false, isSceneBreak: false };
                });
                measureBox.innerHTML = ''; 
                if (metadata.title && pageNum === 1) {
                    const titlePlaceholder = document.createElement('div');
                    titlePlaceholder.style.height = "200px"; titlePlaceholder.style.width = "100%"; titlePlaceholder.style.marginBottom = "0"; 
                    measureBox.appendChild(titlePlaceholder);
                }
                const findSplitIndex = (text, maxHeight, isContinued) => {
                    const tempP = document.createElement('p');
                    tempP.style.lineHeight = "1.8"; tempP.style.marginBottom = "0"; tempP.style.fontFamily = FONT_MAP[fontKey].family;
                    if (isContinued) tempP.classList.add('continued'); else tempP.style.textIndent = '1em';
                    measureBox.appendChild(tempP);
                    let low = 0; let high = text.length; let bestIdx = 0;
                    while (low <= high) {
                        const mid = Math.floor((low + high) / 2);
                        const subText = text.substring(0, mid);
                        tempP.textContent = subText;
                        if (tempP.offsetHeight <= maxHeight) { bestIdx = mid; low = mid + 1; } else { high = mid - 1; }
                    }
                    measureBox.removeChild(tempP);
                    return bestIdx;
                };
                while (queue.length > 0) {
                    const item = queue.shift();
                    const effectiveText = (!item.isSceneBreak && item.text.trim().length === 0) ? '\u00A0' : item.text;
                    const p = document.createElement('p');
                    p.textContent = effectiveText;
                    p.style.lineHeight = "1.8"; p.style.marginBottom = "0"; p.style.fontFamily = FONT_MAP[fontKey].family;
                    if (item.isSceneBreak) { p.style.textAlign = 'center'; p.style.textIndent = '0'; } else if (item.isContinued) { p.classList.add('continued'); } else { p.style.textIndent = '1em'; }
                    measureBox.appendChild(p);
                    const currentHeight = measureBox.scrollHeight;
                    const currentBuffer = (pageNum === 1) ? BOTTOM_BUFFER_P1 : 0;
                    const limitHeight = PAGE_CONTENT_HEIGHT - currentBuffer;
                    if (currentHeight <= limitHeight) {
                        currentParagraphs.push({ text: effectiveText, isContinued: item.isContinued, isSceneBreak: item.isSceneBreak });
                    } else {
                        measureBox.removeChild(p); 
                        const currentBaseHeight = measureBox.scrollHeight;
                        const availableHeight = limitHeight - currentBaseHeight;
                        if (availableHeight < 18) {
                            queue.unshift(item);
                        } else {
                            const splitIdx = findSplitIndex(effectiveText, availableHeight, item.isContinued);
                            if (splitIdx > 0) {
                                const partA = effectiveText.substring(0, splitIdx);
                                const partB = effectiveText.substring(splitIdx);
                                currentParagraphs.push({ text: partA, isContinued: item.isContinued, isSceneBreak: item.isSceneBreak });
                                if (partB.length > 0) queue.unshift({ text: partB, isContinued: true, isSceneBreak: item.isSceneBreak });
                            } else {
                                queue.unshift(item);
                            }
                        }
                        resultPages.push({ paragraphs: currentParagraphs });
                        currentParagraphs = [];
                        pageNum++;
                        measureBox.innerHTML = '';
                    }
                }
                if (currentParagraphs.length > 0) resultPages.push({ paragraphs: currentParagraphs });
                return resultPages;
            };

            useEffect(() => {
                if (step === 'input' && debouncedText) {
                    const p = calculatePages(debouncedText, activeFont);
                    setEstimatedPages(p.length);
                } else {
                    setEstimatedPages(0);
                }
            }, [debouncedText, step, activeFont, metadata.title]);

            const startGeneration = async (targetFont = null) => {
                const fontToUse = targetFont || activeFont;
                const txt = textInput;
                if (!txt.trim()) { if(!targetFont) alert("Î≥∏Î¨∏ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."); return; }
                if (document.activeElement instanceof HTMLElement) document.activeElement.blur();
                setIsGenerating(true);
                setTimeout(() => {
                    const resultPages = calculatePages(txt, fontToUse);
                    setPages(resultPages);
                    if (targetFont) {
                        setCurrentPageIdx(prev => Math.min(prev, resultPages.length - 1));
                        setActiveTab('style');
                    } else {
                        setCurrentPageIdx(0);
                        setPageHighlights({});
                        setActiveTab('style'); 
                    }
                    setStep('preview');
                    setIsGenerating(false);
                    if (!targetFont) setTimeout(() => window.scrollTo(0, 0), 100);
                }, 400);
            };

            const handleFontChange = (newFont) => {
                if (activeFont === newFont) return;
                if (window.confirm("Ìè∞Ìä∏Î•º Î≥ÄÍ≤ΩÌïòÎ©¥ ÌéòÏù¥ÏßÄ Î†àÏù¥ÏïÑÏõÉÏù¥ Îã§Ïãú Í≥ÑÏÇ∞Îê©ÎãàÎã§.\nÌòïÍ¥ëÌéú Î∞è ÏàòÏ†ï ÎÇ¥Ïö©Ïù¥ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                    setActiveFont(newFont);
                    setPageHighlights({});
                    startGeneration(newFont);
                }
            };

            const saveCurrentPageState = () => {
                if (contentRef.current) {
                     setPageHighlights(prev => ({ ...prev, [currentPageIdx]: contentRef.current.innerHTML }));
                }
            };

            const handleHighlightSelection = () => {
                if (activeTab !== 'tool') return;
                const selection = window.getSelection();
                if (!selection || selection.rangeCount === 0 || selection.toString().trim() === '') return;
                const range = selection.getRangeAt(0);
                const container = contentRef.current;
                if (!container || !container.contains(range.commonAncestorContainer)) return;
                const highlightId = 'hl-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                try {
                    const treeWalker = document.createTreeWalker(range.commonAncestorContainer, NodeFilter.SHOW_TEXT, { acceptNode: function(node) { if (!range.intersectsNode(node)) return NodeFilter.FILTER_REJECT; return NodeFilter.FILTER_ACCEPT; } });
                    const nodesToHighlight = [];
                    if (range.commonAncestorContainer.nodeType === Node.TEXT_NODE) { if (range.intersectsNode(range.commonAncestorContainer)) nodesToHighlight.push(range.commonAncestorContainer); }
                    else { let currentNode = treeWalker.nextNode(); while (currentNode) { nodesToHighlight.push(currentNode); currentNode = treeWalker.nextNode(); } }
                    nodesToHighlight.forEach(node => {
                        const nodeRange = document.createRange(); nodeRange.selectNodeContents(node);
                        if (node === range.startContainer) nodeRange.setStart(node, range.startOffset);
                        if (node === range.endContainer) nodeRange.setEnd(node, range.endOffset);
                        const text = nodeRange.toString();
                        if (text.trim().length > 0) {
                            const span = document.createElement('span');
                            if (toolMode === 'highlight') span.className = `highlight ${currentHighlightColor}`;
                            else span.className = `colored-text ${currentTextColor}`;
                            span.setAttribute('data-group-id', highlightId);
                            nodeRange.surroundContents(span);
                        }
                    });
                    selection.removeAllRanges();
                    saveCurrentPageState();
                } catch (e) { console.log("Highlight failed", e); }
            };

            const handleContentClick = (e) => {
                if (activeTab !== 'tool') return;
                const target = e.target;
                let shouldRemove = false;
                if (toolMode === 'highlight' && target.classList.contains('highlight')) shouldRemove = true;
                else if (toolMode === 'text' && target.classList.contains('colored-text')) shouldRemove = true;
                if (shouldRemove) {
                    const groupId = target.getAttribute('data-group-id');
                    if (groupId) {
                        const allSpans = contentRef.current.querySelectorAll(`span[data-group-id="${groupId}"]`);
                        allSpans.forEach(span => {
                            const text = span.textContent;
                            const textNode = document.createTextNode(text);
                            span.parentNode.replaceChild(textNode, span);
                        });
                        saveCurrentPageState();
                    }
                }
            };

            const goToPage = (idx) => {
                saveCurrentPageState();
                setCurrentPageIdx(idx);
                window.scrollTo(0, 0);
            };

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (step === 'preview') {
                        if (e.key === 'ArrowLeft' && currentPageIdx > 0) goToPage(currentPageIdx - 1);
                        else if (e.key === 'ArrowRight' && currentPageIdx < pages.length - 1) goToPage(currentPageIdx + 1);
                    } else if (step === 'mockup') {
                        if (e.key === 'ArrowLeft' && mockupSpreadIdx > 0) setMockupSpreadIdx(prev => prev - 1);
                        else if (e.key === 'ArrowRight' && mockupSpreadIdx < spreads.length - 1) setMockupSpreadIdx(prev => prev + 1);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [step, currentPageIdx, pages.length, mockupSpreadIdx]);

            const touchStartRef = useRef(null);
            const touchEndRef = useRef(null);
            const minSwipeDistance = 50;
            const onTouchStart = (e) => { touchEndRef.current = null; touchStartRef.current = e.targetTouches[0].clientX; };
            const onTouchMove = (e) => { touchEndRef.current = e.targetTouches[0].clientX; };
            const onTouchEnd = () => {
                if (activeTab === 'tool') return;
                if (!touchStartRef.current || !touchEndRef.current) return;
                const distance = touchStartRef.current - touchEndRef.current;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;
                if (step === 'preview') {
                    if (isLeftSwipe && currentPageIdx < pages.length - 1) goToPage(currentPageIdx + 1);
                    if (isRightSwipe && currentPageIdx > 0) goToPage(currentPageIdx - 1);
                } else if (step === 'mockup') {
                    if (isLeftSwipe && mockupSpreadIdx < spreads.length - 1) setMockupSpreadIdx(prev => prev + 1);
                    if (isRightSwipe && mockupSpreadIdx > 0) setMockupSpreadIdx(prev => prev - 1);
                }
            };

            const backToEdit = () => {
                if (window.confirm('ÌòïÍ¥ëÌéúÏù¥ Î™®Îëê ÏßÄÏõåÏßëÎãàÎã§. ÏàòÏ†ï ÌôîÎ©¥ÏúºÎ°ú Í∞ÄÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    setStep('input'); setPages([]); setPageHighlights({}); setCurrentPageIdx(0); setActiveTab(null); window.scrollTo(0, 0);
                }
            };
            const resetApp = () => {
                if (window.confirm('ÏûëÏóÖ ÎÇ¥Ïö©ÏùÑ ÏßÄÏö∞Í≥† Ï≤òÏùåÏúºÎ°ú ÎèåÏïÑÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    setStep('input'); setPages([]); setPageHighlights({}); setTextInput(''); setMetadata({ ...metadata, title: '', author: '', producer: '' }); setActiveTab(null); window.scrollTo(0, 0);
                }
            };

            const downloadCurrentPage = async () => {
                const target = document.getElementById('captureTarget');
                if (!target) return;
                const title = metadata.title || 'novel';
                const fileName = `${title}_${currentPageIdx + 1}p.png`;
                setLoadingMessage('Ï†ÄÏû• Ï§ë...');
                try {
                    await captureNode(target, fileName, 420, 600);
                } catch (error) {
                    console.error('[Îã§Ïö¥Î°úÎìú] Ïã§Ìå®:', error);
                    alert('Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                } finally {
                    setLoadingMessage('');
                }
            };

            const downloadAllPages = async () => {
                if (isMobile()) return; 
                if (!window.confirm(`Ï¥ù ${pages.length}Ïû•Ïùò Ïù¥ÎØ∏ÏßÄÎ•º Ï†ÄÏû•Ìï©ÎãàÎã§.`)) return;
                saveCurrentPageState();
                const originalPageIdx = currentPageIdx;
                window.scrollTo(0, 0);
                try {
                    await ensureFontsLoaded();
                    await prepareFontEmbedCSS(activeFont);
                    for (let i = 0; i < pages.length; i++) {
                        setCurrentPageIdx(i);
                        setLoadingMessage(`Ï†ÄÏû• Ï§ë... (${i + 1}/${pages.length})`);
                        setLoadingProgress(Math.floor(((i + 1) / pages.length) * 100));
                        await new Promise(resolve => setTimeout(resolve, 500));
                        const target = document.getElementById('captureTarget');
                        if (target) {
                            const fileName = `${metadata.title || 'novel'}_${String(i+1).padStart(3, '0')}p.png`;
                            await captureNode(target, fileName, 420, 600);
                        }
                    }
                    alert("ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
                } catch (e) { console.error(e); alert("Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."); } finally { setLoadingMessage(''); setLoadingProgress(0); setCurrentPageIdx(originalPageIdx); }
            };

            // MOCKUP LOGIC
            const getSpreads = useCallback(() => {
                const spreadList = [];
                spreadList.push({ left: { type: 'flyleaf-front' }, right: { type: 'page', index: 0 } });
                let i = 1;
                while (i < pages.length) {
                    const left = { type: 'page', index: i };
                    const right = (i + 1 < pages.length) ? { type: 'page', index: i + 1 } : null;
                    if (!right) { spreadList.push({ left, right: { type: 'flyleaf-back' } }); } 
                    else { spreadList.push({ left, right }); }
                    i += 2;
                }
                return spreadList;
            }, [pages.length]);

            const spreads = getSpreads();

            const goToMockup = () => {
                saveCurrentPageState();
                setMockupSpreadIdx(0);
                setStep('mockup');
                window.scrollTo(0,0);
            };

            const backToPreview = () => {
                setStep('preview');
                window.scrollTo(0,0);
            };

            const downloadCurrentMockup = async () => {
                const target = document.getElementById('mockupCaptureHidden'); 
                if(!target) return;
                const fileName = `${metadata.title || 'novel'}_mockup_${mockupSpreadIdx + 1}.png`;
                setLoadingMessage('Î™©ÏóÖ Ï†ÄÏû• Ï§ë...');
                captureNode(target, fileName, 1040, 800).catch(e => { console.error(e); alert('Ïã§Ìå®'); }).finally(() => setLoadingMessage(''));
            };

            const downloadAllMockups = async () => {
                if (isMobile()) return;
                if (!window.confirm(`Ï¥ù ${spreads.length}Ïû•Ïùò Î™©ÏóÖ Ïù¥ÎØ∏ÏßÄÎ•º Ï†ÄÏû•Ìï©ÎãàÎã§.`)) return;
                const originalSpreadIdx = mockupSpreadIdx;
                try {
                    for(let i=0; i<spreads.length; i++){
                        setMockupSpreadIdx(i);
                        setLoadingMessage(`Î™©ÏóÖ Ï†ÄÏû• Ï§ë... (${i+1}/${spreads.length})`);
                        await new Promise(r => setTimeout(r, 500));
                        const target = document.getElementById('mockupCaptureHidden');
                        if(target){
                            const fileName = `${metadata.title || 'novel'}_mockup_${String(i+1).padStart(2,'0')}.png`;
                            await captureNode(target, fileName, 1040, 800);
                        }
                    }
                    alert("ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
                } catch(e) { console.error(e); alert("Ïã§Ìå®"); }
                finally { setLoadingMessage(''); setMockupSpreadIdx(originalSpreadIdx); }
            };

            // -- Render --
            return (
                <div className="min-h-screen font-serif" onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
                    {/* Measurement Container (Hidden) */}
                    <div ref={measureContainerRef} className="hidden-measure"></div>

                    {/* Hidden Mockup Capture Target */}
                    {step === 'mockup' && (
                        <div style={{ position: 'fixed', top: '-10000px', left: '-10000px' }}>
                            <div id="mockupCaptureHidden" style={{ width: '1040px', height: '800px', display: 'flex', alignItems: 'center', justifyContent: 'center', backgroundColor: '#F2F0E9' }}>
                                <MockupBookRenderer 
                                    spreadIdx={mockupSpreadIdx} spreads={spreads} isCaptureMode={true} activeTheme={activeTheme} activeFont={activeFont}
                                    frontFlyleafText={frontFlyleafText} setFrontFlyleafText={setFrontFlyleafText}
                                    backFlyleafText={backFlyleafText} setBackFlyleafText={setBackFlyleafText}
                                    pageHighlights={pageHighlights} pages={pages} metadata={metadata}
                                />
                            </div>
                        </div>
                    )}

                    {/* Loading Overlay */}
                    {loadingMessage && (
                        <div className="fixed inset-0 bg-black/70 text-white flex flex-col items-center justify-center z-[9999]">
                            <div className="text-xl mb-4 font-light">{loadingMessage}</div>
                            {loadingProgress > 0 && <div className="text-sm opacity-80">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî ({loadingProgress}%)</div>}
                        </div>
                    )}

                    {/* STEP 1: INPUT */}
                    {step === 'input' && (
                        <div className="max-w-[900px] mx-auto my-10 bg-white p-6 md:p-10 rounded-2xl shadow-sm">
                            <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 border-b pb-4 gap-4">
                                <div className="flex items-center gap-3">
                                    <h1 className="text-2xl font-serif font-medium text-slate-800">ÏÜåÏÑ§ ÎÇ¥ÏßÄ ÏÉùÏÑ±Í∏∞</h1>
                                    <span className="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded font-bold">v1.1.2</span>
                                </div>
                                <a href="https://yuliyulidaz.github.io/yulilog/" target="_blank" rel="noreferrer" className="flex items-center gap-1.5 text-slate-400 hover:text-indigo-600 transition-colors py-1 px-2 rounded hover:bg-indigo-50 w-fit">
                                    <span className="text-lg">üîó</span><span className="text-xs font-medium">Î∞úÏ∑å Î¨∏Íµ¨ ÏÉùÏÑ±Í∏∞ Î∞îÎ°úÍ∞ÄÍ∏∞</span>
                                </a>
                            </div>
                            <div className="mb-6">
                                <label className="block text-sm text-slate-500 mb-1">Ï†úÎ™© (ÌïÑÏöîÏãú ÏûÖÎ†•)</label>
                                <input type="text" value={metadata.title} onChange={(e) => setMetadata({...metadata, title: e.target.value})} className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all" placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm text-slate-500 mb-1">Ï∫êÎ¶≠ÌÑ∞</label>
                                    <input type="text" value={metadata.author} onChange={(e) => setMetadata({...metadata, author: e.target.value})} className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all" />
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-500 mb-1">Ï†úÏûëÏûê</label>
                                    <input type="text" value={metadata.producer} onChange={(e) => setMetadata({...metadata, producer: e.target.value})} className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all" />
                                </div>
                            </div>
                            <div className="mb-6 relative">
                                <label className="block text-sm text-slate-500 mb-1 flex justify-between">
                                    <span>Î≥∏Î¨∏ ÎÇ¥Ïö©</span>
                                    {estimatedPages > 0 && <span className="text-indigo-600 font-bold">ÏòàÏÉÅ Î∂ÑÎüâ: ÏïΩ {estimatedPages} ÌéòÏù¥ÏßÄ</span>}
                                </label>
                                <div className="relative">
                                    {!textInput && (
                                        <div className="custom-placeholder">
                                            <p className="mb-4">Ïó¨Í∏∞Ïóê ÏÜåÏÑ§ Î≥∏Î¨∏ÏùÑ Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî.<br/>ÏóîÌÑ∞Î°ú Ï§ÑÎ∞îÍøàÏùÑ ÌïòÎ©¥ Îπà Ï§ÑÏù¥ Ï†ÅÏö©Îê©ÎãàÎã§.<br/>*** Î•º ÏûÖÎ†•ÌïòÎ©¥ Ïû•Î©¥ Ï†ÑÌôò(Ï§ëÏïô Ï†ïÎ†¨)Ïù¥ Ï†ÅÏö©Îê©ÎãàÎã§.</p>
                                            <div className="mt-6 border-t border-slate-100 pt-4">
                                                <strong className="block mb-2 text-indigo-400 text-xs">üì¢ 2025.11.20 ÏóÖÎç∞Ïù¥Ìä∏ ÏïàÎÇ¥ (v1.1.2)</strong>
                                                <ul className="list-disc pl-4 space-y-1 text-[11px] text-slate-400">
                                                    <li><strong>ÌÖåÎßà & Ìè∞Ìä∏:</strong> 4Í∞ÄÏßÄ Î∞∞Í≤Ω ÌÖåÎßàÏôÄ 4Ï¢ÖÏùò Ìè∞Ìä∏(ÎÇòÎàîÎ™ÖÏ°∞, Ìï®Î†õ Îì±) ÏßÄÏõê</li>
                                                    <li><strong>ÎèÑÍµ¨ ÌôïÏû•:</strong> ÌòïÍ¥ëÌéú Ïô∏Ïóê 'Í∏ÄÏûê ÏÉâ(ÏûâÌÅ¨)' Î≥ÄÍ≤Ω Í∏∞Îä• Ï∂îÍ∞Ä</li>
                                                    <li><strong>ÌòïÍ¥ëÌéú Í∏∞Îä•:</strong> Ïó¨Îü¨ Î¨∏Îã® ÎèôÏãú ÏÑ†ÌÉù Î∞è ÏùºÍ¥Ñ ÏÇ≠Ï†ú Í∏∞Îä• Ï∂îÍ∞Ä</li>
                                                    <li><strong>ÏòàÏÉÅ ÌéòÏù¥ÏßÄ:</strong> Î≥∏Î¨∏ÏùÑ Î∂ôÏó¨ ÎÑ£ÏúºÎ©¥ Ïò§Î•∏Ï™Ω ÏÉÅÎã®Ïóê ÏòàÏÉÅ ÌéòÏù¥ÏßÄ Ïàò ÏûêÎèô Í≥ÑÏÇ∞</li>
                                                    <li><strong>ÌéòÏù¥ÏßÄ ÎÑòÍπÄ:</strong> Î™®Î∞îÏùºÏóêÏÑú Ïä§ÏôÄÏù¥ÌîÑ/ PCÏóêÏÑú Î∞©Ìñ•ÌÇ§ Ïù¥Îèô ÏßÄÏõê</li>
                                                    <li><strong>Ìï¥ÏÉÅÎèÑ Í∞úÏÑ†:</strong> Ïù∏ÏáÑÎèÑ Í∞ÄÎä•Ìïú 300DPIÍ∏â Í≥†ÌôîÏßà Ï†ÄÏû• ÏßÄÏõê (1260x1800)</li>
                                                    <li><strong>ÏïàÏ†ïÏÑ±:</strong> ÏïÑÏù¥Ìå®Îìú Îì± iOS ÌôòÍ≤ΩÏóêÏÑú Ìè∞Ìä∏ Ï†ÅÏö©Ïù¥ Ïïà ÎêòÎçò ÌòÑÏÉÅ Í∞úÏÑ†</li>
                                                    <li><strong>(New) Î™©ÏóÖ:</strong> Í∞êÏÑ±Ï†ÅÏù∏ Ï±Ö ÌéºÏπ®Î©¥ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Í∏∞Îä• Ï∂îÍ∞Ä</li>
                                                </ul>
                                            </div>
                                        </div>
                                    )}
                                    <textarea value={textInput} onChange={(e) => setTextInput(e.target.value)} className="w-full h-[400px] p-6 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all resize-none font-serif leading-loose relative z-10 bg-transparent"></textarea>
                                </div>
                            </div>
                            <button onClick={() => startGeneration(null)} disabled={isGenerating} className="btn w-full py-4 bg-slate-800 text-white rounded-lg font-medium hover:bg-slate-700 shadow-lg flex justify-center items-center gap-2 disabled:opacity-70">
                                <span>{isGenerating ? 'ÏÉùÏÑ± Ï§ë...' : 'A6 Î†àÏù¥ÏïÑÏõÉ ÏÉùÏÑ±ÌïòÍ∏∞'}</span>
                            </button>
                             <footer className="max-w-4xl mx-auto px-6 py-10 text-slate-500 text-xs text-center leading-relaxed mt-12 border-t border-slate-200">
                                <p className="font-bold mb-2 text-sm text-slate-700">üìñ ÏÜåÏÑ§ ÎÇ¥ÏßÄ ÏÉùÏÑ±Í∏∞ v1.1.2</p>
                                <p className="mb-6">Î≥∏ ÏÇ¨Ïù¥Ìä∏Îäî Ïñ¥Îñ†Ìïú Í∞úÏù∏Ï†ïÎ≥¥ÎèÑ ÏàòÏßëÌïòÏßÄ ÏïäÏäµÎãàÎã§.<br/>Î™®Îì† ÏûëÏóÖÏùÄ Í∑ÄÌïòÏùò Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎßå Ïù¥Î£®Ïñ¥ÏßëÎãàÎã§.</p>
                                <div className="bg-slate-50 rounded-xl p-6 text-left inline-block w-full max-w-2xl border border-slate-100">
                                    <p className="font-bold mb-3 text-slate-700 flex items-center gap-2"><span className="text-base">‚ö†Ô∏è</span> Ïù¥Ïö© Ïãú Ï£ºÏùòÏÇ¨Ìï≠</p>
                                    <ul className="list-disc pl-4 space-y-2 mb-5 text-slate-600">
                                        <li><strong className="text-slate-700">ÌÖçÏä§Ìä∏ Ïù∏Ïö©:</strong> Ï±ÖÏù¥ÎÇò Í∏∞ÌÉÄ Ï†ÄÏûëÎ¨ºÏùò ÌÖçÏä§Ìä∏Î•º Î∞úÏ∑åÌï† Í≤ΩÏö∞, Ï†ÄÏûëÍ∂åÎ≤ïÏÉÅ ÌóàÏö© Î≤îÏúÑ ÎÇ¥ÏóêÏÑú ÏÇ¨Ïö©ÌïòÍ≥† Ï∂úÏ≤òÎ•º Î™ÖÏãúÌïòÏÑ∏Ïöî.</li>
                                        <li><strong className="text-slate-700">ÏÉÅÏóÖÏ†Å Ïù¥Ïö©:</strong> ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄÎäî ÏÉÅÏóÖÏ†ÅÏúºÎ°ú ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</li>
                                    </ul>
                                </div>
                            </footer>
                        </div>
                    )}

                    {/* STEP 2: PREVIEW */}
                    {step === 'preview' && (
                        <div className="pb-20 bg-gray-100 min-h-screen">
                            <div className="sticky top-0 z-50 bg-white shadow-sm">
                                <div className="flex items-center justify-between px-4 py-3 border-b border-slate-100 max-w-2xl mx-auto w-full">
                                    <div className="flex items-center gap-2">
                                        <button onClick={resetApp} className="flex flex-col items-center justify-center w-10 text-slate-500 hover:text-red-600 transition-colors">
                                            <span className="text-xl leading-none">‚Ü∫</span><span className="text-[9px] mt-0.5">Ï¥àÍ∏∞Ìôî</span>
                                        </button>
                                        <button onClick={backToEdit} className="flex flex-col items-center justify-center w-10 text-slate-500 hover:text-indigo-600 transition-colors">
                                            <span className="text-xl leading-none">‚úé</span><span className="text-[9px] mt-0.5">ÏàòÏ†ï</span>
                                        </button>
                                    </div>
                                    <div className="flex items-center gap-3 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                                        <button onClick={() => { if(currentPageIdx > 0) goToPage(currentPageIdx - 1) }} disabled={currentPageIdx === 0} className="text-slate-400 hover:text-slate-800 disabled:opacity-20 px-1">‚Äπ</button>
                                        <span className="font-serif tabular-nums text-sm w-12 text-center text-slate-700">{currentPageIdx + 1} / {pages.length}</span>
                                        <button onClick={() => { if(currentPageIdx < pages.length - 1) goToPage(currentPageIdx + 1) }} disabled={currentPageIdx === pages.length - 1} className="text-slate-400 hover:text-slate-800 disabled:opacity-20 px-1">‚Ä∫</button>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button onClick={goToMockup} className="bg-indigo-50 text-indigo-700 px-3 py-2 rounded-lg text-xs font-medium hover:bg-indigo-100 flex items-center gap-1">
                                            <span>üìñ</span><span>Î™©ÏóÖ</span>
                                        </button>
                                        <div className="w-px h-6 bg-slate-200 mx-1"></div>
                                        {!isMobile() && (
                                            <button onClick={downloadAllPages} className="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs font-medium hover:bg-slate-200 transition-colors">
                                                Ï†ÑÏ≤¥ Ï†ÄÏû•
                                            </button>
                                        )}
                                        <button onClick={downloadCurrentPage} className="bg-slate-800 text-white px-3 py-2 rounded-lg text-xs font-medium hover:bg-slate-700 shadow-sm flex items-center gap-1.5">
                                            <span className="text-sm">{isIOS() ? 'üì•' : 'üì•'}</span><span>{isIOS() ? 'Ï†ÄÏû•' : 'Ï†ÄÏû•'}</span>
                                        </button>
                                    </div>
                                </div>
                                <div className="flex border-b border-slate-200 max-w-2xl mx-auto w-full">
                                    <button onClick={() => setActiveTab(activeTab === 'style' ? null : 'style')} className={`flex-1 py-3 text-xs font-medium flex items-center justify-center gap-2 transition-all ${activeTab === 'style' ? 'text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/30' : 'text-slate-500 hover:bg-slate-50'}`}>
                                        <span>üé® Ïä§ÌÉÄÏùº ÏÑ§Ï†ï</span>
                                    </button>
                                    <button onClick={() => setActiveTab(activeTab === 'tool' ? null : 'tool')} className={`flex-1 py-3 text-xs font-medium flex items-center justify-center gap-2 transition-all ${activeTab === 'tool' ? 'text-pink-600 border-b-2 border-pink-600 bg-pink-50/30' : 'text-slate-500 hover:bg-slate-50'}`}>
                                        <span>üõ† ÎèÑÍµ¨</span>
                                    </button>
                                </div>
                                {activeTab && (
                                    <div className="bg-slate-50/80 backdrop-blur-sm border-b border-slate-200 animate-fade-in">
                                        <div className="max-w-2xl mx-auto w-full p-4">
                                            {activeTab === 'style' && (
                                                <div className="flex flex-col gap-5 animate-slide-down">
                                                    <div className="flex items-center justify-center gap-4">
                                                        <span className="text-[10px] tracking-widest text-slate-400 font-bold">THEME</span>
                                                        <div className="flex gap-3">
                                                            {['white', 'cream', 'kraft', 'dark'].map(theme => (
                                                                <button key={theme} onClick={() => setActiveTheme(theme)} className={`circle-btn theme-btn-${theme} ${activeTheme === theme ? 'active shadow-md' : ''}`} title={theme}></button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <div className="h-px bg-slate-200 w-full"></div>
                                                    <div className="flex flex-col items-center gap-2">
                                                        <div className="flex items-center gap-4">
                                                            <span className="text-[10px] tracking-widest text-slate-400 font-bold">FONT</span>
                                                            <div className="flex gap-1 bg-white p-1 rounded-lg border border-slate-200">
                                                                {Object.keys(FONT_MAP).map(key => (
                                                                    <button key={key} onClick={() => handleFontChange(key)} className={`px-3 py-1.5 text-xs rounded-md transition-all ${activeFont === key ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>
                                                                        {FONT_MAP[key].name}
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>
                                                        <p className="text-[10px] text-red-400 mt-1">‚ö† Ìè∞Ìä∏ Î≥ÄÍ≤Ω Ïãú ÌòïÍ¥ëÌéúÏù¥ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.</p>
                                                    </div>
                                                </div>
                                            )}
                                            {activeTab === 'tool' && (
                                                <div className="flex flex-col items-center gap-3 animate-slide-down">
                                                    <div className="flex bg-slate-200 rounded-lg p-1 mb-1">
                                                       <button onClick={() => setToolMode('highlight')} className={`px-3 py-1 text-xs rounded-md transition-all ${toolMode === 'highlight' ? 'bg-white shadow-sm text-slate-800 font-medium' : 'text-slate-500'}`}>üñç ÌòïÍ¥ëÌéú</button>
                                                       <button onClick={() => setToolMode('text')} className={`px-3 py-1 text-xs rounded-md transition-all ${toolMode === 'text' ? 'bg-white shadow-sm text-slate-800 font-medium' : 'text-slate-500'}`}>‚úíÔ∏è Í∏ÄÏûêÏÉâ</button>
                                                    </div>
                                                    <p className="text-[10px] text-slate-500">üí° Tip: Ìè∞Ìä∏Î•º Î®ºÏ†Ä ÌôïÏ†ïÌïú ÌõÑ ÎèÑÍµ¨Î•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.</p>
                                                    {toolMode === 'highlight' ? (
                                                        <div className="flex gap-4">
                                                            {['highlight-yellow', 'highlight-pink', 'highlight-mint', 'highlight-blue'].map(color => (
                                                                <button key={color} onClick={() => setCurrentHighlightColor(color)} className={`circle-btn ${color} ${currentHighlightColor === color ? 'border-slate-800 scale-110 shadow-sm' : ''}`}></button>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <div className="flex gap-4">
                                                            {[{ id: 'text-crimson', bg: 'bg-text-crimson' }, { id: 'text-navy', bg: 'bg-text-navy' }, { id: 'text-forest', bg: 'bg-text-forest' }, { id: 'text-purple', bg: 'bg-text-purple' }, { id: 'text-brown', bg: 'bg-text-brown' }, { id: 'text-teal', bg: 'bg-text-teal' }, { id: 'text-gray', bg: 'bg-text-gray' }].map(item => (
                                                                <button key={item.id} onClick={() => setCurrentTextColor(item.id)} className={`circle-btn ${item.bg} ${currentTextColor === item.id ? 'border-slate-800 scale-110 shadow-sm' : ''}`}></button>
                                                            ))}
                                                        </div>
                                                    )}
                                                    <p className="text-[10px] text-slate-400">ÎìúÎûòÍ∑∏ÌïòÏó¨ Ï†ÅÏö©, ÌÑ∞ÏπòÌïòÏó¨ ÏÇ≠Ï†ú</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div id="bookViewerWrapper" className="flex justify-center overflow-visible px-4 py-8 select-text cursor-text" onClick={() => {}}>
                                <div ref={viewerRef} id="captureTarget" className={`page-container theme-${activeTheme}`} style={{ fontFamily: FONT_MAP[activeFont].family }}>
                                    <PageContent 
                                        pageIdx={currentPageIdx} 
                                        pages={pages} 
                                        pageHighlights={pageHighlights} 
                                        metadata={metadata} 
                                        activeFont={activeFont} 
                                        onMouseUp={handleHighlightSelection} 
                                        onTouchEnd={handleHighlightSelection} 
                                        onClick={handleContentClick}
                                        contentRef={contentRef}
                                    />
                                    <PageFooter pageIdx={currentPageIdx} metadata={metadata} />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* STEP 3: MOCKUP */}
                    {step === 'mockup' && (
                        <div className="mockup-container">
                             <div className="fixed top-0 left-0 right-0 z-50 bg-slate-900/90 backdrop-blur-md text-white border-b border-slate-700">
                                <div className="flex items-center justify-between px-4 py-3 max-w-3xl mx-auto w-full">
                                    <button onClick={backToPreview} className="text-slate-300 hover:text-white flex items-center gap-1 text-xs font-medium">
                                        <span className="text-lg">‚Üê</span> ÎÇòÍ∞ÄÍ∏∞
                                    </button>
                                    <div className="flex items-center gap-3">
                                        <button onClick={() => { if(mockupSpreadIdx > 0) setMockupSpreadIdx(mockupSpreadIdx - 1) }} disabled={mockupSpreadIdx === 0} className="text-slate-400 hover:text-white disabled:opacity-20 px-2 text-xl">‚Äπ</button>
                                        <span className="font-serif tabular-nums text-sm text-slate-300">Spread {mockupSpreadIdx + 1} / {spreads.length}</span>
                                        <button onClick={() => { if(mockupSpreadIdx < spreads.length - 1) setMockupSpreadIdx(mockupSpreadIdx + 1) }} disabled={mockupSpreadIdx === spreads.length - 1} className="text-slate-400 hover:text-white disabled:opacity-20 px-2 text-xl">‚Ä∫</button>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {!isMobile() && <button onClick={downloadAllMockups} className="bg-slate-700 hover:bg-slate-600 text-xs px-3 py-2 rounded-lg text-slate-200">Ï†ÑÏ≤¥ Î™©ÏóÖ Ï†ÄÏû•</button>}
                                        <button onClick={downloadCurrentMockup} className="bg-indigo-600 hover:bg-indigo-500 text-xs px-3 py-2 rounded-lg text-white font-medium shadow-md flex items-center gap-1">
                                            <span>üì•</span> Ï†ÄÏû•
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div className="mockup-scaler mt-10">
                                <MockupBookRenderer 
                                    spreadIdx={mockupSpreadIdx} spreads={spreads} activeTheme={activeTheme} activeFont={activeFont}
                                    frontFlyleafText={frontFlyleafText} setFrontFlyleafText={setFrontFlyleafText}
                                    backFlyleafText={backFlyleafText} setBackFlyleafText={setBackFlyleafText}
                                    pageHighlights={pageHighlights} pages={pages} metadata={metadata}
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
