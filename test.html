<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸° (A6 ë¬¸ê³ íŒ)</title>
    
    <!-- 1. Fonts: Noto Serif KR, Gowun Batang, Nanum Myeongjo, Hahmlet -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&family=Hahmlet:wght@300;400&family=Nanum+Myeongjo&family=Noto+Serif+KR:wght@200;300;400&display=swap" rel="stylesheet">
    
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 3. Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"></script>

    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        * {
            -webkit-font-smoothing: antialiased;
            box-sizing: border-box;
        }

        body {
            background: #f0f2f5;
            color: #1a1a1a;
            overscroll-behavior: none;
        }

        /* í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .highlight {
            background-color: transparent; /* ê¸°ë³¸ íˆ¬ëª…, í´ë˜ìŠ¤ë¡œ ìƒ‰ìƒ ì œì–´ */
            cursor: pointer;
            border-radius: 2px;
            padding: 1px 0;
        }
        
        .highlight-yellow { background-color: rgba(255, 225, 0, 0.35); }
        .highlight-pink { background-color: rgba(255, 100, 150, 0.25); }
        .highlight-mint { background-color: rgba(0, 255, 180, 0.25); }
        .highlight-blue { background-color: rgba(0, 180, 255, 0.25); }

        /* í˜ì´ì§€ ì»¨í…Œì´ë„ˆ - A6 ë¹„ìœ¨ (105:148) -> 420px : 592px (approx 600px) */
        .page-container {
            margin: 0 auto;
            width: 420px;  
            min-width: 420px; 
            flex-shrink: 0;
            height: 600px; 
            padding: 60px 60px 50px 60px; 
            position: relative;
            display: flex;
            flex-direction: column;
            transition: background 0.3s, color 0.3s;
            /* ëª¨ë°”ì¼ ë¡±í„°ì¹˜ ë©”ë‰´ ë°©ì§€ */
            -webkit-touch-callout: none;
        }

        /* ì‰ë„ìš° ë³„ë„ ë¶„ë¦¬ (ë‹¤í¬ëª¨ë“œ ëŒ€ì‘) */
        .page-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .page-content {
            height: 460px; 
            overflow: hidden;
            font-size: 12px;
            line-height: 1.8 !important;
            text-align: justify;
            letter-spacing: -0.02em;
            word-break: break-all;
            overflow-wrap: anywhere;
            font-weight: 300;
            cursor: text;
        }

        .page-content p {
            margin-bottom: 0;
            padding: 0;
            text-indent: 1em;
            line-height: 1.8 !important;
        }

        .page-content p.continued {
            text-indent: 0 !important;
        }
        
        .page-footer-area {
            height: 30px;
            margin-top: auto;
            display: flex;
            align-items: flex-end;
            padding-bottom: 0px;
            font-weight: 300;
        }

        /* ì¸¡ì •ìš© ìˆ¨ê²¨ì§„ ë°•ìŠ¤ */
        .hidden-measure {
            position: absolute;
            visibility: hidden;
            top: -9999px;
            left: -9999px;
            width: 300px; 
            font-size: 12px;
            line-height: 1.8 !important;
            text-align: justify;
            letter-spacing: -0.02em;
            word-break: break-all;
            overflow-wrap: anywhere;
            font-weight: 300;
        }
        
        .hidden-measure p {
            margin-bottom: 0;
            line-height: 1.8 !important;
        }

        /* ìœ í‹¸ë¦¬í‹° */
        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        
        .color-btn {
            width: 24px; height: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .color-btn:hover { transform: scale(1.2); }
        .color-btn.active { transform: scale(1.2); border: 2px solid #555; }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 450px) {
            #bookViewerWrapper {
                transform: scale(0.85);
                transform-origin: top center;
                height: 520px; 
            }
        }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out forwards;
        }
        
        /* íŒ¨í„´ ë°°ê²½ (í¬ë¼í”„íŠ¸ìš©) */
        .bg-pattern-noise {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");
        }

        /* í”Œë ˆì´ìŠ¤í™€ë” ì˜¤ë²„ë ˆì´ */
        .placeholder-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            pointer-events: none;
            color: #94a3b8;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow: hidden;
        }
        .placeholder-hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
        const { useState, useRef, useEffect, useMemo, useCallback } = React;

        // ----------------------------------------------------------------------
        // 1. Constants & Configuration
        // ----------------------------------------------------------------------

        const FONTS = {
            'noto': { 
                name: 'ë³¸ë¬¸ ëª…ì¡°', 
                family: '"Noto Serif KR", serif', 
                urlPart: 'family=Noto+Serif+KR:wght@200;300;400' 
            },
            'nanum': { 
                name: 'ë‚˜ëˆ” ëª…ì¡°', 
                family: '"Nanum Myeongjo", serif', 
                urlPart: 'family=Nanum+Myeongjo' 
            },
            'hahmlet': { 
                name: 'í•¨ë ›', 
                family: '"Hahmlet", serif', 
                urlPart: 'family=Hahmlet:wght@300;400' 
            },
            'gowun': { 
                name: 'ê³ ìš´ ë°”íƒ•', 
                family: '"Gowun Batang", serif', 
                urlPart: 'family=Gowun+Batang' 
            }
        };

        const THEMES = {
            'white': { name: 'í™”ì´íŠ¸', bg: '#ffffff', text: '#1a1a1a', metaColor: '#9ca3af', isDark: false },
            'cream': { name: 'ë¯¸ìƒ‰', bg: '#fcfbf7', text: '#383530', metaColor: '#a8a29e', isDark: false },
            'kraft': { name: 'í¬ë¼í”„íŠ¸', bg: '#e8dfc8', text: '#3b3026', metaColor: '#8c7b6c', isDark: false, pattern: true },
            'dark': { name: 'ë‹¤í¬', bg: '#222222', text: '#d4d4d4', metaColor: '#6b7280', isDark: true }
        };

        // ----------------------------------------------------------------------
        // 2. Optimization: Font Caching
        // ----------------------------------------------------------------------

        const fontCache = {}; // ë©”ëª¨ë¦¬ ìºì‹œ

        async function getFontEmbedCSS(fontKey) {
            if (fontCache[fontKey]) return fontCache[fontKey];

            console.log(`[í°íŠ¸] ${fontKey} ë‹¤ìš´ë¡œë“œ...`);
            try {
                const fontConfig = FONTS[fontKey];
                const cssUrl = `https://fonts.googleapis.com/css2?${fontConfig.urlPart}&display=swap`;
                const cssRes = await fetch(cssUrl);
                let cssText = await cssRes.text();

                const urlRegex = /url\(([^)]+)\)/g;
                let match;
                const replacements = [];

                while ((match = urlRegex.exec(cssText)) !== null) {
                    const fullUrl = match[1].replace(/['"]/g, ''); 
                    replacements.push({ original: match[0], url: fullUrl });
                }

                await Promise.all(replacements.map(async (item) => {
                    try {
                        const fontRes = await fetch(item.url);
                        const fontBlob = await fontRes.blob();
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                cssText = cssText.replace(item.url, reader.result);
                                resolve();
                            };
                            reader.readAsDataURL(fontBlob);
                        });
                    } catch (e) {
                        console.warn('í°íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', item.url);
                    }
                }));

                fontCache[fontKey] = cssText;
                return cssText;
            } catch (e) {
                console.error('í°íŠ¸ CSS ìƒì„± ì‹¤íŒ¨:', e);
                return null;
            }
        }

        // ----------------------------------------------------------------------
        // 3. App Component
        // ----------------------------------------------------------------------

        const PAGE_CONTENT_HEIGHT = 460;
        const BOTTOM_BUFFER_P1 = 15;

        function App() {
            // State
            const [step, setStep] = useState('input'); 
            const [textInput, setTextInput] = useState('');
            const [metadata, setMetadata] = useState({ title: '', author: '', producer: '' });
            
            // Estimation State
            const [estimatedPages, setEstimatedPages] = useState(0);
            const [isEstimating, setIsEstimating] = useState(false);

            // Design
            const [activeTheme, setActiveTheme] = useState('white');
            const [activeFont, setActiveFont] = useState('noto');

            // Pages
            const [pages, setPages] = useState([]);
            const [currentPageIdx, setCurrentPageIdx] = useState(0);
            const [pageHighlights, setPageHighlights] = useState({});
            
            // Tool State (Mutex: 'style' | 'highlight' | null)
            const [activeTab, setActiveTab] = useState('style');
            const [currentHighlightColor, setCurrentHighlightColor] = useState('highlight-yellow');
            
            // UI
            const [isGenerating, setIsGenerating] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [loadingProgress, setLoadingProgress] = useState(0);

            const measureContainerRef = useRef(null);
            const viewerRef = useRef(null);
            const contentRef = useRef(null);
            const touchStartRef = useRef(null);

            // Check Device Types
            const isMobile = useMemo(() => {
                return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            }, []);
            
            const isIOS = useMemo(() => {
                return /iPhone|iPad|iPod/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            }, []);

            // -- Logic: Pagination Helper --
            const findSplitIndex = (text, maxHeight, isContinued) => {
                const measureBox = measureContainerRef.current;
                if (!measureBox) return 0;
                
                const tempP = document.createElement('p');
                // [ì¤‘ìš”] í•­ìƒ ê°€ì¥ ë„“ì€ í°íŠ¸(ë³¸ë¬¸ ëª…ì¡°)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¸¡ì •
                tempP.style.fontFamily = FONTS['noto'].family;
                tempP.style.lineHeight = "1.8";
                tempP.style.marginBottom = "0";
                
                if (isContinued) tempP.classList.add('continued');
                else tempP.style.textIndent = '1em';
                
                measureBox.appendChild(tempP);
                
                let low = 0;
                let high = text.length;
                let bestIdx = 0;

                while (low <= high) {
                    const mid = Math.floor((low + high) / 2);
                    const subText = text.substring(0, mid);
                    tempP.textContent = subText;
                    
                    if (tempP.offsetHeight <= maxHeight) {
                        bestIdx = mid;
                        low = mid + 1;
                    } else {
                        high = mid - 1;
                    }
                }
                
                measureBox.removeChild(tempP);
                return bestIdx;
            };

            // -- Effect: Calculate Estimated Pages (Debounced) --
            useEffect(() => {
                if (step !== 'input') return;
                
                if (!textInput.trim()) {
                    setEstimatedPages(0);
                    setIsEstimating(false);
                    return;
                }

                setIsEstimating(true);

                const timer = setTimeout(() => {
                    const measureBox = measureContainerRef.current;
                    if (!measureBox) return;

                    // [ì¤‘ìš”] í•­ìƒ ê°€ì¥ ë„“ì€ í°íŠ¸(ë³¸ë¬¸ ëª…ì¡°)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¸¡ì •
                    measureBox.style.fontFamily = FONTS['noto'].family;
                    const rawParagraphs = textInput.split('\n');
                    let pageCount = 1;
                    
                    let queue = rawParagraphs.map(text => {
                        const trimmed = text.trim();
                        if (trimmed === '***') {
                            return { text: '*\u00A0\u00A0\u00A0\u00A0\u00A0*\u00A0\u00A0\u00A0\u00A0\u00A0*', isContinued: false, isSceneBreak: true };
                        }
                        return { text: text, isContinued: false, isSceneBreak: false };
                    });

                    measureBox.innerHTML = ''; 
                    
                    if (metadata.title && pageCount === 1) {
                        const titlePlaceholder = document.createElement('div');
                        titlePlaceholder.style.height = "200px";
                        titlePlaceholder.style.marginBottom = "0"; 
                        measureBox.appendChild(titlePlaceholder);
                    }

                    while (queue.length > 0) {
                        const item = queue.shift();
                        const effectiveText = (!item.isSceneBreak && item.text.trim().length === 0) ? '\u00A0' : item.text;

                        const p = document.createElement('p');
                        p.textContent = effectiveText;
                        p.style.fontFamily = FONTS['noto'].family; // [ì¤‘ìš”] ë³¸ë¬¸ ëª…ì¡° ê¸°ì¤€
                        p.style.lineHeight = "1.8";
                        p.style.marginBottom = "0";
                        
                        if (item.isSceneBreak) {
                            p.style.textAlign = 'center';
                            p.style.textIndent = '0';
                        } else if (item.isContinued) {
                            p.classList.add('continued');
                        } else {
                            p.style.textIndent = '1em';
                        }

                        measureBox.appendChild(p);
                        
                        const currentHeight = measureBox.scrollHeight;
                        const currentBuffer = (pageCount === 1) ? BOTTOM_BUFFER_P1 : 0;
                        const limitHeight = PAGE_CONTENT_HEIGHT - currentBuffer;

                        if (currentHeight > limitHeight) {
                            measureBox.removeChild(p); 
                            const availableHeight = limitHeight - measureBox.scrollHeight;

                            if (availableHeight < 18) {
                                queue.unshift(item);
                            } else {
                                const splitIdx = findSplitIndex(effectiveText, availableHeight, item.isContinued);
                                if (splitIdx > 0) {
                                    if (effectiveText.substring(splitIdx).length > 0) {
                                        queue.unshift({ text: effectiveText.substring(splitIdx), isContinued: true, isSceneBreak: item.isSceneBreak });
                                    }
                                } else {
                                    queue.unshift(item);
                                }
                            }
                            pageCount++;
                            measureBox.innerHTML = '';
                        }
                    }
                    
                    setEstimatedPages(pageCount);
                    setIsEstimating(false);
                }, 800);

                return () => clearTimeout(timer);
            }, [textInput, metadata.title, step]); 


            const startGeneration = async () => {
                if (!textInput.trim()) {
                    alert("ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (document.activeElement instanceof HTMLElement) document.activeElement.blur();

                setIsGenerating(true);
                
                setTimeout(() => {
                    const resultPages = [];
                    const measureBox = measureContainerRef.current;
                    if (!measureBox) { setIsGenerating(false); return; }

                    // [ì¤‘ìš”] í•­ìƒ ê°€ì¥ ë„“ì€ í°íŠ¸(ë³¸ë¬¸ ëª…ì¡°)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¸¡ì •
                    measureBox.style.fontFamily = FONTS['noto'].family;
                    const rawParagraphs = textInput.split('\n');
                    let currentParagraphs = [];
                    let pageNum = 1;
                    
                    let queue = rawParagraphs.map(text => {
                        const trimmed = text.trim();
                        if (trimmed === '***') {
                            return { text: '*\u00A0\u00A0\u00A0\u00A0\u00A0*\u00A0\u00A0\u00A0\u00A0\u00A0*', isContinued: false, isSceneBreak: true };
                        }
                        return { text: text, isContinued: false, isSceneBreak: false };
                    });

                    measureBox.innerHTML = ''; 
                    
                    if (metadata.title && pageNum === 1) {
                        const titlePlaceholder = document.createElement('div');
                        titlePlaceholder.style.height = "200px";
                        titlePlaceholder.style.width = "100%";
                        titlePlaceholder.style.marginBottom = "0"; 
                        measureBox.appendChild(titlePlaceholder);
                    }

                    while (queue.length > 0) {
                        const item = queue.shift();
                        const effectiveText = (!item.isSceneBreak && item.text.trim().length === 0) ? '\u00A0' : item.text;

                        const p = document.createElement('p');
                        p.textContent = effectiveText;
                        p.style.fontFamily = FONTS['noto'].family; // [ì¤‘ìš”] ë³¸ë¬¸ ëª…ì¡° ê¸°ì¤€
                        p.style.lineHeight = "1.8";
                        p.style.marginBottom = "0";
                        
                        if (item.isSceneBreak) {
                            p.style.textAlign = 'center';
                            p.style.textIndent = '0';
                        } else if (item.isContinued) {
                            p.classList.add('continued');
                        } else {
                            p.style.textIndent = '1em';
                        }

                        measureBox.appendChild(p);
                        
                        const currentHeight = measureBox.scrollHeight;
                        const currentBuffer = (pageNum === 1) ? BOTTOM_BUFFER_P1 : 0;
                        const limitHeight = PAGE_CONTENT_HEIGHT - currentBuffer;

                        if (currentHeight <= limitHeight) {
                            currentParagraphs.push({ text: effectiveText, isContinued: item.isContinued, isSceneBreak: item.isSceneBreak });
                        } else {
                            measureBox.removeChild(p); 
                            const availableHeight = limitHeight - measureBox.scrollHeight;

                            if (availableHeight < 18) {
                                queue.unshift(item);
                            } else {
                                const splitIdx = findSplitIndex(effectiveText, availableHeight, item.isContinued);
                                if (splitIdx > 0) {
                                    currentParagraphs.push({ text: effectiveText.substring(0, splitIdx), isContinued: item.isContinued, isSceneBreak: item.isSceneBreak });
                                    if (effectiveText.substring(splitIdx).length > 0) {
                                        queue.unshift({ text: effectiveText.substring(splitIdx), isContinued: true, isSceneBreak: item.isSceneBreak });
                                    }
                                } else {
                                    queue.unshift(item);
                                }
                            }
                            resultPages.push({ paragraphs: currentParagraphs });
                            currentParagraphs = [];
                            pageNum++;
                            measureBox.innerHTML = '';
                        }
                    }

                    if (currentParagraphs.length > 0) resultPages.push({ paragraphs: currentParagraphs });

                    setPages(resultPages);
                    setCurrentPageIdx(0);
                    setPageHighlights({});
                    setStep('preview');
                    // ê¸°ë³¸ì ìœ¼ë¡œ ìŠ¤íƒ€ì¼ íƒ­ ì—´ê¸°
                    setActiveTab('style');
                    setIsGenerating(false);
                    setTimeout(() => window.scrollTo(0, 0), 100);
                }, 400); 
            };

            // -- Logic: Robust Highlighting --
            
            const saveCurrentPageState = useCallback(() => {
                if (contentRef.current && viewerRef.current) {
                     setPageHighlights(prev => ({
                         ...prev,
                         [currentPageIdx]: viewerRef.current.innerHTML
                     }));
                }
            }, [currentPageIdx]);

            const removeHighlightGroup = useCallback((groupId) => {
                if (!contentRef.current) return;
                const spans = contentRef.current.querySelectorAll(`span[data-group-id="${groupId}"]`);
                spans.forEach(span => {
                    const parent = span.parentNode;
                    while (span.firstChild) {
                        parent.insertBefore(span.firstChild, span);
                    }
                    parent.removeChild(span);
                    parent.normalize();
                });
                saveCurrentPageState();
            }, [saveCurrentPageState]);

            const handlePageClick = useCallback((e) => {
                if (activeTab !== 'highlight') return; // í˜•ê´‘íœ ëª¨ë“œì¼ ë•Œë§Œ ì‘ë™
                
                const target = e.target;
                if (target.classList.contains('highlight')) {
                    e.stopPropagation();
                    const groupId = target.dataset.groupId;
                    
                    if (groupId) {
                        removeHighlightGroup(groupId);
                    } else {
                        const text = target.textContent || '';
                        const textNode = document.createTextNode(text);
                        target.parentNode.replaceChild(textNode, target);
                        saveCurrentPageState();
                    }
                }
            }, [activeTab, removeHighlightGroup, saveCurrentPageState]);

            const handleHighlightSelection = useCallback(() => {
                if (activeTab !== 'highlight') return; // í˜•ê´‘íœ ëª¨ë“œì¼ ë•Œë§Œ ì‘ë™

                const selection = window.getSelection();
                if (!selection || selection.rangeCount === 0 || selection.isCollapsed) return;

                const range = selection.getRangeAt(0);
                const container = contentRef.current;
                
                if (!container || !container.contains(range.commonAncestorContainer)) return;

                const groupId = `hl-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const textNodes = [];
                
                if (range.commonAncestorContainer.nodeType === Node.TEXT_NODE) {
                    textNodes.push(range.commonAncestorContainer);
                } else {
                    const walker = document.createTreeWalker(
                        range.commonAncestorContainer,
                        NodeFilter.SHOW_TEXT,
                        {
                            acceptNode: (node) => {
                                if (!container.contains(node)) return NodeFilter.FILTER_REJECT;
                                const nodeRange = document.createRange();
                                nodeRange.selectNodeContents(node);
                                if (range.intersectsNode(node) && node.nodeValue.trim().length > 0) {
                                    return NodeFilter.FILTER_ACCEPT;
                                }
                                return NodeFilter.FILTER_SKIP;
                            }
                        }
                    );
                    let currentNode;
                    while (currentNode = walker.nextNode()) {
                        textNodes.push(currentNode);
                    }
                }

                let modified = false;
                textNodes.forEach(node => {
                    const nodeRange = document.createRange();
                    let start = 0;
                    let end = node.nodeValue.length;

                    if (node === range.startContainer) start = range.startOffset;
                    if (node === range.endContainer) end = range.endOffset;

                    if (start < end) {
                        try {
                            nodeRange.setStart(node, start);
                            nodeRange.setEnd(node, end);
                            
                            const span = document.createElement('span');
                            span.className = `highlight ${currentHighlightColor}`;
                            span.dataset.groupId = groupId;

                            nodeRange.surroundContents(span);
                            modified = true;
                        } catch (e) {
                            console.warn("Highlight skip", e);
                        }
                    }
                });

                if (modified) {
                    selection.removeAllRanges();
                    saveCurrentPageState();
                }
            }, [activeTab, currentHighlightColor, saveCurrentPageState]);

            // -- Logic: Navigation & Gestures --
            const goPrev = useCallback(() => {
                if (currentPageIdx > 0) {
                    saveCurrentPageState();
                    setCurrentPageIdx(p => p - 1);
                }
            }, [currentPageIdx, saveCurrentPageState]);
            
            const goNext = useCallback(() => {
                if (currentPageIdx < pages.length - 1) {
                    saveCurrentPageState();
                    setCurrentPageIdx(p => p + 1);
                }
            }, [currentPageIdx, pages.length, saveCurrentPageState]);
            
            // Keyboard Navigation
            useEffect(() => {
                if (step !== 'preview') return;
                const handleKeyDown = (e) => {
                    // í˜•ê´‘íœ ëª¨ë“œë©´ í…ìŠ¤íŠ¸ ì„ íƒì„ ìœ„í•´ í™”ì‚´í‘œ ì´ë™ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë§‰ì§€ ì•ŠìŒ
                    // ë‹¨, Selectionì´ ì—†ëŠ” ê²½ìš°ì—ë§Œ í˜ì´ì§€ ì´ë™
                    const sel = window.getSelection();
                    if (activeTab === 'highlight' && sel && !sel.isCollapsed) return;

                    if (e.key === 'ArrowLeft') goPrev();
                    else if (e.key === 'ArrowRight') goNext();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [step, activeTab, goPrev, goNext]);

            // Swipe Navigation
            const handleTouchStart = (e) => {
                if (activeTab === 'highlight') return; // í˜•ê´‘íœ ëª¨ë“œ ì‹œ ìŠ¤ì™€ì´í”„ ë°©ì§€
                touchStartRef.current = e.changedTouches[0].clientX;
            };

            const handleTouchEnd = (e) => {
                if (activeTab === 'highlight') return;
                if (!touchStartRef.current) return;
                
                const touchEnd = e.changedTouches[0].clientX;
                const diff = touchStartRef.current - touchEnd;

                if (Math.abs(diff) > 50) { // 50px ì´ìƒ ìŠ¤ì™€ì´í”„
                    if (diff > 0) goNext();
                    else goPrev();
                }
                touchStartRef.current = null;
            };

            const backToEdit = () => {
                if (window.confirm('í˜•ê´‘íœì´ ëª¨ë‘ ì§€ì›Œì§‘ë‹ˆë‹¤. ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    setStep('input');
                    setPages([]);
                    setPageHighlights({});
                    setCurrentPageIdx(0);
                    window.scrollTo(0, 0);
                }
            };

            const resetApp = () => {
                if (window.confirm('ì‘ì—… ë‚´ìš©ì„ ì§€ìš°ê³  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    setStep('input');
                    setPages([]);
                    setPageHighlights({});
                    setTextInput('');
                    setMetadata({ title: '', author: '', producer: '' });
                    window.scrollTo(0, 0);
                }
            };

            // -- Logic: Download --
            const downloadBlobFallback = (blob, fileName) => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = fileName;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            };

            const downloadCurrentPage = async () => {
                const target = document.getElementById('captureTarget');
                if (!target) return;

                const title = metadata.title || 'novel';
                const fileName = `${title}_${currentPageIdx + 1}p.png`;

                setLoadingMessage('ìƒì„± ì¤‘...');
                
                try {
                    // í°íŠ¸ ì¤€ë¹„: í˜„ì¬ í°íŠ¸ë§Œ ë¡œë“œ
                    const fontEmbedCSS = await getFontEmbedCSS(activeFont);
                    
                    // iPad ë“± ê³ í•´ìƒë„/ë ˆì´ì•„ì›ƒ ì•ˆì •í™” ëŒ€ê¸°
                    if (isMobile) await new Promise(resolve => setTimeout(resolve, 300));
                    await new Promise(resolve => setTimeout(resolve, 200));

                    const options = {
                        quality: 1.0,
                        pixelRatio: 2,
                        cacheBust: false,
                        backgroundColor: THEMES[activeTheme].bg,
                        preferredFontFormat: 'woff2',
                        skipFonts: true, 
                        width: 420,
                        height: 600,
                        style: {
                            fontFamily: FONTS[activeFont].family,
                            margin: '0',
                            transform: 'none',
                            left: 'auto', right: 'auto', top: 'auto', bottom: 'auto'
                        }
                    };
                    if (fontEmbedCSS) options.fontEmbedCSS = fontEmbedCSS;

                    const blob = await htmlToImage.toBlob(target, options);
                    if (!blob) throw new Error('Blob creation failed');

                    // iOSì¸ ê²½ìš°ì—ë§Œ ê³µìœ  ê¸°ëŠ¥ ì‚¬ìš©
                    if (isIOS && navigator.share && navigator.canShare) {
                        const file = new File([blob], fileName, { type: 'image/png' });
                        if (navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({ files: [file], title: fileName });
                            } catch (shareError) {
                                if (shareError.name !== 'AbortError') {
                                    downloadBlobFallback(blob, fileName);
                                }
                            }
                        } else {
                            downloadBlobFallback(blob, fileName);
                        }
                    } else {
                        // ì•ˆë“œë¡œì´ë“œ, PCëŠ” ë°”ë¡œ ë‹¤ìš´ë¡œë“œ
                        downloadBlobFallback(blob, fileName);
                    }

                } catch (error) {
                    console.error('[ë‹¤ìš´ë¡œë“œ] ì‹¤íŒ¨:', error);
                    alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    setLoadingMessage('');
                }
            };
            
            const downloadAllPages = async () => {
                // PC ì „ìš© ê¸°ëŠ¥
                if (isMobile) {
                    alert('ëª¨ë°”ì¼ í™˜ê²½ì—ì„œëŠ” ì „ì²´ ì €ì¥ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                if (!window.confirm(`ì´ ${pages.length}ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.`)) return;

                saveCurrentPageState();
                const originalPageIdx = currentPageIdx;
                // 1í˜ì´ì§€ë¶€í„° ì‹œì‘
                setCurrentPageIdx(0);
                setLoadingMessage('ì¤€ë¹„ ì¤‘...');
                
                try {
                    // í°íŠ¸ ì¤€ë¹„
                    const fontEmbedCSS = await getFontEmbedCSS(activeFont);

                    // ìˆœì°¨ì ìœ¼ë¡œ í˜ì´ì§€ ì´ë™í•˜ë©° ìº¡ì²˜
                    for (let i = 0; i < pages.length; i++) {
                        setCurrentPageIdx(i);
                        // ë Œë”ë§ ëŒ€ê¸° (ë§¤ìš° ì¤‘ìš”)
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        setLoadingMessage(`ì €ì¥ ì¤‘... (${i + 1}/${pages.length})`);
                        setLoadingProgress(Math.floor(((i + 1) / pages.length) * 100));

                        const target = document.getElementById('captureTarget');
                        if (target) {
                            const options = {
                                quality: 1.0,
                                pixelRatio: 2,
                                cacheBust: false,
                                backgroundColor: THEMES[activeTheme].bg,
                                skipFonts: true,
                                width: 420,
                                height: 600,
                                style: {
                                    fontFamily: FONTS[activeFont].family,
                                    margin: '0',
                                    transform: 'none',
                                    left: 'auto', right: 'auto'
                                }
                            };
                            if (fontEmbedCSS) options.fontEmbedCSS = fontEmbedCSS;

                            const blob = await htmlToImage.toBlob(target, options);
                            if (blob) {
                                 const fileName = `${metadata.title || 'novel'}_${String(i+1).padStart(3, '0')}p.png`;
                                 downloadBlobFallback(blob, fileName);
                            }
                            // ë¸Œë¼ìš°ì € ìˆ¨ê³ ë¥´ê¸°
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    }
                    alert("ì „ì²´ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) {
                    console.error(e);
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                } finally {
                    setLoadingMessage('');
                    setLoadingProgress(0);
                    setCurrentPageIdx(originalPageIdx); // ì›ë˜ í˜ì´ì§€ë¡œ ë³µê·€
                }
            };

            // -- Render --
            return (
                <div className={`min-h-screen font-serif ${isMobile ? 'bg-gray-100' : 'bg-[#f0f2f5]'}`}>
                    {/* Hidden Measure Box */}
                    <div ref={measureContainerRef} className="hidden-measure"></div>

                    {/* Loading Overlay */}
                    {loadingMessage && (
                        <div className="fixed inset-0 bg-black/70 text-white flex flex-col items-center justify-center z-[9999]">
                            <div className="text-xl mb-3 font-light">{loadingMessage.includes('ì €ì¥ ì¤‘') ? 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...' : loadingMessage}</div>
                            {loadingProgress > 0 && (
                                <div className="text-sm opacity-80 font-mono">{loadingProgress}%</div>
                            )}
                        </div>
                    )}

                    {/* STEP 1: INPUT */}
                    {step === 'input' && (
                        <div className="max-w-[900px] mx-auto my-10 px-4 sm:px-0">
                            <div className="bg-white p-6 sm:p-10 rounded-2xl shadow-sm">
                                <div className="flex items-center justify-between mb-6 border-b pb-4">
                                    <div className="flex items-center gap-3">
                                        <h1 className="text-2xl font-serif font-medium text-slate-800">ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸°</h1>
                                        <span className="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded font-bold">A6 ë¬¸ê³ íŒ</span>
                                    </div>
                                    <a href="https://yuliyulidaz.github.io/yulilog/" target="_blank" rel="noreferrer" className="flex items-center gap-1.5 text-slate-400 hover:text-indigo-600 transition-colors py-1 px-2 rounded hover:bg-indigo-50">
                                        <span className="text-lg">ğŸ”—</span>
                                        <span className="text-xs font-medium hidden sm:inline">ë°œì·Œ ë¬¸êµ¬ ìƒì„±ê¸°</span>
                                    </a>
                                </div>

                                <div className="mb-6">
                                    <label className="block text-sm text-slate-500 mb-1">ì œëª© (í•„ìš”ì‹œ ì…ë ¥)</label>
                                    <input 
                                        type="text" 
                                        value={metadata.title}
                                        onChange={(e) => setMetadata({...metadata, title: e.target.value})}
                                        className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all" 
                                        placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" 
                                    />
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label className="block text-sm text-slate-500 mb-1">ìºë¦­í„°</label>
                                        <input 
                                            type="text" 
                                            value={metadata.author}
                                            onChange={(e) => setMetadata({...metadata, author: e.target.value})}
                                            className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all" 
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm text-slate-500 mb-1">ì œì‘ì</label>
                                        <input 
                                            type="text" 
                                            value={metadata.producer}
                                            onChange={(e) => setMetadata({...metadata, producer: e.target.value})}
                                            className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all" 
                                        />
                                    </div>
                                </div>

                                <div className="mb-6 relative">
                                    <div className="flex justify-between items-end mb-1">
                                        <label className="block text-sm text-slate-500">ë³¸ë¬¸ ë‚´ìš©</label>
                                        {isEstimating ? (
                                            <span className="text-xs text-indigo-500 animate-pulse">ê³„ì‚° ì¤‘...</span>
                                        ) : (
                                            estimatedPages > 0 && (
                                                <span className="text-xs text-slate-500">ì˜ˆìƒ ë¶„ëŸ‰: ì•½ <strong className="text-indigo-600">{estimatedPages}</strong> í˜ì´ì§€</span>
                                            )
                                        )}
                                    </div>
                                    <div className="relative">
                                        <textarea 
                                            value={textInput}
                                            onChange={(e) => setTextInput(e.target.value)}
                                            className="w-full h-[400px] p-5 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all resize-none font-serif leading-loose relative z-10 bg-transparent" 
                                        ></textarea>
                                        <div className={`placeholder-overlay p-5 ${textInput ? 'placeholder-hidden' : ''}`}>
                                            <p className="mb-4 text-slate-400">ì—¬ê¸°ì— ì†Œì„¤ ë³¸ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.<br/>ì—”í„°ë¡œ ì¤„ë°”ê¿ˆì„ í•˜ë©´ ë¹ˆ ì¤„ì´ ì ìš©ë©ë‹ˆë‹¤.<br/>*** ë¥¼ ì…ë ¥í•˜ë©´ ì¥ë©´ ì „í™˜(ì¤‘ì•™ ì •ë ¬)ì´ ì ìš©ë©ë‹ˆë‹¤.</p>
                                            <div className="mt-6 border-t border-slate-100 pt-4">
                                                <strong className="block mb-2 text-indigo-400 text-xs">ğŸ“¢ ì—…ë°ì´íŠ¸ ì•ˆë‚´ (v1.1.0)</strong>
                                                <ul className="list-disc pl-4 space-y-1 text-[11px] text-slate-400">
                                                    <li><strong>í…Œë§ˆ & í°íŠ¸:</strong> 4ê°€ì§€ ë°°ê²½ í…Œë§ˆì™€ 4ì¢…ì˜ í°íŠ¸(ë‚˜ëˆ”ëª…ì¡°, í•¨ë › ë“±) ì§€ì›</li>
                                                    <li><strong>í˜•ê´‘íœ ê¸°ëŠ¥:</strong> ì—¬ëŸ¬ ë¬¸ë‹¨ ë™ì‹œ ì„ íƒ ë° ì¼ê´„ ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€</li>
                                                    <li><strong>í¸ì˜ì„±:</strong> ì˜ˆìƒ í˜ì´ì§€ ìˆ˜ ìë™ ê³„ì‚°, ìŠ¤ì™€ì´í”„/ë°©í–¥í‚¤ ì´ë™ ì§€ì›</li> 
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button onClick={startGeneration} disabled={isGenerating} className="btn w-full py-4 bg-slate-800 text-white rounded-lg font-medium hover:bg-slate-700 shadow-lg flex justify-center items-center gap-2 disabled:opacity-70">
                                    <span>{isGenerating ? 'ìƒì„± ì¤‘...' : 'A6 ë ˆì´ì•„ì›ƒ ìƒì„±í•˜ê¸°'}</span>
                                </button>
                            </div>

                            {/* Footer (Input Step Only) */}
                            <footer className="max-w-4xl mx-auto px-6 py-10 text-slate-500 text-xs text-center leading-relaxed mt-6 border-t border-slate-200">
                                <p className="font-bold mb-2 text-sm text-slate-700">ğŸ“– ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸° v1.1.0</p>
                                <p className="mb-6">ë³¸ ì‚¬ì´íŠ¸ëŠ” ì–´ë– í•œ ê°œì¸ì •ë³´ë„ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br/>ëª¨ë“  ì‘ì—…ì€ ê·€í•˜ì˜ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</p>
                                
                                <div className="bg-slate-50 rounded-xl p-6 text-left inline-block w-full max-w-2xl border border-slate-100">
                                    <p className="font-bold mb-3 text-slate-700 flex items-center gap-2">
                                        <span className="text-base">âš ï¸</span> ì´ìš© ì‹œ ì£¼ì˜ì‚¬í•­
                                    </p>
                                    <ul className="list-disc pl-4 space-y-2 mb-5 text-slate-600">
                                        <li><strong className="text-slate-700">í…ìŠ¤íŠ¸ ì¸ìš©:</strong> ì±…ì´ë‚˜ ê¸°íƒ€ ì €ì‘ë¬¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ë°œì·Œí•  ê²½ìš°, ì €ì‘ê¶Œë²•ìƒ í—ˆìš© ë²”ìœ„ ë‚´ì—ì„œ ì‚¬ìš©í•˜ê³  ì¶œì²˜ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.</li>
                                        <li><strong className="text-slate-700">ìƒì—…ì  ì´ìš©:</strong> ìƒì„±ëœ ì´ë¯¸ì§€ëŠ” ìƒì—…ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
                                    </ul>
                                    <p className="text-slate-400 text-[11px] pt-4 border-t border-slate-200">
                                        ë³¸ ë„êµ¬ì˜ ì œì‘ìëŠ” ì‚¬ìš©ìê°€ ìƒì„±í•œ ì½˜í…ì¸ ì— ëŒ€í•´ ì–´ë– í•œ ì±…ì„ë„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.<br/>
                                        ì´ë¯¸ì§€ ë° í…ìŠ¤íŠ¸ ì‚¬ìš©ìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ëª¨ë“  ë²•ì  ë¬¸ì œëŠ” ì‚¬ìš©ì ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤.
                                    </p>
                                </div>
                            </footer>
                        </div>
                    )}

                    {/* STEP 2: PREVIEW */}
                    {step === 'preview' && (
                        <div className="pb-20 flex flex-col items-center">
                            
                            {/* 1. Sticky Header Toolbar */}
                            <div className="sticky top-0 z-50 w-full bg-white/95 backdrop-blur-sm border-b shadow-sm">
                                <div className="max-w-[500px] mx-auto">
                                    {/* Row 1: Main Controls */}
                                    <div className="flex items-center justify-between px-4 h-14">
                                        {/* Left: Actions */}
                                        <div className="flex items-center gap-3 mr-2">
                                            <button onClick={resetApp} className="flex items-center gap-1 text-xs text-slate-500 hover:text-slate-800 transition-colors" title="ì²˜ìŒìœ¼ë¡œ">
                                                <span className="text-sm">â†º</span>
                                                <span className="hidden xs:inline">ì´ˆê¸°í™”</span>
                                                <span className="inline xs:hidden text-[10px]">ì´ˆê¸°í™”</span>
                                            </button>
                                            <button onClick={backToEdit} className="flex items-center gap-1 text-xs text-slate-500 hover:text-slate-800 transition-colors" title="ë³¸ë¬¸ ìˆ˜ì •">
                                                <span className="text-sm">âœ</span>
                                                <span className="hidden xs:inline">ìˆ˜ì •</span>
                                                <span className="inline xs:hidden text-[10px]">ìˆ˜ì •</span>
                                            </button>
                                        </div>

                                        {/* Center: Pagination */}
                                        <div className="flex items-center gap-2">
                                            <button onClick={goPrev} disabled={currentPageIdx === 0} className="w-8 h-8 rounded-full border flex items-center justify-center hover:bg-slate-50 disabled:opacity-30 text-slate-500">â€¹</button>
                                            <span className="font-serif tabular-nums text-sm text-slate-700 w-10 text-center select-none">{currentPageIdx + 1} / {pages.length}</span>
                                            <button onClick={goNext} disabled={currentPageIdx === pages.length - 1} className="w-8 h-8 rounded-full border flex items-center justify-center hover:bg-slate-50 disabled:opacity-30 text-slate-500">â€º</button>
                                        </div>

                                        {/* Right: Save */}
                                        <div className="flex items-center gap-2 ml-2">
                                            {!isMobile && (
                                                <button onClick={downloadAllPages} className="bg-white border border-slate-200 text-slate-600 px-2 py-1.5 rounded text-xs hover:bg-slate-50 shadow-sm btn font-medium whitespace-nowrap">
                                                    ì „ì²´ ì €ì¥
                                                </button>
                                            )}
                                            <button onClick={downloadCurrentPage} className="bg-slate-800 text-white px-3 py-1.5 rounded text-xs hover:bg-slate-700 shadow-md btn font-medium flex items-center gap-1 whitespace-nowrap">
                                                {isIOS ? <span className="text-sm">ğŸ“¤</span> : <span className="text-sm">ğŸ“¥</span>}
                                                <span className="hidden sm:inline">{isIOS ? 'ê³µìœ ' : 'ì €ì¥'}</span>
                                                <span className="inline sm:hidden">{isIOS ? 'ê³µìœ ' : 'ì €ì¥'}</span>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Row 2: Mutex Tabs */}
                                    <div className="grid grid-cols-2 border-t border-slate-100">
                                        <button 
                                            onClick={() => setActiveTab(activeTab === 'style' ? null : 'style')}
                                            className={`py-3 text-xs font-medium transition-colors flex items-center justify-center gap-2 ${activeTab === 'style' ? 'text-indigo-600 bg-indigo-50 border-b-2 border-indigo-600' : 'text-slate-500 hover:bg-slate-50'}`}
                                        >
                                            <span>ğŸ¨ ìŠ¤íƒ€ì¼ ì„¤ì •</span>
                                        </button>
                                        <button 
                                            onClick={() => setActiveTab(activeTab === 'highlight' ? null : 'highlight')}
                                            className={`py-3 text-xs font-medium transition-colors flex items-center justify-center gap-2 ${activeTab === 'highlight' ? 'text-indigo-600 bg-indigo-50 border-b-2 border-indigo-600' : 'text-slate-500 hover:bg-slate-50'}`}
                                        >
                                            <span>ğŸ– í˜•ê´‘íœ ë„êµ¬</span>
                                        </button>
                                    </div>

                                    {/* Row 3: Panels */}
                                    {activeTab === 'style' && (
                                        <div className="bg-slate-50 border-b p-4 animate-fadeIn">
                                            <div className="flex flex-col gap-4">
                                                <div className="flex items-center justify-center gap-4">
                                                    <span className="text-[10px] tracking-widest text-slate-400 font-bold uppercase">Theme</span>
                                                    <div className="flex gap-2">
                                                        {Object.keys(THEMES).map(key => (
                                                            <button 
                                                                key={key}
                                                                onClick={() => setActiveTheme(key)}
                                                                className={`w-8 h-8 rounded-full border shadow-sm transition-all ${activeTheme === key ? 'ring-2 ring-offset-2 ring-slate-400 scale-110' : 'hover:scale-105'}`}
                                                                style={{ background: THEMES[key].bg }}
                                                                title={THEMES[key].name}
                                                            ></button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-center gap-4">
                                                    <span className="text-[10px] tracking-widest text-slate-400 font-bold uppercase">Font</span>
                                                    <div className="flex gap-1 bg-white rounded p-1 border shadow-sm">
                                                        {Object.keys(FONTS).map(key => (
                                                            <button 
                                                                key={key}
                                                                onClick={() => setActiveFont(key)}
                                                                className={`px-3 py-1.5 rounded text-xs transition-colors ${activeFont === key ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}
                                                            >
                                                                {FONTS[key].name}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'highlight' && (
                                        <div className="bg-slate-50 border-b p-4 animate-fadeIn text-center">
                                            <div className="inline-flex items-center gap-4 bg-white px-4 py-2 rounded-full shadow-sm border">
                                                {['highlight-yellow', 'highlight-pink', 'highlight-mint', 'highlight-blue'].map(color => (
                                                    <div 
                                                        key={color} 
                                                        onClick={() => setCurrentHighlightColor(color)}
                                                        className={`color-btn w-6 h-6 rounded-full ${color} ${currentHighlightColor === color ? 'active border-slate-400' : 'border-transparent'}`}
                                                    ></div>
                                                ))}
                                            </div>
                                            <p className="mt-2 text-[10px] text-slate-400">ë“œë˜ê·¸ë¡œ ì¹ í•˜ê³ , í„°ì¹˜í•˜ì—¬ ì§€ì›ë‹ˆë‹¤.</p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Viewer Area */}
                            <div 
                                id="bookViewerWrapper" 
                                className="flex justify-center overflow-visible px-4 py-8 select-text touch-manipulation w-full"
                                onTouchStart={handleTouchStart}
                                onTouchEnd={handleTouchEnd}
                            >
                                <div 
                                    ref={viewerRef}
                                    id="captureTarget" 
                                    className={`page-container ${THEMES[activeTheme].isDark ? 'page-shadow' : 'page-shadow'} ${THEMES[activeTheme].pattern ? 'bg-pattern-noise' : ''}`}
                                    style={{ 
                                        backgroundColor: THEMES[activeTheme].bg,
                                        color: THEMES[activeTheme].text
                                    }}
                                >
                                    {/* Render Content */}
                                    {pageHighlights[currentPageIdx] ? (
                                        <div 
                                            ref={contentRef}
                                            onClick={handlePageClick}
                                            onMouseUp={handleHighlightSelection}
                                            onTouchEnd={handleHighlightSelection}
                                            dangerouslySetInnerHTML={{ __html: pageHighlights[currentPageIdx] }}
                                            style={{display: 'contents', fontFamily: FONTS[activeFont].family}}
                                        />
                                    ) : (
                                        <>
                                            <div 
                                                ref={contentRef} 
                                                className="page-content" 
                                                onClick={handlePageClick}
                                                onMouseUp={handleHighlightSelection}
                                                onTouchEnd={handleHighlightSelection}
                                                style={{fontFamily: FONTS[activeFont].family}}
                                            >
                                                {currentPageIdx === 0 && metadata.title && (
                                                    <div style={{height: '200px', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', marginBottom: 0}}>
                                                        <h1 className="text-base tracking-[0.1em] font-normal text-center px-4" 
                                                            style={{
                                                                lineHeight: 1.8, 
                                                                maxHeight: '70px', 
                                                                overflow: 'hidden',
                                                                color: THEMES[activeTheme].text
                                                            }}
                                                        >
                                                            {metadata.title}
                                                        </h1>
                                                        <div className="w-8 h-[1px] opacity-50 mx-auto mt-14" style={{backgroundColor: THEMES[activeTheme].metaColor}}></div>
                                                    </div>
                                                )}

                                                {pages[currentPageIdx]?.paragraphs.map((p, i) => (
                                                    <p key={i} 
                                                        className={p.isContinued ? 'continued' : ''} 
                                                        style={{
                                                            textAlign: p.isSceneBreak ? 'center' : undefined,
                                                            textIndent: p.isSceneBreak ? '0' : undefined
                                                        }}
                                                    >
                                                        {p.text}
                                                    </p>
                                                ))}
                                            </div>

                                            <div className="page-footer-area text-[9px]" style={{color: THEMES[activeTheme].metaColor}}>
                                                <div className={`flex items-center gap-2 w-full ${(currentPageIdx + 1) % 2 !== 0 ? 'justify-end' : 'justify-start flex-row-reverse'}`}>
                                                    {(metadata.producer || metadata.author) && (
                                                        <span>{[metadata.producer, metadata.author].filter(Boolean).join(' Â· ')}</span>
                                                    )}
                                                    <span className="font-normal" style={{color: THEMES[activeTheme].text}}>{currentPageIdx + 1}</span>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

