
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>Ìïú Ïû•Ïùò ÏÜåÏÑ§</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- 1. Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Noto Serif KR (Î≥∏Î¨∏ Î™ÖÏ°∞) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400;500&display=swap" rel="stylesheet">
    <!-- Gowun Batang (Í≥†Ïö¥ Î∞îÌÉï) -->
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">
    <!-- Nanum Myeongjo (ÎÇòÎàî Î™ÖÏ°∞) -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- Hahmlet (Ìï®Î†õ) -->
    <link href="https://fonts.googleapis.com/css2?family=Hahmlet:wght@100;200;300;400;500;600&display=swap" rel="stylesheet">
    <!-- Noto Sans KR (ÏÜçÏßÄÏö© Í≥†Îîï) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400&display=swap" rel="stylesheet">
    
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 3. Libraries (React, ReactDOM, Babel, html-to-image) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"></script>

    <style>
        /* Ìè∞Ìä∏ Í∞ïÏ†ú Ï†ÅÏö© */
        * {
            -webkit-font-smoothing: antialiased;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            /* Î∞∞Í≤Ω: Ï∞®Î∂ÑÌïú Í∑∏Î†àÏù¥ + Ï¢ÖÏù¥ ÎÖ∏Ïù¥Ï¶à ÌÖçÏä§Ï≤ò */
            background-color: #f0f0f0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.07'/%3E%3C/svg%3E");
            background-size: 300px 300px;
            color: #1a1a1a;
            overscroll-behavior: none; /* Ïä§ÌÅ¨Î°§ ÌäïÍπÄ Î∞©ÏßÄ */
        }

        /* ÌïòÏù¥ÎùºÏù¥Ìä∏ Ïä§ÌÉÄÏùº - Í∑∏Î£π ID ÏÜçÏÑ± ÌôúÏö© */
        .highlight {
            display: inline;
            background: rgba(255, 235, 59, 0.4);
            padding: 0;
            margin: 0;
            line-height: inherit;
            letter-spacing: inherit;
            vertical-align: baseline;
            border: none;
            outline: none;
            cursor: pointer;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }
        
        .highlight-yellow { background: rgba(255, 235, 59, 0.4); }
        .highlight-pink { background: rgba(255, 182, 193, 0.4); }
        .highlight-mint { background: rgba(178, 255, 222, 0.4); }
        .highlight-blue { background: rgba(173, 216, 230, 0.4); }

        /* Í∏ÄÏûê ÏÉâ Ïä§ÌÉÄÏùº */
        .colored-text {
            display: inline;
            cursor: pointer;
            line-height: inherit;
            letter-spacing: inherit;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }
        .text-crimson { color: #be123c; } 
        .text-navy { color: #1e3a8a; }    
        .text-forest { color: #15803d; }
        .text-purple { color: #6b21a8; }
        .text-brown { color: #78350f; }
        .text-teal { color: #0f766e; }
        .text-gray { color: #9ca3af; }    
        
        /* Í∏ÄÏûê ÏÉâ ÏÑ†ÌÉù Î≤ÑÌäº (Î∞∞Í≤ΩÏÉâ) */
        .bg-text-crimson { background-color: #be123c; }
        .bg-text-navy { background-color: #1e3a8a; }
        .bg-text-forest { background-color: #15803d; }
        .bg-text-purple { background-color: #6b21a8; }
        .bg-text-brown { background-color: #78350f; }
        .bg-text-teal { background-color: #0f766e; }
        .bg-text-gray { background-color: #9ca3af; }

        /* ÌôîÎ©¥Ïö© Ïä§ÌÉÄÏùº - A6 ÎπÑÏú® (105:148) */
        .page-container {
            /* ÍπäÏù¥Í∞ê ÏûàÎäî Í∑∏Î¶ºÏûê */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            background: white;
            margin: 0 auto;
            width: 420px;  
            min-width: 420px; 
            flex-shrink: 0;
            height: 600px; 
            padding: 60px 60px 50px 60px; 
            position: relative;
            display: flex;
            flex-direction: column;
            transform-origin: top center;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* ÌÖåÎßàÎ≥Ñ Ïä§ÌÉÄÏùº */
        .theme-white.page-container { background: #ffffff; color: #1a1a1a; }
        .theme-cream.page-container { background: #fdfbf7; color: #2c241b; }
        .theme-kraft.page-container { 
            background: #e6dac3; 
            color: #3e2723; 
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: cover;
        }
        .theme-dark.page-container { background: #1a1a1a; color: #e5e5e5; }

        .page-content {
            height: 460px; 
            overflow: hidden;
            font-size: 12px;
            line-height: 1.8 !important;
            text-align: justify;
            letter-spacing: -0.02em;
            word-break: normal; /* Îã®Ïñ¥ Îã®ÏúÑ Ï§ÑÎ∞îÍøà (ÌïúÍ∏ÄÏùÄ Í∏ÄÏûê Îã®ÏúÑ Ïú†ÏßÄ) */
            overflow-wrap: anywhere;
            font-weight: 300;
            cursor: text;
        }
        
        /* ÌïòÏù¥ÎùºÏù¥Ìä∏ ÏÉÅÌÉúÏóêÏÑúÎèÑ Ïä§ÌÉÄÏùº Ïú†ÏßÄ */
        .page-content p {
            margin-bottom: 0;
            padding: 0;
            text-indent: 1em;
            line-height: 1.8 !important;
        }

        .page-content p.continued {
            text-indent: 0 !important;
        }
        
        .page-footer-area {
            height: 30px;
            margin-top: auto;
            display: flex;
            align-items: flex-end;
            padding-bottom: 0px;
        }

        .hidden-measure {
            position: absolute;
            visibility: hidden;
            top: -9999px;
            left: -9999px;
            width: 300px;
            font-size: 12px;
            line-height: 1.8 !important;
            text-align: justify;
            letter-spacing: -0.02em;
            word-break: normal; /* Îã®Ïñ¥ Îã®ÏúÑ Ï§ÑÎ∞îÍøà */
            overflow-wrap: anywhere;
            font-weight: 300;
        }
        
        .hidden-measure p {
            margin-bottom: 0;
            line-height: 1.8 !important;
        }

        .circle-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .circle-btn:hover { transform: scale(1.1); }
        .circle-btn.active { border-color: #333; transform: scale(1.1); }
        
        .theme-btn-white { background: #ffffff; border: 1px solid #ddd; }
        .theme-btn-cream { background: #fdfbf7; border: 1px solid #e6e0d4; }
        .theme-btn-kraft { background: #e6dac3; border: 1px solid #cbbba0; }
        .theme-btn-dark { background: #1a1a1a; border: 1px solid #444; }

        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        
        .custom-placeholder {
            position: absolute;
            top: 24px; left: 24px; right: 24px; bottom: 24px;
            pointer-events: none;
            color: #94a3b8;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        @media (max-width: 450px) {
            #bookViewerWrapper {
                transform: scale(0.82); /* ÏÇ¨Ïù¥Ï¶à Ï∂ïÏÜå 0.85 -> 0.82 */
                transform-origin: top center;
            }
        }

        /* ----------------------------------------------------------------- */
        /* MOCKUP STYLES */
        /* ----------------------------------------------------------------- */
        .mockup-book-wrapper {
            position: relative;
            width: 840px; 
            height: 600px;
            display: flex;
            transition: transform 0.3s ease;
        }

        .mockup-page {
            width: 420px;
            height: 600px;
            position: relative;
            z-index: 10;
            overflow: hidden;
            transform: translateZ(0); 
            -webkit-mask-image: -webkit-radial-gradient(white, black);
            isolation: isolate; 
        }

        .effect-gutter-left {
            position: absolute; top: 0; bottom: 0; right: 0; width: 80px;
            background: linear-gradient(to right, 
                transparent 0%, 
                rgba(0,0,0,0.01) 30%, 
                rgba(0,0,0,0.03) 60%, 
                rgba(0,0,0,0.08) 85%, 
                rgba(0,0,0,0.15) 100%
            );
            pointer-events: none; z-index: 20; mix-blend-mode: multiply;
        }
        .effect-gutter-right {
            position: absolute; top: 0; bottom: 0; left: 0; width: 80px;
            background: linear-gradient(to left, 
                transparent 0%, 
                rgba(0,0,0,0.01) 30%, 
                rgba(0,0,0,0.03) 60%, 
                rgba(0,0,0,0.08) 85%, 
                rgba(0,0,0,0.15) 100%
            );
            pointer-events: none; z-index: 20; mix-blend-mode: multiply;
        }

        .flyleaf {
            width: 100%; height: 100%;
            background-color: #1a2233;
            padding: 60px;
            display: flex; flex-direction: column;
            justify-content: flex-end;
            position: relative;
            cursor: pointer;
        }
        .flyleaf.front { align-items: flex-start; text-align: left; }
        .flyleaf.back { align-items: flex-end; text-align: right; }

        .flyleaf textarea {
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: 300;
        }

        @keyframes blink {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .flyleaf-hint {
            position: absolute; top: 24px; 
            color: rgba(255,255,255,0.6); font-size: 11px;
            pointer-events: none; white-space: nowrap;
            border: 1px dashed rgba(255,255,255,0.3);
            background-color: rgba(255,255,255,0.05);
            padding: 6px 10px;
            border-radius: 6px;
            animation: blink 2s infinite ease-in-out;
        }
        .flyleaf.front .flyleaf-hint { left: 0; }
        .flyleaf.back .flyleaf-hint { right: 0; }

        .mockup-scaler { transform-origin: center center; }
        @media (max-width: 900px) {
            .mockup-scaler { transform: scale(0.42); }
        }
        
        /* New Glassmorphism & UI Utilities */
        /* iPhone Safe Area Utilities */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }

        /* Transparent Glass Button (Header) */
        .glass-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
        }
        .glass-btn:active {
            transform: scale(0.92);
            background: rgba(255, 255, 255, 0.4);
        }

        /* Transparent Glass Pill (Page Indicator) */
        .glass-pill {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-radius: 9999px;
            color: #334155;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Layer 2 Transition */
        .layer2-container {
            transition: transform 0.3s cubic-bezier(0.33, 1, 0.68, 1), opacity 0.3s ease;
        }
        .layer2-visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        .layer2-hidden {
            transform: translateY(100%); /* Completely slide down */
            opacity: 0;
            pointer-events: none;
        }
        
        @keyframes bounceSlight {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-slight {
            animation: bounceSlight 1.5s infinite;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Centered Toast Overlay Strategy - Robust for Mobile */
        .toast-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-box {
            background-color: #1a1a1a;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }

        /* Exit Toast Centering */
        .toast-exit {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(30, 41, 59, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            animation: bounceSlight 1.5s infinite;
        }
    </style>

</head>
<body>
    <div id="root"></div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered');
                        registration.update();
                    })
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>

    <script type="text/babel" data-presets="react,typescript">
        const { useState, useRef, useEffect, useCallback } = React;

        // ----------------------------------------------------------------------
        // 1. Utils & Helpers
        // ----------------------------------------------------------------------
        
        function isMobile() {
            return /Android|webOS|BlackBerry|IEMobile|Opera Mini|iPad|iPhone|iPod/.test(navigator.userAgent);
        }
        
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        // Haptic Feedback Helper
        const haptic = {
            tap: () => {
                if (navigator.vibrate) navigator.vibrate(10);
            },
            success: () => {
                if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
            },
            error: () => {
                if (navigator.vibrate) navigator.vibrate([50, 100, 50]);
            }
        };

        async function ensureFontsLoaded() {
            try { await document.fonts.ready; } catch (e) { console.warn('Ìè∞Ìä∏ API ÌôïÏù∏ Ïã§Ìå®', e); }
        }

        const fontCache = new Map();
        
        const FONT_MAP = {
            'noto': { name: 'Î≥∏Î¨∏ Î™ÖÏ°∞', family: "'Noto Serif KR', serif", url: 'https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400;500&display=swap' },
            'nanum': { name: 'ÎÇòÎàî Î™ÖÏ°∞', family: "'Nanum Myeongjo', serif", url: 'https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap' },
            'hahmlet': { name: 'Ìï®Î†õ', family: "'Hahmlet', serif", url: 'https://fonts.googleapis.com/css2?family=Hahmlet:wght@100;200;300;400;500;600&display=swap' },
            'gowun': { name: 'Í≥†Ïö¥ Î∞îÌÉï', family: "'Gowun Batang', serif", url: 'https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap' }
        };

        async function prepareFontEmbedCSS(activeFontKey) {
            if (fontCache.has(activeFontKey)) return fontCache.get(activeFontKey);
            try {
                const fontInfo = FONT_MAP[activeFontKey];
                if (!fontInfo) return null;
                const cssRes = await fetch(fontInfo.url);
                let cssText = await cssRes.text();
                const urlRegex = /url\(([^)]+)\)/g;
                let match;
                const replacements = [];
                while ((match = urlRegex.exec(cssText)) !== null) {
                    const fullUrl = match[1].replace(/['"]/g, ''); 
                    replacements.push({ original: match[0], url: fullUrl });
                }
                await Promise.all(replacements.map(async (item) => {
                    try {
                        const fontRes = await fetch(item.url);
                        const fontBlob = await fontRes.blob();
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                cssText = cssText.replace(item.url, reader.result);
                                resolve();
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(fontBlob);
                        });
                    } catch (e) {}
                }));
                fontCache.set(activeFontKey, cssText);
                return cssText;
            } catch (e) { return null; }
        }

        function useDebounce(value, delay) {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => { setDebouncedValue(value); }, delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        }

        async function captureNode(node, fileName, width, height, fontEmbedCSS = null) {
            await ensureFontsLoaded();
            
            const options = {
                quality: 1.0, pixelRatio: 3, cacheBust: false,
                width: width, height: height,
                style: { transform: 'none', margin: '0' },
                filter: (node) => {
                    return !node.classList || !node.classList.contains('no-capture');
                }
            };

            if (fontEmbedCSS) {
                options.fontEmbedCSS = fontEmbedCSS;
            }

            if (isMobile()) {
                try { await htmlToImage.toBlob(node, options); } catch(e){}
                await new Promise(r => setTimeout(r, 200));
            }

            const blob = await htmlToImage.toBlob(node, options);
            if (!blob) throw new Error('Blob creation failed');

            if (isIOS() && navigator.share && navigator.canShare) {
                const file = new File([blob], fileName, { type: 'image/png' });
                if (navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: fileName });
                    return;
                }
            }

            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = fileName;
            link.href = url;
            link.style.display = 'none'; // Ensure hidden
            document.body.appendChild(link);
            link.click();
            
            // Critical for Android: Delay removal
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 1000);
        }
        
        async function getBlobFromNode(node, width, height, fontEmbedCSS = null) {
            await ensureFontsLoaded();
            
            const options = {
                quality: 1.0, pixelRatio: 3, cacheBust: false,
                width: width, height: height,
                style: { transform: 'none', margin: '0' },
                filter: (node) => {
                    return !node.classList || !node.classList.contains('no-capture');
                }
            };

            if (fontEmbedCSS) {
                options.fontEmbedCSS = fontEmbedCSS;
            }

            if (isMobile()) {
                // Mobile stabilization
                try { await htmlToImage.toBlob(node, options); } catch(e){}
                await new Promise(r => setTimeout(r, 200));
            }

            return await htmlToImage.toBlob(node, options);
        }

        // ----------------------------------------------------------------------
        // 2. Extracted Components (For Mockup & Preview)
        // ----------------------------------------------------------------------
        
        const PageContent = ({ pageIdx, pages, pageHighlights, metadata, activeFont, onMouseUp, onClick, contentRef }) => {
            const page = pages[pageIdx];
            if (!page) return null;

            if (pageHighlights && pageHighlights[pageIdx]) {
                return (
                    <div 
                        ref={contentRef}
                        className="page-content"
                        onMouseUp={onMouseUp}
                        onClick={onClick}
                        dangerouslySetInnerHTML={{ __html: pageHighlights[pageIdx] }}
                    />
                );
            }

            return (
                <div ref={contentRef} className="page-content" onMouseUp={onMouseUp} onClick={onClick}>
                    {pageIdx === 0 && metadata.title && (
                        <div style={{height: '200px', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', marginBottom: 0}}>
                            <h1 className="text-base tracking-[0.1em] font-normal text-center px-4" style={{lineHeight: 1.8, maxHeight: '70px', overflow: 'hidden', opacity: 0.8}}>
                                {metadata.title}
                            </h1>
                            <div className="w-8 h-[1px] bg-current opacity-30 mx-auto mt-14"></div>
                        </div>
                    )}
                    {page.paragraphs.map((p, i) => (
                        <p key={i} className={p.isContinued ? 'continued' : ''} style={{ lineHeight: 1.8, textAlign: p.isSceneBreak ? 'center' : undefined, textIndent: p.isSceneBreak ? '0' : undefined }}>
                            {p.text}
                        </p>
                    ))}
                </div>
            );
        };

        const PageFooter = ({ pageIdx, isRight, metadata }) => {
            const isOdd = (pageIdx + 1) % 2 !== 0;
            const alignRight = isRight !== undefined ? isRight : isOdd;

            return (
                <div className={`page-footer-area text-[9px] opacity-50 ${alignRight ? 'justify-end' : 'justify-start'}`}>
                    <div className={`flex items-center gap-2 ${alignRight ? 'flex-row' : 'flex-row-reverse'}`}>
                        {(metadata.producer || metadata.author) && (
                            <span>{[metadata.producer, metadata.author].filter(Boolean).join(' ¬∑ ')}</span>
                        )}
                        <span className="font-normal opacity-70">{pageIdx + 1}</span>
                    </div>
                </div>
            );
        };

        const Flyleaf = ({ isFront, isHidden, text, setText, onEdit }) => {
            const hasContent = text && text.trim().length > 0;
            const mobile = isMobile();
            
            if (isHidden && !hasContent) {
                return <div className={`flyleaf ${isFront ? 'front' : 'back'}`}></div>;
            }

            const handleChange = (e) => {
                const val = e.target.value;
                const lines = val.split('\n');
                if (lines.length > 6) {
                    setText(lines.slice(0, 6).join('\n'));
                } else {
                    setText(val);
                }
            };

            return (
                <div 
                    className={`flyleaf ${isFront ? 'front' : 'back'}`} 
                    onClick={!isHidden && mobile ? onEdit : undefined}
                >
                    <div className="w-1/2 relative z-10 flex flex-col" style={{ maxWidth: '50%' }}>
                        <div className={`w-[30px] h-px bg-white/50 mb-4 ${!isFront ? 'ml-auto' : ''}`}></div>
                        {!isHidden && !hasContent && (
                            <div className={`flyleaf-hint ${isFront ? 'text-left' : 'text-right'}`}>
                                ÌÅ¥Î¶≠ÌïòÏó¨ Î¨∏Íµ¨ ÏûÖÎ†•
                            </div>
                        )}
                        {(!isHidden || hasContent) && (
                            <textarea
                                value={text}
                                onChange={!isHidden && !mobile ? handleChange : undefined}
                                readOnly={isHidden || mobile} 
                                className={`w-full bg-transparent border-none text-white/70 text-[10px] p-0 focus:outline-none placeholder:text-transparent resize-none overflow-hidden ${isFront ? 'text-left' : 'text-right'} ${mobile && !isHidden ? 'cursor-pointer' : ''}`}
                                rows={6}
                                spellCheck={false}
                                disabled={isHidden} 
                                style={{ lineHeight: '1.6', maxHeight: '96px', pointerEvents: isHidden ? 'none' : 'auto' }}
                            />
                        )}
                    </div>
                </div>
            );
        };

        const MockupBookRenderer = ({ spreadIdx, spreads, isCaptureMode = false, activeTheme, activeFont, frontFlyleafText, setFrontFlyleafText, backFlyleafText, setBackFlyleafText, pageHighlights, pages, metadata, onEditFlyleaf }) => {
            const spread = spreads[spreadIdx];
            if (!spread) return null;

            const renderSide = (sideData, isRight) => {
                if (!sideData) return <div className="mockup-page bg-transparent"></div>;

                if (sideData.type === 'flyleaf-front') {
                    return (
                        <div className="mockup-page">
                            <Flyleaf 
                                isFront={true} 
                                isHidden={isCaptureMode} 
                                text={frontFlyleafText} 
                                setText={setFrontFlyleafText} 
                                onEdit={() => onEditFlyleaf && onEditFlyleaf('front')}
                            />
                            <div className="effect-gutter-left"></div>
                        </div>
                    );
                }
                if (sideData.type === 'flyleaf-back') {
                    return (
                        <div className="mockup-page">
                            <Flyleaf 
                                isFront={false} 
                                isHidden={isCaptureMode} 
                                text={backFlyleafText} 
                                setText={setBackFlyleafText} 
                                onEdit={() => onEditFlyleaf && onEditFlyleaf('back')}
                            />
                            <div className="effect-gutter-right"></div>
                        </div>
                    );
                }
                if (sideData.type === 'page') {
                    return (
                        <div className={`mockup-page page-container theme-${activeTheme}`} style={{ fontFamily: FONT_MAP[activeFont].family }}>
                            <PageContent pageIdx={sideData.index} pages={pages} pageHighlights={pageHighlights} metadata={metadata} activeFont={activeFont} />
                            <PageFooter pageIdx={sideData.index} isRight={isRight} metadata={metadata} />
                            {isRight ? <div className="effect-gutter-right"></div> : <div className="effect-gutter-left"></div>}
                        </div>
                    );
                }
                return null;
            };

            return (
                <div className="mockup-book-wrapper">
                    {renderSide(spread.left, false)}
                    {renderSide(spread.right, true)}
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 3. New UI Components: MemoAlert (Vertical Post-it Style) & UndoSnackbar
        // ----------------------------------------------------------------------

        const MemoAlert = ({ config, onClose }) => {
            const [status, setStatus] = useState('enter-start');

            useEffect(() => {
                if (config) {
                    setStatus('enter-start');
                    requestAnimationFrame(() => {
                        setStatus('idle');
                    });
                }
            }, []); 

            const handleAction = (callback) => {
                setStatus('exiting');
                setTimeout(() => {
                    callback();
                    onClose();
                }, 300);
            };

            if (!config) return null;

            const position = config.position || 'center';
            let posClass = '';
            if (position === 'center') posClass = 'top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2';
            else if (position === 'top-left') posClass = 'top-[60px] left-[500px]'; 
            else if (position === 'bottom-right') posClass = 'bottom-[80px] right-[20px]'; 
            else if (position === 'center-up') posClass = 'top-[35%] left-1/2 -translate-x-1/2 -translate-y-1/2';
            else if (position === 'mobile-bottom') posClass = 'bottom-[110px] left-1/2 -translate-x-1/2';
            else if (position === 'mobile-top-left') posClass = 'top-[70px] left-[20px]';

            const isIdle = status === 'idle';
            const baseClass = "transform transition-all duration-300 ease-out";
            const stateClass = isIdle 
                ? "opacity-100 scale-100 rotate-1" 
                : "opacity-0 scale-95 rotate-0 translate-y-2";

            return (
                <div className="fixed inset-0 z-[100]">
                     <div className="absolute inset-0 bg-transparent" onClick={() => handleAction(() => { if(config.onCancel) config.onCancel(); })}></div>
                     <div className={`fixed ${posClass} ${baseClass} ${stateClass} pointer-events-auto`}>
                         <div className="relative bg-[#fffbf0] w-48 min-h-[100px] p-5 pt-8 shadow-[2px_4px_8px_rgba(0,0,0,0.15)] rotate-1 border border-[#e8e4d9]">
                            <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-16 h-8 bg-white/40 backdrop-blur-[1px] shadow-sm rotate-[-2deg] border-l border-r border-white/60"></div>
                            <div className="text-center flex flex-col h-full justify-between">
                                <p className="font-['Gowun_Batang'] text-[10px] leading-relaxed text-slate-800 whitespace-pre-line mb-3 pt-0">
                                    {config.message}
                                </p>
                                <div className="flex gap-6 justify-center items-center pb-2 font-['Gowun_Batang']">
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); handleAction(() => config.onConfirm()); }}
                                        className="text-rose-600 text-sm font-bold relative group transition-transform active:scale-95"
                                    >
                                        ‚ë†ÎÑ§
                                    </button>
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); handleAction(() => { if(config.onCancel) config.onCancel(); }); }}
                                        className="text-slate-400 text-sm transition-colors hover:text-slate-600 active:scale-95"
                                    >
                                        ‚ë°ÏïÑÎãàÏò§
                                    </button>
                                </div>
                            </div>
                         </div>
                     </div>
                </div>
            );
        };

        const UndoSnackbar = ({ visible, onUndo }) => {
            if (!visible) return null;
            return (
                <div className="absolute top-[70px] right-6 z-[70] bg-slate-900 text-white px-4 py-3 rounded shadow-lg flex items-center gap-4 text-xs animate-slide-down">
                    <span>ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.</span>
                    <button onClick={onUndo} className="font-bold text-yellow-400 hover:text-yellow-300 underline">Ïã§Ìñâ Ï∑®ÏÜå</button>
                </div>
            );
        };


        // ----------------------------------------------------------------------
        // 4. Toolbar Component
        // ----------------------------------------------------------------------
        const Toolbar = ({ textInput, setTextInput, textAreaRef }) => {
            const [isCurlyQuotes, setIsCurlyQuotes] = useState(false);
            const [isSpacedDialogue, setIsSpacedDialogue] = useState(false);

            const insertText = (text, cursorOffset = 0) => {
                haptic.tap();
                const textarea = textAreaRef.current;
                if (!textarea) return;

                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const newText = textInput.substring(0, start) + text + textInput.substring(end);
                
                setTextInput(newText);
                
                setTimeout(() => {
                    textarea.focus({ preventScroll: true });
                    const newCursorPos = start + text.length + cursorOffset;
                    textarea.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            };

            const insertPair = (open, close) => {
                haptic.tap();
                const textarea = textAreaRef.current;
                if (!textarea) return;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const newText = textInput.substring(0, start) + open + close + textInput.substring(end);
                setTextInput(newText);
                setTimeout(() => {
                    textarea.focus({ preventScroll: true });
                    textarea.setSelectionRange(start + 1, start + 1);
                }, 0);
            };

            const toggleQuotes = (e) => {
                if(e && e.preventDefault) e.preventDefault();
                haptic.success();
                if (textAreaRef.current && isMobile()) textAreaRef.current.blur();

                const newState = !isCurlyQuotes;
                setIsCurlyQuotes(newState);
                
                let formatted = textInput;
                if (newState) {
                    formatted = formatted.replace(/(")([^"]+)(")/g, "‚Äú$2‚Äù");
                    formatted = formatted.replace(/(')([^']+)(')/g, "‚Äò$2‚Äô");
                    formatted = formatted.replace(/(^|[\s\(\[\{])"/g, '$1‚Äú');
                    formatted = formatted.replace(/"/g, '‚Äù');
                    formatted = formatted.replace(/(^|[\s\(\[\{])"/g, '$1‚Äò');
                    formatted = formatted.replace(/'/g, '‚Äô');
                } else {
                    formatted = formatted.replace(/[‚Äú‚Äù]/g, '"');
                    formatted = formatted.replace(/[‚Äò‚Äô]/g, "'");
                }
                setTextInput(formatted);
            };

            const toggleSpacing = (e) => {
                if(e && e.preventDefault) e.preventDefault();
                haptic.success();
                if (textAreaRef.current && isMobile()) textAreaRef.current.blur();

                const newState = !isSpacedDialogue;
                setIsSpacedDialogue(newState);
                
                const lines = textInput.split('\n');
                let newLines = [];
                let inDialogueBlock = false;

                if (newState) {
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        const isQuote = line.startsWith('‚Äú') || line.startsWith('"') || line.startsWith("'") || line.startsWith('‚Äò');
                        const isTranslation = line.startsWith('‚ùò') || line.startsWith('|');
                        const isDialogueLine = isQuote || isTranslation;
                        
                        if (isDialogueLine) {
                            if (!inDialogueBlock) {
                                if (newLines.length > 0 && newLines[newLines.length - 1] !== '') {
                                    newLines.push('');
                                }
                                inDialogueBlock = true;
                            }
                            newLines.push(line);
                        } else {
                            if (inDialogueBlock) {
                                if (line !== '') newLines.push('');
                                inDialogueBlock = false;
                            }
                            newLines.push(line);
                        }
                    }
                } else {
                    const compactLines = [];
                    for(let i=0; i<lines.length; i++) {
                        const line = lines[i]; 
                        const trimmed = line.trim();
                        const nextLine = (i < lines.length - 1) ? lines[i+1].trim() : '';
                        const prevLine = (i > 0) ? lines[i-1].trim() : '';
                        
                        const checkIsDialogue = (str) => str.startsWith('‚Äú') || str.startsWith('"') || str.startsWith("'") || str.startsWith('‚Äò') || str.startsWith('‚ùò') || str.startsWith('|');

                        const isNextDialogue = checkIsDialogue(nextLine);
                        const isPrevDialogue = checkIsDialogue(prevLine);

                        if (trimmed === '') {
                             if (isNextDialogue || isPrevDialogue) {
                                 continue; 
                             }
                        }
                        compactLines.push(line);
                    }
                    newLines = compactLines;
                }
                
                setTextInput(newLines.join('\n'));
            };

            return (
                <div className="flex flex-col bg-white border-t border-slate-100">
                    <div className="flex justify-center items-center w-full h-11 px-6 gap-12">
                        <button onMouseDown={(e) => e.preventDefault()} onClick={() => insertPair('‚Äú', '‚Äù')} className="text-xl font-serif text-slate-800 hover:text-black active:scale-90 transition-transform">‚Äú ‚Äù</button>
                        <button onMouseDown={(e) => e.preventDefault()} onClick={() => insertPair('‚Äò', '‚Äô')} className="text-xl font-serif text-slate-800 hover:text-black active:scale-90 transition-transform">‚Äò ‚Äô</button>
                        <button onMouseDown={(e) => e.preventDefault()} onClick={() => insertText('‚Ä¶')} className="text-xl font-serif text-slate-800 hover:text-black active:scale-90 transition-transform">‚Ä¶</button>
                        <button onMouseDown={(e) => e.preventDefault()} onClick={() => insertText('‚Äï')} className="text-xl font-serif text-slate-800 hover:text-black active:scale-90 transition-transform">‚Äï</button>
                        <button onMouseDown={(e) => e.preventDefault()} onClick={() => insertText('***')} className="text-sm font-sans text-slate-800 font-bold hover:text-black active:scale-90 transition-transform tracking-widest">***</button>
                    </div>

                    <div className="flex gap-2 px-4 pb-3 justify-center">
                         <button 
                            onMouseDown={(e) => e.preventDefault()}
                            onClick={toggleQuotes}
                            className={`py-2 px-4 rounded-full text-xs font-medium transition-all shadow-sm border ${
                                isCurlyQuotes 
                                ? 'bg-indigo-50 border-indigo-200 text-indigo-700' 
                                : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'
                            }`}
                        >
                            {isCurlyQuotes ? 'ü™Ñ ÏßÅÏÑ†Îî∞Ïò¥ÌëúÎ°ú Î≥ÄÌôò' : 'ü™Ñ Îë•Í∑ºÎî∞Ïò¥ÌëúÎ°ú Î≥ÄÌôò'}
                        </button>
                        <button 
                            onMouseDown={(e) => e.preventDefault()}
                            onClick={toggleSpacing}
                            className={`py-2 px-4 rounded-full text-xs font-medium transition-all shadow-sm border ${
                                isSpacedDialogue
                                ? 'bg-indigo-50 border-indigo-200 text-indigo-700'
                                : 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50'
                            }`}
                        >
                            {isSpacedDialogue ? 'ü™Ñ ÎåÄÏÇ¨ Í∞ÑÍ≤© Ï¢ÅÌûàÍ∏∞' : 'ü™Ñ ÎåÄÏÇ¨ ÏûêÎèô ÎùÑÏö∞Í∏∞'}
                        </button>
                    </div>
                </div>
            );
        };

        // ----------------------------------------------------------------------
        // 5. Main Application Component
        // ----------------------------------------------------------------------

        const PAGE_CONTENT_HEIGHT = 460;
        const BOTTOM_BUFFER_P1 = 15;
        const STORAGE_KEY = 'novel_generator_draft';

        function App() {
            const [step, setStep] = useState('input');
            const [textInput, setTextInput] = useState('');
            const [metadata, setMetadata] = useState({ title: '', author: '', producer: '' });
            
            const [activeTheme, setActiveTheme] = useState('white'); 
            const [activeFont, setActiveFont] = useState('noto'); 
            
            const [activeTab, setActiveTab] = useState(null); 
            const [renderedTab, setRenderedTab] = useState(null); 
            const [isLayer2Visible, setIsLayer2Visible] = useState(false);

            const [toolMode, setToolMode] = useState('highlight'); 
            const [tipsShown, setTipsShown] = useState({ highlight: false, text: false });
            const [toastVisible, setToastVisible] = useState(false);
            const [startTipVisible, setStartTipVisible] = useState(false); // New state for start tip
            const [saveToast, setSaveToast] = useState(false); 
            const [mockupToast, setMockupToast] = useState(null);
            const [inputToast, setInputToast] = useState('');
            const [exitToast, setExitToast] = useState(false); 
            
            const [memoAlert, setMemoAlert] = useState(null); 
            const [showUndo, setShowUndo] = useState(false);
            const [undoData, setUndoData] = useState(null);

            const [pages, setPages] = useState([]);
            const [currentPageIdx, setCurrentPageIdx] = useState(0);
            const [pageHighlights, setPageHighlights] = useState({});
            
            const [currentHighlightColor, setCurrentHighlightColor] = useState('highlight-yellow');
            const [currentTextColor, setCurrentTextColor] = useState('text-crimson');
            
            const [isGenerating, setIsGenerating] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [loadingProgress, setLoadingProgress] = useState(0);
            
            const debouncedText = useDebounce(textInput, 500);
            const [estimatedPages, setEstimatedPages] = useState(0);

            const [mockupSpreadIdx, setMockupSpreadIdx] = useState(0);
            const [frontFlyleafText, setFrontFlyleafText] = useState('');
            const [backFlyleafText, setBackFlyleafText] = useState('');
            
            const [focusedFlyleaf, setFocusedFlyleaf] = useState(null);

            const measureContainerRef = useRef(null);
            const viewerRef = useRef(null);
            
            // Separation of refs for mobile and desktop views
            const mobileContentRef = useRef(null);
            const desktopContentRef = useRef(null);
            
            const textAreaRef = useRef(null);

            // -- Logic: Auto-Save & Load --
            useEffect(() => {
                const savedData = localStorage.getItem(STORAGE_KEY);
                window.history.replaceState({ step: 'input' }, '');
                
                if (savedData) {
                    setTimeout(() => {
                        window.history.pushState({ popup: 'draft' }, '');
                        setMemoAlert({
                            isDraft: true,
                            message: 'ÏûëÏÑ± Ï§ëÏù∏ ÎÇ¥Ïö©Ïù¥ ÏûàÏäµÎãàÎã§.\nÎ∂àÎü¨Ïò§ÏãúÍ≤†ÏäµÎãàÍπå?',
                            onConfirm: () => loadDraft(),
                            onCancel: () => {
                                window.history.back(); 
                            },
                            position: 'center',
                            timestamp: Date.now()
                        });
                    }, 200);
                }
            }, []);

            const loadDraft = () => {
                try {
                    const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY));
                    if (savedData) {
                        setTextInput(savedData.textInput || '');
                        setMetadata(savedData.metadata || { title: '', author: '', producer: '' });
                        if (savedData.activeTheme) setActiveTheme(savedData.activeTheme);
                        if (savedData.activeFont) setActiveFont(savedData.activeFont);
                        haptic.success();
                    }
                } catch (e) {
                    console.error("Failed to load draft", e);
                }
            };

            const clearDraft = () => {
                localStorage.removeItem(STORAGE_KEY);
                haptic.tap();
            };

            const handleDelete = () => {
                haptic.tap();
                const backup = {
                    textInput, metadata, activeTheme, activeFont
                };
                setUndoData(backup);
                
                localStorage.removeItem(STORAGE_KEY);
                setTextInput('');
                setMetadata({ title: '', author: '', producer: '' });
                
                setShowUndo(true);
                setTimeout(() => setShowUndo(false), 3000);
            };

            const handleUndo = () => {
                haptic.success();
                if (undoData) {
                    setTextInput(undoData.textInput || '');
                    setMetadata(undoData.metadata || { title: '', author: '', producer: '' });
                    if (undoData.activeTheme) setActiveTheme(undoData.activeTheme);
                    if (undoData.activeFont) setActiveFont(undoData.activeFont);
                    setShowUndo(false);
                }
            };

            useEffect(() => {
                if (textInput || metadata.title || metadata.author || metadata.producer) {
                    const dataToSave = {
                        textInput,
                        metadata,
                        activeTheme,
                        activeFont,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                }
            }, [textInput, metadata, activeTheme, activeFont]);


            // -- Logic: Back Button Handling --
            useEffect(() => {
                const handlePopState = (event) => {
                    if (memoAlert && memoAlert.isDraft) {
                         setMemoAlert(null);
                         clearDraft(); 
                         return;
                    }
                    
                    if (memoAlert && !memoAlert.isDraft) {
                        setMemoAlert(null);
                        return;
                    }

                    if (step === 'result') {
                        if (activeTab) {
                            window.history.pushState({ step: 'result' }, '');
                            toggleTab(activeTab, null); 
                            return;
                        } else {
                            // If menu closed, check conditions to show exit popup
                            
                            const container = mobileContentRef.current || desktopContentRef.current;
                            const hasDecorations = Object.values(pageHighlights).some(html => html.includes('data-group-id')) ||
                                                 (container && container.innerHTML.includes('data-group-id'));

                            if (hasDecorations) {
                                window.history.pushState({ step: 'result' }, ''); 
                                setMemoAlert({
                                    message: 'ÌòïÍ¥ëÌéúÍ≥º Í∏ÄÏûêÏÉâÏù¥\nÏßÄÏõåÏßëÎãàÎã§.\nÍ∑∏ÎûòÎèÑ ÎÇòÍ∞ÄÏãúÍ≤†Ïñ¥Ïöî?',
                                    onConfirm: () => {
                                        executeBackToEdit();
                                    },
                                    onCancel: () => {},
                                    position: 'mobile-bottom',
                                    timestamp: Date.now()
                                });
                            } else {
                                executeBackToEdit(); // Direct exit if no decorations
                            }
                        }
                    } else if (step === 'input') {
                         if (!exitToast) {
                             window.history.pushState({ step: 'input' }, '');
                             setExitToast(true);
                             haptic.tap();
                             setTimeout(() => setExitToast(false), 2000);
                         }
                    }
                };

                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, [step, activeTab, exitToast, memoAlert, pageHighlights]);


            // -- Logic: Pagination --
            const calculatePages = (text, fontKey) => {
                const measureBox = measureContainerRef.current;
                if (!measureBox) return [];
                measureBox.style.fontFamily = FONT_MAP[fontKey].family;
                const rawParagraphs = text.split('\n');
                let currentParagraphs = [];
                let pageNum = 1;
                let resultPages = [];
                let queue = rawParagraphs.map(text => {
                    const trimmed = text.trim();
                    if (trimmed === '***') return { text: '*\u00A0\u00A0\u00A0\u00A0\u00A0*\u00A0\u00A0\u00A0\u00A0\u00A0*', isContinued: false, isSceneBreak: true };
                    return { text: text, isContinued: false, isSceneBreak: false };
                });
                measureBox.innerHTML = ''; 
                if (metadata.title && pageNum === 1) {
                    const titlePlaceholder = document.createElement('div');
                    titlePlaceholder.style.height = "200px"; titlePlaceholder.style.width = "100%"; titlePlaceholder.style.marginBottom = "0"; 
                    measureBox.appendChild(titlePlaceholder);
                }
                const findSplitIndex = (text, maxHeight, isContinued) => {
                    const tempP = document.createElement('p');
                    tempP.style.lineHeight = "1.8"; tempP.style.marginBottom = "0"; tempP.style.fontFamily = FONT_MAP[fontKey].family;
                    if (isContinued) tempP.classList.add('continued'); else tempP.style.textIndent = '1em';
                    measureBox.appendChild(tempP);
                    let low = 0; let high = text.length; let bestIdx = 0;
                    while (low <= high) {
                        const mid = Math.floor((low + high) / 2);
                        const subText = text.substring(0, mid);
                        tempP.textContent = subText;
                        if (tempP.offsetHeight <= maxHeight) { bestIdx = mid; low = mid + 1; } else { high = mid - 1; }
                    }
                    measureBox.removeChild(tempP);
                    return bestIdx;
                };
                while (queue.length > 0) {
                    const item = queue.shift();
                    const effectiveText = (!item.isSceneBreak && item.text.trim().length === 0) ? '\u00A0' : item.text;
                    const p = document.createElement('p');
                    p.textContent = effectiveText;
                    p.style.lineHeight = "1.8"; p.style.marginBottom = "0"; p.style.fontFamily = FONT_MAP[fontKey].family;
                    if (item.isSceneBreak) { p.style.textAlign = 'center'; p.style.textIndent = '0'; } else if (item.isContinued) { p.classList.add('continued'); } else { p.style.textIndent = '1em'; }
                    measureBox.appendChild(p);
                    const currentHeight = measureBox.scrollHeight;
                    const currentBuffer = (pageNum === 1) ? BOTTOM_BUFFER_P1 : 0;
                    const limitHeight = PAGE_CONTENT_HEIGHT - currentBuffer;
                    if (currentHeight <= limitHeight) {
                        currentParagraphs.push({ text: effectiveText, isContinued: item.isContinued, isSceneBreak: item.isSceneBreak });
                    } else {
                        measureBox.removeChild(p); 
                        const currentBaseHeight = measureBox.scrollHeight;
                        const availableHeight = limitHeight - currentBaseHeight;
                        if (availableHeight < 18) {
                            queue.unshift(item);
                        } else {
                            const splitIdx = findSplitIndex(effectiveText, availableHeight, item.isContinued);
                            if (splitIdx > 0) {
                                const partA = effectiveText.substring(0, splitIdx);
                                const partB = effectiveText.substring(splitIdx);
                                currentParagraphs.push({ text: partA, isContinued: item.isContinued, isSceneBreak: item.isSceneBreak });
                                if (partB.length > 0) queue.unshift({ text: partB, isContinued: true, isSceneBreak: item.isSceneBreak });
                            } else {
                                queue.unshift(item);
                            }
                        }
                        resultPages.push({ paragraphs: currentParagraphs });
                        currentParagraphs = [];
                        pageNum++;
                        measureBox.innerHTML = '';
                    }
                }
                if (currentParagraphs.length > 0) resultPages.push({ paragraphs: currentParagraphs });
                return resultPages;
            };

            useEffect(() => {
                if (step === 'input' && debouncedText) {
                    const p = calculatePages(debouncedText, activeFont);
                    setEstimatedPages(p.length);
                } else {
                    setEstimatedPages(0);
                }
            }, [debouncedText, step, activeFont, metadata.title]);

            useEffect(() => {
                let timer;
                if (saveToast) {
                    timer = setTimeout(() => setSaveToast(false), 3000);
                }
                return () => clearTimeout(timer);
            }, [saveToast]);

            const startGeneration = async (targetFont = null) => {
                haptic.tap();
                const fontToUse = targetFont || activeFont;
                const txt = textInput;
                if (!txt.trim()) { 
                    if(!targetFont) {
                        haptic.error();
                        setInputToast('Î≥∏Î¨∏ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                        setTimeout(() => setInputToast(''), 2000);
                    } 
                    return; 
                }
                if (document.activeElement instanceof HTMLElement) document.activeElement.blur();
                setIsGenerating(true);
                
                if (!targetFont) {
                    window.history.pushState({ step: 'result' }, '');
                }

                setTimeout(() => {
                    const resultPages = calculatePages(txt, fontToUse);
                    setPages(resultPages);
                    if (targetFont) {
                        setCurrentPageIdx(prev => Math.min(prev, resultPages.length - 1));
                    } else {
                        setCurrentPageIdx(0);
                        setPageHighlights({});
                    }
                    if (!targetFont) {
                        setStep('result');
                        // Use window.innerWidth to correctly detect mobile layout even on desktop resize
                        if (isMobile() || window.innerWidth < 768) {
                            setActiveTab('theme');
                            setRenderedTab('theme'); // Immediately render for no delay
                            setStartTipVisible(true); // Show start tip
                            setTimeout(() => setStartTipVisible(false), 4000);
                        } else {
                            setActiveTab('style');
                        }
                        setTimeout(() => setIsLayer2Visible(true), 100);
                    }
                    setIsGenerating(false);
                    if (!targetFont) setTimeout(() => window.scrollTo(0, 0), 100);
                }, 400);
            };

            const toggleTab = (tab, mode) => {
                haptic.tap();
                if (activeTab === tab) {
                    setIsLayer2Visible(false);
                    setTimeout(() => {
                        setActiveTab(null);
                        setToolMode(null);
                    }, 300);
                } else {
                    setActiveTab(tab);
                    setToolMode(mode);
                    setRenderedTab(tab); 
                    requestAnimationFrame(() => {
                        setIsLayer2Visible(true);
                    });
                }
            };
            
            useEffect(() => {
                if (activeTab) {
                    setRenderedTab(activeTab);
                }
            }, [activeTab]);


            const handleFontChangeRequest = (newFont) => {
                haptic.tap();
                if (activeFont === newFont) return;
                
                const container = mobileContentRef.current || desktopContentRef.current;
                const hasDecorations = Object.values(pageHighlights).some(html => html.includes('data-group-id')) ||
                                     (container && container.innerHTML.includes('data-group-id'));

                if (hasDecorations) {
                    setMemoAlert({
                        message: 'ÌòïÍ¥ëÌéúÍ≥º Í∏ÄÏûêÏÉâÏù¥\nÏßÄÏõåÏßëÎãàÎã§.\nÍ∑∏ÎûòÎèÑ Î∞îÍæ∏ÏãúÍ≤†Ïñ¥Ïöî?',
                        onConfirm: () => {
                             setActiveFont(newFont);
                             setPageHighlights({});
                             startGeneration(newFont);
                        },
                        onCancel: () => {},
                        position: isMobile() ? 'mobile-bottom' : 'center-up',
                        timestamp: Date.now()
                    });
                } else {
                    setActiveFont(newFont);
                    setPageHighlights({}); 
                    startGeneration(newFont);
                }
            };

            const saveCurrentPageState = (containerOverride) => {
                const container = containerOverride || mobileContentRef.current || desktopContentRef.current;
                if (container) {
                     setPageHighlights(prev => ({ ...prev, [currentPageIdx]: container.innerHTML }));
                }
            };

            const handleHighlightSelection = () => {
                if (activeTab !== 'highlight' && activeTab !== 'text' && activeTab !== 'tool' && activeTab !== 'style') return;
                
                const selection = window.getSelection();
                if (!selection || selection.rangeCount === 0 || selection.toString().trim() === '') return;
                
                haptic.tap();
                const range = selection.getRangeAt(0);
                
                // Determine which container the user is selecting from
                let container = null;
                if (mobileContentRef.current && mobileContentRef.current.contains(range.commonAncestorContainer)) {
                    container = mobileContentRef.current;
                } else if (desktopContentRef.current && desktopContentRef.current.contains(range.commonAncestorContainer)) {
                    container = desktopContentRef.current;
                }
                
                if (!container) return;
                
                const highlightId = 'hl-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                try {
                    const treeWalker = document.createTreeWalker(range.commonAncestorContainer, NodeFilter.SHOW_TEXT, { acceptNode: function(node) { if (!range.intersectsNode(node)) return NodeFilter.FILTER_REJECT; return NodeFilter.FILTER_ACCEPT; } });
                    const nodesToHighlight = [];
                    if (range.commonAncestorContainer.nodeType === Node.TEXT_NODE) { if (range.intersectsNode(range.commonAncestorContainer)) nodesToHighlight.push(range.commonAncestorContainer); }
                    else { let currentNode = treeWalker.nextNode(); while (currentNode) { nodesToHighlight.push(currentNode); currentNode = treeWalker.nextNode(); } }
                    nodesToHighlight.forEach(node => {
                        const nodeRange = document.createRange(); nodeRange.selectNodeContents(node);
                        if (node === range.startContainer) nodeRange.setStart(node, range.startOffset);
                        if (node === range.endContainer) nodeRange.setEnd(node, range.endOffset);
                        const text = nodeRange.toString();
                        if (text.trim().length > 0) {
                            const span = document.createElement('span');
                            if (activeTab === 'highlight' || (activeTab === 'tool' && toolMode === 'highlight')) span.className = `highlight ${currentHighlightColor}`;
                            else if (activeTab === 'text' || (activeTab === 'tool' && toolMode === 'text')) span.className = `colored-text ${currentTextColor}`;
                            span.setAttribute('data-group-id', highlightId);
                            nodeRange.surroundContents(span);
                        }
                    });
                    selection.removeAllRanges();
                    saveCurrentPageState(container);
                } catch (e) { console.log("Highlight failed", e); }
            };

            const handleContentClick = (e) => {
                if (activeTab !== 'highlight' && activeTab !== 'text' && activeTab !== 'tool') return;
                const target = e.target;
                
                // Determine container
                let container = null;
                if (mobileContentRef.current && mobileContentRef.current.contains(target)) {
                    container = mobileContentRef.current;
                } else if (desktopContentRef.current && desktopContentRef.current.contains(target)) {
                    container = desktopContentRef.current;
                }
                if (!container) return;

                let shouldRemove = false;
                if ((activeTab === 'highlight' || (activeTab === 'tool' && toolMode === 'highlight')) && target.classList.contains('highlight')) shouldRemove = true;
                else if ((activeTab === 'text' || (activeTab === 'tool' && toolMode === 'text')) && target.classList.contains('colored-text')) shouldRemove = true;
                
                if (shouldRemove) {
                    haptic.tap();
                    const groupId = target.getAttribute('data-group-id');
                    if (groupId) {
                        const allSpans = container.querySelectorAll(`span[data-group-id="${groupId}"]`);
                        allSpans.forEach(span => {
                            const text = span.textContent;
                            const textNode = document.createTextNode(text);
                            span.parentNode.replaceChild(textNode, span);
                        });
                        saveCurrentPageState(container);
                    }
                }
            };

            const goToPage = (idx) => {
                haptic.tap();
                saveCurrentPageState();
                setCurrentPageIdx(idx);
                window.scrollTo(0, 0);
            };

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (step === 'result') {
                        if (activeTab === 'mockup' && !focusedFlyleaf) {
                            if (e.key === 'ArrowLeft' && mockupSpreadIdx > 0) setMockupSpreadIdx(prev => prev - 1);
                            else if (e.key === 'ArrowRight' && mockupSpreadIdx < spreads.length - 1) setMockupSpreadIdx(prev => prev + 1);
                        } else {
                            if (e.key === 'ArrowLeft' && currentPageIdx > 0) goToPage(currentPageIdx - 1);
                            else if (e.key === 'ArrowRight' && currentPageIdx < pages.length - 1) goToPage(currentPageIdx + 1);
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [step, currentPageIdx, pages.length, mockupSpreadIdx, focusedFlyleaf, activeTab]);

            const touchStartRef = useRef(null);
            const touchEndRef = useRef(null);
            const minSwipeDistance = 50;
            const onTouchStart = (e) => { touchEndRef.current = null; touchStartRef.current = e.targetTouches[0].clientX; };
            const onTouchMove = (e) => { touchEndRef.current = e.targetTouches[0].clientX; };
            const onTouchEnd = () => {
                if (activeTab === 'highlight' || activeTab === 'text' || activeTab === 'tool') {
                    handleHighlightSelection();
                    return; 
                }

                if (!touchStartRef.current || !touchEndRef.current) return;
                const distance = touchStartRef.current - touchEndRef.current;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;
                if (step === 'result') {
                    if (activeTab === 'mockup' && !focusedFlyleaf) {
                         if (isLeftSwipe && mockupSpreadIdx < spreads.length - 1) setMockupSpreadIdx(prev => prev + 1);
                         if (isRightSwipe && mockupSpreadIdx > 0) setMockupSpreadIdx(prev => prev - 1);
                    } else {
                        if (isLeftSwipe && currentPageIdx < pages.length - 1) goToPage(currentPageIdx + 1);
                        if (isRightSwipe && currentPageIdx > 0) goToPage(currentPageIdx - 1);
                    }
                }
            };

            const executeBackToEdit = () => {
                 haptic.tap();
                 setStep('input'); setPages([]); setPageHighlights({}); setCurrentPageIdx(0); setActiveTab('theme'); window.scrollTo(0, 0);
                 window.history.pushState({ step: 'input' }, '');
            }

            const backToEditUI = () => {
                haptic.tap();
                // For UI back icon
                const container = mobileContentRef.current || desktopContentRef.current;
                const hasDecorations = Object.values(pageHighlights).some(html => html.includes('data-group-id')) ||
                                     (container && container.innerHTML.includes('data-group-id'));

                if (hasDecorations) {
                    setMemoAlert({
                        message: 'ÌòïÍ¥ëÌéúÍ≥º Í∏ÄÏûêÏÉâÏù¥\nÏßÄÏõåÏßëÎãàÎã§.\nÍ∑∏ÎûòÎèÑ ÎÇòÍ∞ÄÏãúÍ≤†Ïñ¥Ïöî?',
                        onConfirm: () => executeBackToEdit(),
                        onCancel: () => {},
                        position: isMobile() ? 'mobile-top-left' : 'top-left',
                        timestamp: Date.now()
                    });
                } else {
                    executeBackToEdit();
                }
            };

            const downloadAllSequential = async () => {
                haptic.tap();
                if (activeTab === 'mockup') {
                    const originalSpreadIdx = mockupSpreadIdx;
                    try {
                        setLoadingMessage('Ìè∞Ìä∏ Î°úÎî© Ï§ë...');
                        const fontCss = await prepareFontEmbedCSS(activeFont);
                        const safeTitle = (metadata.title || 'novel').replace(/[\/\?<>\\:\*\|":\s]/g, '_');

                        for(let i=0; i<spreads.length; i++){
                            setMockupSpreadIdx(i);
                            setLoadingMessage(`Î™©ÏóÖ Ï†ÄÏû• Ï§ë... (${i+1}/${spreads.length})`);
                            await new Promise(r => setTimeout(r, 300)); 
                            
                            const target = document.getElementById('mockupCaptureHidden');
                            if(target){
                                const fileName = `${safeTitle}_mockup_${String(i+1).padStart(2,'0')}.png`;
                                await captureNode(target, fileName, 840, 600, fontCss);
                            }
                        }
                        haptic.success();
                        setSaveToast(true);
                    } catch(e) { 
                        haptic.error();
                        console.error(e); 
                        alert("Ï†ÄÏû• Ïã§Ìå®"); 
                    } finally { 
                        setLoadingMessage(''); 
                        setMockupSpreadIdx(originalSpreadIdx); 
                    }
                    return;
                }

                saveCurrentPageState();
                const originalPageIdx = currentPageIdx;
                window.scrollTo(0, 0);
                
                try {
                    setLoadingMessage('Ìè∞Ìä∏ Î°úÎî© Ï§ë...');
                    await ensureFontsLoaded();
                    const fontCss = await prepareFontEmbedCSS(activeFont);
                    const safeTitle = (metadata.title || 'novel').replace(/[\/\?<>\\:\*\|":\s]/g, '_');

                    for (let i = 0; i < pages.length; i++) {
                        setCurrentPageIdx(i);
                        setLoadingMessage(`Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ï§ë... (${i + 1}/${pages.length})`);
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        const target = document.getElementById('captureTarget');
                        if (target) {
                            const fileName = `${safeTitle}_${String(i+1).padStart(3, '0')}p.png`;
                            await captureNode(target, fileName, 420, 600, fontCss);
                        }
                    }

                    haptic.success();
                    setTimeout(() => setSaveToast(true), 500);
                } catch (e) { 
                    haptic.error();
                    console.error(e); 
                    alert("Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + e.message); 
                } finally { 
                    setLoadingMessage(''); 
                    setLoadingProgress(0); 
                    setCurrentPageIdx(originalPageIdx); 
                }
            };

            const downloadCurrent = async () => {
                haptic.tap();
                const isMockup = activeTab === 'mockup';

                setLoadingMessage('Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• Ï§ë...');
                try {
                    await ensureFontsLoaded();
                    const fontCss = await prepareFontEmbedCSS(activeFont);
                    
                    const safeTitle = (metadata.title || 'novel').replace(/[\/\?<>\\:\*\|":\s]/g, '_');

                    if (isMockup) {
                        const target = document.getElementById('mockupCaptureHidden');
                        if (target) {
                             const fileName = `${safeTitle}_mockup_${String(mockupSpreadIdx+1).padStart(2,'0')}.png`;
                             await captureNode(target, fileName, 840, 600, fontCss);
                        }
                    } else {
                        const target = document.getElementById('captureTarget');
                        if (target) {
                            const fileName = `${safeTitle}_${String(currentPageIdx+1).padStart(3, '0')}p.png`;
                            await captureNode(target, fileName, 420, 600, fontCss);
                        }
                    }
                    haptic.success();
                    setTimeout(() => setSaveToast(true), 500);
                } catch (e) {
                    haptic.error();
                    console.error(e);
                    alert("Ï†ÄÏû• Ïã§Ìå®");
                } finally {
                    setLoadingMessage('');
                }
            };

            const getSpreads = useCallback(() => {
                const spreadList = [];
                spreadList.push({ left: { type: 'flyleaf-front' }, right: { type: 'page', index: 0 } });
                let i = 1;
                while (i < pages.length) {
                    const left = { type: 'page', index: i };
                    const right = (i + 1 < pages.length) ? { type: 'page', index: i + 1 } : null;
                    if (!right) { spreadList.push({ left, right: { type: 'flyleaf-back' } }); } 
                    else { spreadList.push({ left, right }); }
                    i += 2;
                }
                return spreadList;
            }, [pages.length]);

            const spreads = getSpreads();

            const handleFlyleafEdit = (type) => {
                haptic.tap();
                setFocusedFlyleaf(type);
            };

            const handleFlyleafModalChange = (e) => {
                const val = e.target.value;
                const lines = val.split('\n');
                let text = val;
                if (lines.length > 6) {
                    text = lines.slice(0, 6).join('\n');
                }
                
                if (focusedFlyleaf === 'front') setFrontFlyleafText(text);
                else if (focusedFlyleaf === 'back') setBackFlyleafText(text);
            };

            // -- Render --
            return (
                <div className="min-h-screen font-serif" onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
                    {/* Measurement Container (Hidden) */}
                    <div ref={measureContainerRef} className="hidden-measure"></div>

                    {/* Hidden Mockup Capture Target */}
                    {step === 'result' && (
                        <div style={{ position: 'fixed', top: '-10000px', left: '-10000px' }}>
                            <div id="mockupCaptureHidden" style={{ width: '840px', height: '600px', display: 'flex', alignItems: 'center', justifyContent: 'center', backgroundColor: 'transparent' }}>
                                <MockupBookRenderer 
                                    spreadIdx={mockupSpreadIdx} spreads={spreads} isCaptureMode={true} activeTheme={activeTheme} activeFont={activeFont}
                                    frontFlyleafText={frontFlyleafText} setFrontFlyleafText={setFrontFlyleafText}
                                    backFlyleafText={backFlyleafText} setBackFlyleafText={setBackFlyleafText}
                                    pageHighlights={pageHighlights} pages={pages} metadata={metadata}
                                    onEditFlyleaf={handleFlyleafEdit}
                                />
                            </div>
                        </div>
                    )}
                    
                    {/* MEMO ALERT (Vertical Post-it Style) */}
                    <MemoAlert key={memoAlert ? memoAlert.timestamp : 'empty'} config={memoAlert} onClose={() => setMemoAlert(null)} />

                    {/* UNDO SNACKBAR */}
                    
                    {/* Flyleaf Focus Modal */}
                    {focusedFlyleaf && (
                        <div className="fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setFocusedFlyleaf(null)}>
                            <div className="bg-[#1a2233] p-8 rounded-lg shadow-2xl relative flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="text-white/50 text-xs mb-4 text-center">
                                    {focusedFlyleaf === 'front' ? 'ÏïûÌëúÏßÄ' : 'Îí§ÌëúÏßÄ'} ÏÜçÏßÄ Î¨∏Íµ¨ ÏûÖÎ†• (ÏµúÎåÄ 6Ï§Ñ)
                                </div>
                                <div className={`flex flex-col ${focusedFlyleaf === 'front' ? 'items-start text-left' : 'items-end text-right'}`}>
                                    <div className={`w-[30px] h-px bg-white/50 mb-4`}></div>
                                    <textarea
                                        value={focusedFlyleaf === 'front' ? frontFlyleafText : backFlyleafText}
                                        onChange={handleFlyleafModalChange}
                                        className={`bg-transparent border-none text-white/90 focus:outline-none placeholder:text-white/20 resize-none ${focusedFlyleaf === 'front' ? 'text-left' : 'text-right'}`}
                                        rows={6}
                                        placeholder="Î¨∏Íµ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                                        autoFocus
                                        style={{ fontFamily: "'Noto Sans KR', sans-serif", fontWeight: 300, lineHeight: 1.6, fontSize: '16px', width: '240px' }}
                                    />
                                </div>
                                <button onClick={() => setFocusedFlyleaf(null)} className="mt-8 w-full py-3 bg-white/10 hover:bg-white/20 text-white rounded text-sm transition-colors">
                                    ÏôÑÎ£å
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Loading Overlay */}
                    {loadingMessage && (
                        <div className="fixed inset-0 bg-black/70 text-white flex flex-col items-center justify-center z-[9999]">
                            <div className="text-xl mb-4 font-light">{loadingMessage}</div>
                            {loadingProgress > 0 && <div className="text-sm opacity-80">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî ({loadingProgress}%)</div>}
                        </div>
                    )}
                    
                    {/* EXIT TOAST */}
                    {exitToast && (
                        <div className="toast-exit">
                            Ìïú Î≤à Îçî ÎàÑÎ•¥Î©¥ Ï¢ÖÎ£åÎê©ÎãàÎã§
                        </div>
                    )}

                    {/* DOWNLOAD SAVE TOAST (CENTER - NEW OVERLAY STRATEGY) */}
                    {saveToast && (
                        <div className="toast-overlay">
                            <div className="toast-box animate-bounce-slight">
                                Í∞§Îü¨Î¶¨Ïóê Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§
                            </div>
                        </div>
                    )}

                    {/* STEP 1: INPUT */}
                    {step === 'input' && (
                        <div className="h-[100dvh] flex flex-col bg-white md:max-w-[900px] md:mx-auto md:my-10 md:rounded-2xl md:shadow-sm md:h-auto md:min-h-[92vh] overflow-hidden relative">
                            <UndoSnackbar visible={showUndo} onUndo={handleUndo} />
                            {/* Input Validation Toast */}
                            {inputToast && (
                                <div className="fixed inset-0 flex items-center justify-center z-[9999] pointer-events-none">
                                    <div className="bg-slate-800/90 text-white px-6 py-3 rounded-full shadow-xl animate-bounce-slight text-sm font-medium">
                                        {inputToast}
                                    </div>
                                </div>
                            )}

                            {/* Header */}
                            <div className="flex items-center justify-between p-4 md:p-6 border-b border-slate-100 bg-white z-10 pt-safe relative">
                                <h1 className="text-2xl font-serif font-medium text-slate-800">Ìïú Ïû•Ïùò ÏÜåÏÑ§</h1>
                                <button onClick={handleDelete} className="text-slate-400 hover:text-red-500 transition-colors p-2" title="Ï†ÑÏ≤¥ ÏÇ≠Ï†ú">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                </button>
                            </div>
                            
                            {/* Scrollable Content */}
                            <div className="flex-1 flex flex-col p-4 md:p-6 overflow-hidden pb-0">
                                {/* Metadata Group - Compact */}
                                <div className="space-y-3 mb-4">
                                    <div>
                                        <label className="block text-xs text-slate-500 mb-1">ÏÜåÏ†úÎ™© (Ï≤´ Ïû• ÌëúÏãú) <span className="text-slate-400 font-light ml-1 text-[10px]">*ÌïÑÏöîÏãú ÏûÖÎ†•</span></label>
                                        <input type="text" value={metadata.title} onChange={(e) => setMetadata({...metadata, title: e.target.value})} className="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all text-sm" placeholder="Ï≤´ ÌéòÏù¥ÏßÄÏóê Îì§Ïñ¥Í∞à Ï†úÎ™©" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs text-slate-500 mb-1">ÏûëÌíà Ï†úÎ™©</label>
                                            <input type="text" value={metadata.author} onChange={(e) => setMetadata({...metadata, author: e.target.value})} className="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all text-sm" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-slate-500 mb-1">ÏûëÍ∞Ä</label>
                                            <input type="text" value={metadata.producer} onChange={(e) => setMetadata({...metadata, producer: e.target.value})} className="w-full p-2.5 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all text-sm" />
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Body Input - Fills remaining space */}
                                <div className="flex-1 flex flex-col min-h-0 relative border rounded-lg bg-slate-50 ring-slate-200 focus-within:ring-2 focus-within:bg-white transition-all overflow-hidden">
                                    <div className="flex justify-between items-center px-4 pt-3 pb-1 shrink-0">
                                         <label className="text-xs text-slate-500">Î≥∏Î¨∏ <span className="text-red-500 font-light ml-1 text-[10px]">*ÌïÑÏàò</span></label>
                                         {estimatedPages > 0 && <span className="text-indigo-600 font-bold text-xs">ÏïΩ {estimatedPages} ÌéòÏù¥ÏßÄ</span>}
                                    </div>
                                    
                                    <div className="relative flex-1">
                                        {!textInput && (
                                            <div className="custom-placeholder top-2 left-4 right-4 text-sm leading-relaxed text-slate-400">
                                                Ïó¨Í∏∞Ïóê ÏÜåÏÑ§ Î≥∏Î¨∏ÏùÑ Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî.<br/>ÏóîÌÑ∞Î°ú Ï§ÑÎ∞îÍøàÏùÑ ÌïòÎ©¥ Îπà Ï§ÑÏù¥ Ï†ÅÏö©Îê©ÎãàÎã§.<br/>*** Î•º ÏûÖÎ†•ÌïòÎ©¥ Ïû•Î©¥ Ï†ÑÌôò(Ï§ëÏïô Ï†ïÎ†¨)Ïù¥ Ï†ÅÏö©Îê©ÎãàÎã§.
                                            </div>
                                        )}
                                        <textarea 
                                            ref={textAreaRef}
                                            value={textInput} 
                                            onChange={(e) => setTextInput(e.target.value)} 
                                            className="absolute inset-0 w-full h-full p-6 pt-4 border-none bg-transparent outline-none resize-none font-serif leading-loose z-10 text-sm"
                                        ></textarea>
                                    </div>
                                    
                                    {/* TOOLBAR */}
                                    <Toolbar textInput={textInput} setTextInput={setTextInput} textAreaRef={textAreaRef} />
                                </div>
                            </div>

                            {/* Footer Action */}
                            <div className="p-4 md:p-6 bg-white z-10 shrink-0 pb-safe">
                                <button onClick={() => startGeneration(null)} disabled={isGenerating} className="btn w-full py-4 bg-[#1a2233] text-white rounded-lg font-medium shadow-lg flex justify-center items-center gap-2 disabled:opacity-70 transition-transform active:scale-95 hover:bg-[#2a3344]">
                                    <span>{isGenerating ? 'ÏÉùÏÑ± Ï§ë...' : 'A6 Î†àÏù¥ÏïÑÏõÉ ÏÉùÏÑ±ÌïòÍ∏∞'}</span>
                                </button>
                                <footer className="mt-4 text-center text-[10px] text-slate-300">
                                    <p>Î≥∏ ÏÇ¨Ïù¥Ìä∏Îäî Ïñ¥Îñ†Ìïú Í∞úÏù∏Ï†ïÎ≥¥ÎèÑ ÏàòÏßëÌïòÏßÄ ÏïäÏäµÎãàÎã§.</p>
                                </footer>
                            </div>
                        </div>
                    )}

                    {/* STEP 2: RESULT */}
                    {step === 'result' && (
                        <>
                            {/* --- MOBILE UI (Glassmorphism) --- */}
                            <div className="md:hidden flex flex-col min-h-screen">
                                {/* HEADER - Transparent */}
                                <div className="fixed top-0 left-0 right-0 z-50 px-4 py-4 pt-safe flex items-center justify-between pointer-events-none">
                                    <div className="pointer-events-auto">
                                        <button onClick={backToEditUI} className="glass-btn">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                                        </button>
                                    </div>
                                    <div className="absolute left-1/2 transform -translate-x-1/2 pointer-events-auto pt-safe">
                                        <div className="glass-pill font-serif tabular-nums text-slate-700">
                                            {activeTab === 'mockup' ? `${mockupSpreadIdx + 1} / ${spreads.length}` : `${currentPageIdx + 1} / ${pages.length}`}
                                        </div>
                                    </div>
                                    <div className="flex gap-3 pointer-events-auto">
                                        {/* Mobile/iPad: No Full Save Button, Only Single Save */}
                                        <button onClick={downloadCurrent} className="glass-btn" title="ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Ï†ÄÏû•">
                                             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                {/* MAIN VIEW AREA */}
                                <div className={`flex-1 flex flex-col items-center justify-center overflow-x-hidden ${activeTab === 'mockup' ? 'pt-0 pb-0' : 'pt-24 pb-20'}`}>
                                    {activeTab === 'mockup' ? (
                                        <div className="mockup-scaler w-full h-full flex items-center justify-center">
                                             <MockupBookRenderer 
                                                spreadIdx={mockupSpreadIdx} spreads={spreads} activeTheme={activeTheme} activeFont={activeFont}
                                                frontFlyleafText={frontFlyleafText} setFrontFlyleafText={setFrontFlyleafText}
                                                backFlyleafText={backFlyleafText} setBackFlyleafText={setBackFlyleafText}
                                                pageHighlights={pageHighlights} pages={pages} metadata={metadata}
                                                onEditFlyleaf={handleFlyleafEdit}
                                            />
                                        </div>
                                    ) : (
                                        <div id="bookViewerWrapper" className="flex justify-center overflow-visible select-text cursor-text" onClick={() => {}}>
                                            <div ref={viewerRef} id="captureTarget" className={`page-container theme-${activeTheme}`} style={{ fontFamily: FONT_MAP[activeFont].family }}>
                                                <PageContent 
                                                    pageIdx={currentPageIdx} pages={pages} pageHighlights={pageHighlights} metadata={metadata} activeFont={activeFont} 
                                                    onMouseUp={handleHighlightSelection} onClick={handleContentClick} contentRef={mobileContentRef}
                                                />
                                                <PageFooter pageIdx={currentPageIdx} metadata={metadata} />
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Slim Edge Glass Tab Navigation */}
                                {activeTab !== 'mockup' && currentPageIdx > 0 && (
                                    <button onClick={(e) => { e.stopPropagation(); goToPage(currentPageIdx - 1); }} className="fixed top-1/2 left-3 -translate-y-1/2 w-8 h-16 bg-white/20 backdrop-blur-sm border border-white/40 rounded-2xl shadow-lg flex items-center justify-center text-slate-600 hover:bg-white/40 transition-all z-30 group">
                                        <svg className="w-5 h-5 group-hover:-translate-x-0.5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" /></svg>
                                    </button>
                                )}
                                {activeTab !== 'mockup' && currentPageIdx < pages.length - 1 && (
                                    <button onClick={(e) => { e.stopPropagation(); goToPage(currentPageIdx + 1); }} className="fixed top-1/2 right-3 -translate-y-1/2 w-8 h-16 bg-white/20 backdrop-blur-sm border border-white/40 rounded-2xl shadow-lg flex items-center justify-center text-slate-600 hover:bg-white/40 transition-all z-30 group">
                                        <svg className="w-5 h-5 group-hover:translate-x-0.5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>
                                    </button>
                                )}
                                {activeTab === 'mockup' && mockupSpreadIdx > 0 && (
                                    <button onClick={(e) => { e.stopPropagation(); setMockupSpreadIdx(prev => prev - 1); }} className="fixed top-1/2 left-3 -translate-y-1/2 w-8 h-16 bg-white/20 backdrop-blur-sm border border-white/40 rounded-2xl shadow-lg flex items-center justify-center text-slate-600 hover:bg-white/40 transition-all z-30 group">
                                         <svg className="w-5 h-5 group-hover:-translate-x-0.5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" /></svg>
                                    </button>
                                )}
                                {activeTab === 'mockup' && mockupSpreadIdx < spreads.length - 1 && (
                                    <button onClick={(e) => { e.stopPropagation(); setMockupSpreadIdx(prev => prev + 1); }} className="fixed top-1/2 right-3 -translate-y-1/2 w-8 h-16 bg-white/20 backdrop-blur-sm border border-white/40 rounded-2xl shadow-lg flex items-center justify-center text-slate-600 hover:bg-white/40 transition-all z-30 group">
                                        <svg className="w-5 h-5 group-hover:translate-x-0.5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2.5"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>
                                    </button>
                                )}

                                {/* LAYER 2 MENU (Palette) - Floating Pills Style */}
                                <div className={`fixed bottom-[4.5rem] left-0 right-0 z-40 px-4 pb-safe pointer-events-none layer2-container ${isLayer2Visible ? 'layer2-visible' : 'layer2-hidden'}`}>
                                    <div className="max-w-lg mx-auto pointer-events-auto flex flex-col items-center">
                                        
                                        {startTipVisible && (
                                            <div className="animate-bounce-slight mb-2 bg-indigo-500 text-white text-[11px] font-bold px-3 py-1.5 rounded-full shadow-md z-50">
                                                üí° Tip: ÌòïÍ¥ëÌéúÍ≥º Í∏ÄÏûêÏÉâÏùÑ Ïπ†ÌïòÍ∏∞ Ï†ÑÏóê Ìè∞Ìä∏Î•º Î®ºÏ†Ä Ï†ïÌïòÏÑ∏Ïöî!
                                            </div>
                                        )}

                                        {mockupToast && <div className="animate-bounce-slight mb-2 bg-slate-800 text-white text-[11px] font-bold px-3 py-1.5 rounded-full shadow-md z-50">{mockupToast}</div>}

                                        {renderedTab === 'theme' && (
                                            <div className="relative w-full flex justify-center">
                                                <div className="flex items-center gap-4 px-5 py-2">
                                                    <div className="flex items-center gap-2">
                                                        {['white', 'cream', 'kraft', 'dark'].map(theme => (
                                                            <button key={theme} onClick={() => { setActiveTheme(theme); haptic.tap(); }} className={`circle-btn theme-btn-${theme} shadow-xl border ${activeTheme === theme ? 'active scale-110 border-gray-400 ring-1 ring-gray-400' : 'border-white/50'}`} style={{width:'28px', height:'28px'}}></button>
                                                        ))}
                                                    </div>
                                                    <div className="w-px h-6 bg-slate-400/30"></div>
                                                    <div className="flex items-center gap-1">
                                                        {Object.keys(FONT_MAP).map(key => (
                                                            <button key={key} onClick={() => handleFontChangeRequest(key)} className={`flex flex-col items-center justify-center w-9 h-9 rounded-lg transition-all shadow-xl border ${activeFont === key ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-700 hover:bg-white/90 border-white/50'}`}>
                                                                <span className="text-[9px] leading-tight text-center font-medium whitespace-pre-line">{FONT_MAP[key].name.replace(' ', '\n')}</span>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        {renderedTab === 'highlight' && (
                                            <div className="flex flex-col items-center justify-center w-full p-2">
                                                <div className="flex items-center justify-center gap-4 p-2">
                                                    {['highlight-yellow', 'highlight-pink', 'highlight-mint', 'highlight-blue'].map(color => (
                                                        <button key={color} onClick={() => { setCurrentHighlightColor(color); haptic.tap(); }} className={`w-9 h-9 rounded-full overflow-hidden shadow-xl border-2 transition-transform bg-white ${currentHighlightColor === color ? 'scale-110 border-gray-400' : 'border-white'}`}>
                                                            <div className={`w-full h-full ${color}`}></div>
                                                        </button>
                                                    ))}
                                                </div>
                                                <p className="text-[10px] text-slate-600 font-medium mt-0.5 drop-shadow-sm bg-white/50 px-2 rounded-full backdrop-blur-sm">ÎìúÎûòÍ∑∏ÌïòÏó¨ Ï†ÅÏö©, ÌÑ∞ÏπòÌïòÏó¨ ÏÇ≠Ï†ú</p>
                                            </div>
                                        )}
                                        {renderedTab === 'text' && (
                                            <div className="flex flex-col items-center justify-center w-full p-2">
                                                <div className="flex items-center justify-center gap-3 p-2 flex-wrap">
                                                    {[{ id: 'text-crimson', bg: 'bg-text-crimson' }, { id: 'text-navy', bg: 'bg-text-navy' }, { id: 'text-forest', bg: 'bg-text-forest' }, { id: 'text-purple', bg: 'bg-text-purple' }, { id: 'text-brown', bg: 'bg-text-brown' }, { id: 'text-teal', bg: 'bg-text-teal' }, { id: 'text-gray', bg: 'bg-text-gray' }].map(item => (
                                                        <button key={item.id} onClick={() => { setCurrentTextColor(item.id); haptic.tap(); }} className={`w-9 h-9 rounded-full overflow-hidden shadow-xl border-2 transition-transform bg-white ${currentTextColor === item.id ? 'scale-110 border-gray-400' : 'border-white'}`}>
                                                            <div className={`w-full h-full ${item.bg}`}></div>
                                                        </button>
                                                    ))}
                                                </div>
                                                <p className="text-[10px] text-slate-600 font-medium mt-0.5 drop-shadow-sm bg-white/50 px-2 rounded-full backdrop-blur-sm">ÎìúÎûòÍ∑∏ÌïòÏó¨ Ï†ÅÏö©, ÌÑ∞ÏπòÌïòÏó¨ ÏÇ≠Ï†ú</p>
                                            </div>
                                        )}
                                        {renderedTab === 'mockup' && (
                                            <div className="flex items-center justify-center gap-3 p-4 w-full">
                                                <button onClick={() => { setFocusedFlyleaf('front'); haptic.tap(); }} className="flex-1 bg-white border border-slate-200 text-slate-700 text-xs py-2.5 rounded-xl shadow-lg hover:bg-slate-50 transition-colors font-medium">Ïïû ÌëúÏßÄ Î¨∏Íµ¨ ÏûëÏÑ±</button>
                                                <button onClick={() => { haptic.tap(); if (pages.length % 2 !== 0) { haptic.error(); setMockupToast('Îí∑ ÌëúÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.'); setTimeout(() => setMockupToast(null), 2000); } else { setFocusedFlyleaf('back'); } }} className={`flex-1 text-xs py-2.5 rounded-xl shadow-lg transition-colors font-medium border ${pages.length % 2 !== 0 ? 'bg-slate-100 text-slate-400 border-slate-100 cursor-not-allowed' : 'bg-white border-slate-200 text-slate-700 hover:bg-slate-50'}`}>Îí∑ ÌëúÏßÄ Î¨∏Íµ¨ ÏûëÏÑ±</button>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* LAYER 1 MENU (Bottom Nav) */}
                                <div className="fixed bottom-0 left-0 right-0 h-16 bg-[#F9FBFD]/90 backdrop-blur-md rounded-t-[30px] shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-50 flex items-center justify-around px-2 pb-safe border-t border-white/50">
                                    <button onClick={() => toggleTab('theme', null)} className={`flex-1 flex flex-col items-center justify-center h-full transition-colors ${activeTab === 'theme' ? 'text-slate-900' : 'text-slate-400'}`}><span className="text-sm font-medium">ÏÑúÏãù</span></button>
                                    <button onClick={() => toggleTab('highlight', 'highlight')} className={`flex-1 flex flex-col items-center justify-center h-full transition-colors ${activeTab === 'highlight' ? 'text-slate-900' : 'text-slate-400'}`}><span className="text-sm font-medium">ÌòïÍ¥ëÌéú</span></button>
                                    <button onClick={() => toggleTab('text', 'text')} className={`flex-1 flex flex-col items-center justify-center h-full transition-colors ${activeTab === 'text' ? 'text-slate-900' : 'text-slate-400'}`}><span className="text-sm font-medium">Í∏ÄÏûêÏÉâ</span></button>
                                    <button onClick={() => toggleTab('mockup', null)} className={`flex-1 flex flex-col items-center justify-center h-full transition-colors ${activeTab === 'mockup' ? 'text-slate-900' : 'text-slate-400'}`}><span className="text-sm font-medium">Î™©ÏóÖ</span></button>
                                </div>
                            </div>

                            {/* --- DESKTOP UI (Classic) --- */}
                            <div className="hidden md:flex flex-col min-h-screen bg-gray-100 pb-20">
                                <div className="sticky top-0 z-50 bg-white shadow-sm">
                                    {/* Row 1: Controls */}
                                    <div className="flex items-center justify-between px-4 py-3 border-b border-slate-100 max-w-2xl mx-auto w-full">
                                        <div className="flex items-center gap-4">
                                            {/* Reset button removed as per request */}
                                            <button onClick={backToEditUI} className="flex flex-col items-center justify-center w-10 text-slate-500 hover:text-indigo-600 transition-colors">
                                                <span className="text-xl leading-none">
                                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                                                </span>
                                                <span className="text-[9px] mt-0.5">ÎÇòÍ∞ÄÍ∏∞</span>
                                            </button>
                                            <button onClick={() => { setActiveTab(activeTab === 'mockup' ? null : 'mockup'); setToolMode(null); }} className={`flex flex-col items-center justify-center w-10 transition-colors ${activeTab === 'mockup' ? 'text-indigo-600' : 'text-slate-500 hover:text-indigo-600'}`}>
                                                <span className="text-xl leading-none">
                                                    {activeTab === 'mockup' ? (
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                                    ) : (
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                                                    )}
                                                </span>
                                                <span className="text-[9px] mt-0.5 w-14 -ml-2 text-center">{activeTab === 'mockup' ? 'Î™©ÏóÖ ÎÇòÍ∞ÄÍ∏∞' : 'Î™©ÏóÖ'}</span>
                                            </button>
                                        </div>
                                        <div className="flex items-center gap-3 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                                            <button onClick={() => { if(activeTab==='mockup'){ if(mockupSpreadIdx>0) setMockupSpreadIdx(prev=>prev-1); } else { if(currentPageIdx>0) goToPage(currentPageIdx-1); } }} disabled={activeTab==='mockup' ? mockupSpreadIdx===0 : currentPageIdx===0} className="text-slate-400 hover:text-slate-800 disabled:opacity-20 px-1">‚Äπ</button>
                                            <span className="font-serif tabular-nums text-sm w-12 text-center text-slate-700">{activeTab === 'mockup' ? `${mockupSpreadIdx + 1} / ${spreads.length}` : `${currentPageIdx + 1} / ${pages.length}`}</span>
                                            <button onClick={() => { if(activeTab==='mockup'){ if(mockupSpreadIdx<spreads.length-1) setMockupSpreadIdx(prev=>prev+1); } else { if(currentPageIdx<pages.length-1) goToPage(currentPageIdx+1); } }} disabled={activeTab==='mockup' ? mockupSpreadIdx===spreads.length-1 : currentPageIdx===pages.length-1} className="text-slate-400 hover:text-slate-800 disabled:opacity-20 px-1">‚Ä∫</button>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {/* Show 'Ï†ÑÏ≤¥Ï†ÄÏû•' only on PC (not mobile/iPad) */}
                                            {!isMobile() && (
                                                <button onClick={downloadAllSequential} className="bg-slate-100 text-slate-600 px-3 py-2 rounded-lg text-xs font-medium hover:bg-slate-200 transition-colors">Ï†ÑÏ≤¥Ï†ÄÏû•</button>
                                            )}
                                            <button onClick={downloadCurrent} className="bg-slate-800 text-white px-3 py-2 rounded-lg text-xs font-medium hover:bg-slate-700 shadow-sm flex items-center gap-1.5"><span className="text-sm">üì•</span><span>Ï†ÄÏû•</span></button>
                                        </div>
                                    </div>
                                    {/* Row 2: Tabs */}
                                    {activeTab !== 'mockup' && (
                                        <div className="flex border-b border-slate-200 max-w-2xl mx-auto w-full">
                                            <button onClick={() => setActiveTab(activeTab === 'style' ? null : 'style')} className={`flex-1 py-3 text-xs font-medium flex items-center justify-center gap-2 transition-all ${activeTab === 'style' ? 'text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/30' : 'text-slate-500 hover:bg-slate-50'}`}><span>üìÑ Î¨∏ÏÑú ÏÑúÏãù</span></button>
                                            <button onClick={() => setActiveTab(activeTab === 'tool' ? null : 'tool')} className={`flex-1 py-3 text-xs font-medium flex items-center justify-center gap-2 transition-all ${activeTab === 'tool' ? 'text-pink-600 border-b-2 border-pink-600 bg-pink-50/30' : 'text-slate-500 hover:bg-slate-50'}`}><span>üõ† ÎèÑÍµ¨</span></button>
                                        </div>
                                    )}
                                    {/* Row 3: Settings Panel */}
                                    {activeTab === 'style' && activeTab !== 'mockup' && (
                                        <div className="bg-slate-50/80 backdrop-blur-sm border-b border-slate-200 animate-slide-down">
                                            <div className="max-w-2xl mx-auto w-full p-4 flex flex-col gap-5">
                                                <div className="flex items-center justify-center gap-4">
                                                    <span className="text-[10px] tracking-widest text-slate-400 font-bold">THEME</span>
                                                    <div className="flex gap-3">
                                                        {['white', 'cream', 'kraft', 'dark'].map(theme => (
                                                            <button key={theme} onClick={() => setActiveTheme(theme)} className={`circle-btn theme-btn-${theme} ${activeTheme === theme ? 'active shadow-md' : ''}`} title={theme}></button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="h-px bg-slate-200 w-full"></div>
                                                <div className="flex flex-col items-center gap-2">
                                                    <div className="flex items-center gap-4">
                                                        <span className="text-[10px] tracking-widest text-slate-400 font-bold">FONT</span>
                                                        <div className="flex gap-1 bg-white p-1 rounded-lg border border-slate-200">
                                                            {Object.keys(FONT_MAP).map(key => (
                                                                <button key={key} onClick={() => handleFontChangeRequest(key)} className={`px-3 py-1.5 text-xs rounded-md transition-all ${activeFont === key ? 'bg-slate-800 text-white shadow-sm' : 'text-slate-500 hover:bg-slate-100'}`}>{FONT_MAP[key].name}</button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <p className="text-[10px] text-red-400 mt-1">‚ö† ÌòïÍ¥ëÌéúÏù¥ÎÇò Í∏ÄÏî®ÏÉâÏùÑ Ï†ÅÏö©ÌïòÍ∏∞ Ï†ÑÏóê Ìè∞Ìä∏Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {activeTab === 'tool' && activeTab !== 'mockup' && (
                                        <div className="bg-slate-50/80 backdrop-blur-sm border-b border-slate-200 animate-slide-down">
                                            <div className="max-w-2xl mx-auto w-full p-4 flex flex-col items-center gap-3">
                                                <div className="flex bg-slate-200 rounded-lg p-1 mb-1">
                                                    <button onClick={() => { setActiveTab('tool'); setToolMode('highlight'); }} className={`px-3 py-1 text-xs rounded-md transition-all ${toolMode === 'highlight' ? 'bg-white shadow-sm text-slate-800 font-medium' : 'text-slate-500'}`}>üñç ÌòïÍ¥ëÌéú</button>
                                                    <button onClick={() => { setActiveTab('tool'); setToolMode('text'); }} className={`px-3 py-1 text-xs rounded-md transition-all ${toolMode === 'text' ? 'bg-white shadow-sm text-slate-800 font-medium' : 'text-slate-500'}`}>‚úíÔ∏è Í∏ÄÏûêÏÉâ</button>
                                                </div>
                                                <p className="text-[10px] text-slate-500">üí° Tip: Ìè∞Ìä∏Î•º Î®ºÏ†Ä ÌôïÏ†ïÌïú ÌõÑ ÎèÑÍµ¨Î•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.</p>
                                                {toolMode === 'highlight' ? (
                                                    <div className="flex gap-4">
                                                        {['highlight-yellow', 'highlight-pink', 'highlight-mint', 'highlight-blue'].map(color => (
                                                            <button key={color} onClick={() => setCurrentHighlightColor(color)} className={`circle-btn ${color} ${currentHighlightColor === color ? 'border-slate-800 scale-110 shadow-sm' : ''}`}></button>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="flex gap-4">
                                                        {[{ id: 'text-crimson', bg: 'bg-text-crimson' }, { id: 'text-navy', bg: 'bg-text-navy' }, { id: 'text-forest', bg: 'bg-text-forest' }, { id: 'text-purple', bg: 'bg-text-purple' }, { id: 'text-brown', bg: 'bg-text-brown' }, { id: 'text-teal', bg: 'bg-text-teal' }, { id: 'text-gray', bg: 'bg-text-gray' }].map(item => (
                                                            <button key={item.id} onClick={() => setCurrentTextColor(item.id)} className={`circle-btn ${item.bg} ${currentTextColor === item.id ? 'border-slate-800 scale-110 shadow-sm' : ''}`}></button>
                                                        ))}
                                                    </div>
                                                )}
                                                <p className="text-[10px] text-slate-400">ÎìúÎûòÍ∑∏ÌïòÏó¨ Ï†ÅÏö©, ÌÑ∞ÏπòÌïòÏó¨ ÏÇ≠Ï†ú</p>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Viewer Area */}
                                <div className="flex-1 py-8 overflow-auto flex justify-center">
                                    {activeTab === 'mockup' ? (
                                        <div className="mockup-scaler w-full h-full flex items-center justify-center">
                                             <MockupBookRenderer 
                                                spreadIdx={mockupSpreadIdx} spreads={spreads} activeTheme={activeTheme} activeFont={activeFont}
                                                frontFlyleafText={frontFlyleafText} setFrontFlyleafText={setFrontFlyleafText}
                                                backFlyleafText={backFlyleafText} setBackFlyleafText={setBackFlyleafText}
                                                pageHighlights={pageHighlights} pages={pages} metadata={metadata}
                                                onEditFlyleaf={handleFlyleafEdit}
                                            />
                                        </div>
                                    ) : (
                                        <>
                                            {/* Floating Nav Buttons for Desktop */}
                                            {currentPageIdx > 0 && (
                                                <button onClick={(e) => { e.stopPropagation(); goToPage(currentPageIdx - 1); }} className="fixed bottom-6 left-6 w-12 h-12 bg-gray-800/30 hover:bg-gray-800/60 rounded-full flex items-center justify-center text-white backdrop-blur-sm shadow-lg z-50 transition-all">
                                                    <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" /></svg>
                                                </button>
                                            )}
                                            {currentPageIdx < pages.length - 1 && (
                                                <button onClick={(e) => { e.stopPropagation(); goToPage(currentPageIdx + 1); }} className="fixed bottom-6 right-6 w-12 h-12 bg-gray-800/30 hover:bg-gray-800/60 rounded-full flex items-center justify-center text-white backdrop-blur-sm shadow-lg z-50 transition-all">
                                                    <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>
                                                </button>
                                            )}
                                            
                                            <div id="bookViewerWrapper" className="flex justify-center overflow-visible select-text cursor-text" onClick={() => {}}>
                                                <div ref={viewerRef} id="captureTarget" className={`page-container theme-${activeTheme}`} style={{ fontFamily: FONT_MAP[activeFont].family }}>
                                                    <PageContent 
                                                        pageIdx={currentPageIdx} pages={pages} pageHighlights={pageHighlights} metadata={metadata} activeFont={activeFont} 
                                                        onMouseUp={handleHighlightSelection} onClick={handleContentClick} contentRef={desktopContentRef}
                                                    />
                                                    <PageFooter pageIdx={currentPageIdx} metadata={metadata} />
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>



