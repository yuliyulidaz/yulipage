<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Noto Serif KR', serif;
            background-color: #f8f9fa;
        }
        
        .preview-container {
            width: 100%;
            max-width: 105mm; /* A6 Width */
            aspect-ratio: 105/148;
            background: white;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .page-content {
            width: 100%;
            height: 100%;
            padding: 15mm 12mm; /* Margins */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .novel-text {
            font-size: 10.5pt;
            line-height: 1.8;
            text-align: justify;
            white-space: pre-wrap;
            word-break: keep-all;
            overflow: hidden;
        }

        .novel-text p {
            margin-bottom: 0;
            text-indent: 1em;
        }

        .page-header {
            font-size: 8pt;
            color: #888;
            text-align: left;
            margin-bottom: 5mm;
            height: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-footer {
            font-size: 9pt;
            color: #888;
            text-align: center;
            margin-top: 5mm;
        }

        .highlighted {
            background-color: rgba(255, 235, 59, 0.3);
            cursor: pointer;
        }

        .highlighted:hover {
            background-color: rgba(255, 235, 59, 0.5);
        }

        .download-highlighted {
            background-color: transparent !important;
            font-weight: bold;
        }

        .btn {
            transition: all 0.2s;
        }
        .btn:active {
            transform: scale(0.98);
        }

        /* Hide scrollbar for cleaner UI */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #bbb;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div class="container mx-auto px-4 py-8 max-w-3xl">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-end md:items-center border-b pb-4 gap-4">
            <div class="flex items-baseline gap-3">
                <h1 class="text-3xl font-bold text-gray-800">ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸°</h1>
                <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded">A6 ë¬¸ê³ íŒ</span>
            </div>
            <a href="https://yuliyulidaz.github.io/yulilog/" target="_blank" class="flex items-center gap-2 text-sm text-gray-500 hover:text-indigo-600 transition-colors px-3 py-1.5 rounded-full bg-gray-100 hover:bg-indigo-50">
                <span>ë°œì·Œ ë¬¸êµ¬ ìƒì„±ê¸°</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
            </a>
        </header>

        <!-- Input Section -->
        <div id="inputSection" class="space-y-6 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">ì†Œì„¤ ì œëª© (1í˜ì´ì§€ í‘œì‹œ)</label>
                    <input type="text" id="novelTitle" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">í”Œë«í¼ ì•„ì´ì½˜ ì„ íƒ</label>
                    <select id="platformSelect" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all bg-white">
                        <!-- Options populated by JS -->
                    </select>
                    <p class="text-xs text-gray-400 mt-1">* 1í˜ì´ì§€ ì œëª© ìœ„ì— ì‘ê²Œ í‘œì‹œë©ë‹ˆë‹¤ (ìë™ í‘ë°± ì²˜ë¦¬)</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">ì§€ì€ì´ / ìºë¦­í„°</label>
                    <input type="text" id="authorName" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all" placeholder="">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">ì¶œíŒì‚¬ / ì œì‘ì</label>
                    <input type="text" id="publisherName" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all" placeholder="">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-600 mb-2">ë³¸ë¬¸ ë‚´ìš©</label>
                <textarea id="textInput" class="w-full h-64 px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all resize-none font-serif" placeholder="ì—¬ê¸°ì— ì†Œì„¤ ë³¸ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.&#10;ì—”í„°ë¡œ êµ¬ë¶„ëœ ì¤„ì€ ìë™ìœ¼ë¡œ ë¬¸ë‹¨ ë“¤ì—¬ì“°ê¸°ê°€ ì ìš©ë©ë‹ˆë‹¤."></textarea>
            </div>

            <button onclick="startGeneration()" class="btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-lg shadow-md flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                <span>A6 ë ˆì´ì•„ì›ƒ ìƒì„±í•˜ê¸°</span>
            </button>
        </div>

        <!-- Preview Section (Hidden initially) -->
        <div id="previewSection" class="hidden space-y-6">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <button onclick="goBack()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><arrow-left class="w-6 h-6"></arrow-left><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    </button>
                    <div class="flex items-center gap-2">
                        <button onclick="changePage(-1)" class="p-1.5 hover:bg-gray-100 rounded transition-colors disabled:opacity-30" id="prevBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </button>
                        <span class="text-sm font-mono" id="pageIndicator">1 / 5</span>
                        <button onclick="changePage(1)" class="p-1.5 hover:bg-gray-100 rounded transition-colors disabled:opacity-30" id="nextBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="toggleHighlightMode()" id="highlightToggleBtn" class="px-3 py-1.5 text-sm rounded-lg border transition-colors flex items-center gap-2 bg-yellow-50 text-yellow-700 border-yellow-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></svg>
                        <span>í˜•ê´‘íœ ëª¨ë“œ ON</span>
                    </button>
                    <button onclick="downloadCurrentPage()" id="downloadBtn" class="px-4 py-2 bg-gray-800 hover:bg-gray-900 text-white text-sm rounded-lg transition-colors shadow-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        <span>í˜„ì¬ í˜ì´ì§€ ì €ì¥</span>
                    </button>
                </div>
            </div>

            <div class="bg-gray-200 p-8 rounded-xl flex justify-center overflow-auto">
                <div id="previewContainer" class="preview-container">
                    <!-- Content injected by JS -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-8 border-t border-gray-200 text-gray-500 text-xs leading-relaxed">
            <div class="mb-4">
                <h3 class="font-bold text-gray-700 mb-1">ğŸ“– ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸° v1.0.0</h3>
                <p>ë³¸ ì‚¬ì´íŠ¸ëŠ” ì–´ë– í•œ ê°œì¸ì •ë³´ë„ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ëª¨ë“  ì‘ì—…ì€ ê·€í•˜ì˜ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</p>
            </div>
            <div class="mb-4">
                <strong class="text-gray-600 block mb-1">âš ï¸ ì´ìš© ì‹œ ì£¼ì˜ì‚¬í•­</strong>
                <ul class="list-disc pl-4 space-y-1">
                    <li>í…ìŠ¤íŠ¸ ì¸ìš©: ì±…ì´ë‚˜ ê¸°íƒ€ ì €ì‘ë¬¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ë°œì·Œí•  ê²½ìš°, ì €ì‘ê¶Œë²•ìƒ í—ˆìš© ë²”ìœ„ ë‚´ì—ì„œ ì‚¬ìš©í•˜ê³  ì¶œì²˜ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.</li>
                    <li>í”Œë«í¼ ë¡œê³ : ê° í”Œë«í¼ì˜ ë¡œê³ ëŠ” í•´ë‹¹ í”Œë«í¼ì˜ ìƒí‘œì´ë©°, ì‚¬ìš© ì‹œ ê° í”Œë«í¼ì˜ ë¸Œëœë“œ ê°€ì´ë“œë¼ì¸ì„ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                    <li>ìƒì—…ì  ì´ìš©: ìƒì„±ëœ ì´ë¯¸ì§€ëŠ” ìƒì—…ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
                </ul>
            </div>
            <div>
                <p>ë³¸ ë„êµ¬ì˜ ì œì‘ìëŠ” ì‚¬ìš©ìê°€ ìƒì„±í•œ ì½˜í…ì¸ ì— ëŒ€í•´ ì–´ë– í•œ ì±…ì„ë„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ì´ë¯¸ì§€ ë° í…ìŠ¤íŠ¸ ì‚¬ìš©ìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ëª¨ë“  ë²•ì  ë¬¸ì œëŠ” ì‚¬ìš©ì ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤.</p>
            </div>
        </footer>
    </div>

    <script>
        // Global State
        let pages = [];
        let currentPageIdx = 0;
        let pageHighlights = {}; // Stores highlight indices per page: { pageIdx: [wordIdx, wordIdx...] }
        let isHighlightMode = true;
        let cachedFontEmbedCSS = null;

        // Platform Icons Configuration
        const platformIcons = {
            "ì„ íƒ ì•ˆí•¨": "",
            "ë„í‚¤ì±—": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/dokichat.jpg",
            "ëŸ¬ë¹„ë”ë¹„": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/LoveyDovey.jpg",
            "ë ˆí”Œë¦¬": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/reppley.jpg",
            "ë¡œë§¨í‹±í”Œë ˆì´": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/rplay.png",
            "ë¡œíŒAI": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/rofan.png",
            "ë©œíŒ…": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/melting.jpg",
            "ë¸”ë£¸": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/bloom.jpg",
            "ì‰í¬ì±—": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/inkchat.jpg",
            "ì œíƒ€": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/zeta.jpg",
            "ìºëŸ¿": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/carat.png",
            "ì¼€ë°": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/chemi.png",
            "ì¼€ì´ë¸Œë•": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/Caveduck.jpg",
            "í¬ë™": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/crack.png",
            "í„ìŠ¤": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/pulse.jpg",
            "í”¼ì¦ˆì±—": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/Fizzchat.png",
            "WHIF": "https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/whif.jpg"
        };

        // Initialize Platform Select
        window.onload = function() {
            const select = document.getElementById('platformSelect');
            for (const [name, url] of Object.entries(platformIcons)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            }
        };

        // --- í•µì‹¬ ë¡œì§: í˜ì´ì§€ ë¶„í•  ì—”ì§„ ---
        function startGeneration() {
            const text = document.getElementById('textInput').value;
            const novelTitle = document.getElementById('novelTitle').value;
            
            if (!text.trim()) {
                alert("ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            document.querySelector('.btn span').textContent = "ìƒì„± ì¤‘...";
            
            setTimeout(() => {
                pageHighlights = {}; 
                cachedFontEmbedCSS = null; // ìºì‹œ ì´ˆê¸°í™”
                pages = splitTextIntoPages(text, novelTitle);
                currentPageIdx = 0;
                
                document.getElementById('inputSection').classList.add('hidden');
                document.getElementById('previewSection').classList.remove('hidden');
                document.querySelector('.btn span').textContent = "A6 ë ˆì´ì•„ì›ƒ ìƒì„±í•˜ê¸°";
                
                isHighlightMode = true;
                updateHighlightUI();
                updateDownloadButtonText(); // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                
                renderCurrentPage();

                // ìŠ¤í¬ë¡¤ ìµœìƒë‹¨ìœ¼ë¡œ ì´ë™
                window.scrollTo(0, 0);
            }, 50);
        }

        function splitTextIntoPages(fullText, title) {
            // A6 Size (105mm x 148mm)
            // Margins: Top 15mm, Bottom 15mm, Left/Right 12mm
            // Content Width ~ 81mm
            // Font: 10.5pt (~3.7mm height with 1.8 line-height -> ~6.6mm per line)
            // Content Height: 118mm
            // Lines per page: approx 16-18 lines depending on title/spacing
            
            // Simple greedy algorithm for text splitting
            // In a real browser env, we need to measure elements.
            // Here we use a hidden container to measure text flow.
            
            const container = document.createElement('div');
            container.style.width = '81mm'; // 105 - 24
            container.style.visibility = 'hidden';
            container.style.position = 'absolute';
            container.style.fontFamily = "'Noto Serif KR', serif";
            container.style.fontSize = '10.5pt';
            container.style.lineHeight = '1.8';
            container.style.textAlign = 'justify';
            container.className = 'novel-text';
            document.body.appendChild(container);

            const MAX_HEIGHT_PX = 118 * 3.7795275591; // mm to px approx
            // Adjust pixels for screen resolution (96dpi) -> 1mm ~ 3.78px
            // 118mm ~ 446px available height
            
            // Split by paragraphs
            const paragraphs = fullText.split('\n');
            
            let pages = [];
            let currentPageContent = [];
            let currentHeight = 0;
            
            // Helper to measure paragraph height
            const measurePara = (text, isIndent = true) => {
                const p = document.createElement('p');
                p.textContent = text;
                if (isIndent) p.style.textIndent = '1em';
                p.style.margin = '0';
                container.innerHTML = '';
                container.appendChild(p);
                return container.offsetHeight;
            };

            // If title is present, first page has title
            // Title height approx: font-size * 1.5 + margin
            // Let's simply reduce available height for page 1 if title exists
            let availableHeight = MAX_HEIGHT_PX;
            if (title && title.trim()) {
                // Give some space for title header on page 1
                availableHeight -= 60; // Rough estimate for title spacing
            }

            paragraphs.forEach((para, idx) => {
                if (!para.trim()) {
                    // Empty line (margin)
                    currentHeight += 20; // height of empty line
                } else {
                    let paraHeight = measurePara(para);
                    
                    if (currentHeight + paraHeight > availableHeight) {
                        // If paragraph is too long to fit at all, we should split it (complex)
                        // For MVP, we push to next page
                        if (currentPageContent.length > 0) {
                            pages.push(currentPageContent);
                            currentPageContent = [];
                            currentHeight = 0;
                            availableHeight = MAX_HEIGHT_PX; // Reset for next pages
                        }
                        
                        // Re-measure in case it's still too large (splitting long paragraph logic omitted for simplicity)
                        // Ideally we split the paragraph word by word.
                        // Let's just push it now.
                        currentPageContent.push({ type: 'p', text: para });
                        currentHeight += paraHeight;
                    } else {
                        currentPageContent.push({ type: 'p', text: para });
                        currentHeight += paraHeight;
                    }
                }
            });

            if (currentPageContent.length > 0) {
                pages.push(currentPageContent);
            }

            document.body.removeChild(container);
            return pages;
        }

        function renderCurrentPage() {
            const container = document.getElementById('previewContainer');
            const pageData = pages[currentPageIdx];
            
            if (!pageData) {
                container.innerHTML = '';
                return;
            }

            // Header
            const title = document.getElementById('novelTitle').value;
            const platformName = document.getElementById('platformSelect').value;
            const iconUrl = platformIcons[platformName];
            
            let headerHTML = '';
            
            // Page 1 Header Logic
            if (currentPageIdx === 0) {
                // Platform Icon (Grayscale)
                let iconHTML = '';
                if (iconUrl) {
                    // Use mix-blend-mode or filter for grayscale
                    iconHTML = `<img src="${iconUrl}" style="height: 16px; width: auto; filter: grayscale(100%); opacity: 0.7; margin-right: 6px;" alt="icon">`;
                }
                
                if (title) {
                    headerHTML = `
                        <div class="page-header" style="justify-content: flex-start; margin-bottom: 2mm;">
                            ${iconHTML}
                            <span>${platformName !== 'ì„ íƒ ì•ˆí•¨' ? platformName : ''}</span>
                        </div>
                        <div style="text-align: center; margin-bottom: 8mm;">
                            <h2 style="font-size: 14pt; font-weight: 600; margin-bottom: 2mm;">${title}</h2>
                            <div style="font-size: 9pt; color: #666;">
                                ${document.getElementById('authorName').value ? document.getElementById('authorName').value : ''}
                                ${document.getElementById('publisherName').value ? ' / ' + document.getElementById('publisherName').value : ''}
                            </div>
                        </div>
                    `;
                }
            } else {
                // Normal Header for other pages
                headerHTML = `
                    <div class="page-header" style="justify-content: space-between;">
                        <span>${title || ''}</span>
                        <span></span> 
                    </div>
                `;
            }

            // Content
            let contentHTML = '<div class="novel-text">';
            pageData.forEach((item, itemIdx) => {
                if (item.type === 'p') {
                    // Split paragraph into spans for highlighting
                    const words = item.text.split(''); // char by char for precision or word by word?
                    // Let's do simplistic word/segment splitting for highlighting
                    // Actually, character level is best for Korean.
                    const chars = item.text.split('').map((char, charIdx) => {
                        const globalIdx = `${currentPageIdx}-${itemIdx}-${charIdx}`;
                        const isHighlighted = pageHighlights[currentPageIdx] && pageHighlights[currentPageIdx].has(globalIdx);
                        return `<span class="${isHighlighted ? 'highlighted' : ''}" onclick="toggleHighlight('${globalIdx}')">${char}</span>`;
                    }).join('');
                    
                    contentHTML += `<p>${chars}</p>`;
                }
            });
            contentHTML += '</div>';

            // Footer (Page Number)
            const footerHTML = `
                <div class="page-footer">
                    - ${currentPageIdx + 1} -
                </div>
            `;

            container.innerHTML = `
                <div class="page-content">
                    <div>
                        ${headerHTML}
                        ${contentHTML}
                    </div>
                    ${footerHTML}
                </div>
            `;
            
            // Update UI controls
            document.getElementById('pageIndicator').textContent = `${currentPageIdx + 1} / ${pages.length}`;
            document.getElementById('prevBtn').disabled = currentPageIdx === 0;
            document.getElementById('nextBtn').disabled = currentPageIdx === pages.length - 1;
            
            updateDownloadButtonText();
        }

        function toggleHighlight(id) {
            if (!isHighlightMode) return;
            
            if (!pageHighlights[currentPageIdx]) {
                pageHighlights[currentPageIdx] = new Set();
            }
            
            if (pageHighlights[currentPageIdx].has(id)) {
                pageHighlights[currentPageIdx].delete(id);
            } else {
                pageHighlights[currentPageIdx].add(id);
            }
            
            renderCurrentPage();
        }

        function toggleHighlightMode() {
            isHighlightMode = !isHighlightMode;
            updateHighlightUI();
        }

        function updateHighlightUI() {
            const btn = document.getElementById('highlightToggleBtn');
            if (isHighlightMode) {
                btn.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
                btn.classList.add('bg-yellow-50', 'text-yellow-700', 'border-yellow-200');
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></svg>
                    <span>í˜•ê´‘íœ ëª¨ë“œ ON</span>
                `;
                document.getElementById('previewContainer').style.cursor = 'text';
            } else {
                btn.classList.remove('bg-yellow-50', 'text-yellow-700', 'border-yellow-200');
                btn.classList.add('bg-gray-50', 'text-gray-600', 'border-gray-200');
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="2" x2="22" y2="22"></line><path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></svg>
                    <span>í˜•ê´‘íœ ëª¨ë“œ OFF</span>
                `;
                document.getElementById('previewContainer').style.cursor = 'default';
            }
        }

        function changePage(delta) {
            const newIdx = currentPageIdx + delta;
            if (newIdx >= 0 && newIdx < pages.length) {
                currentPageIdx = newIdx;
                renderCurrentPage();
            }
        }

        function goBack() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            document.querySelector('.btn span').textContent = "A6 ë ˆì´ì•„ì›ƒ ìƒì„±í•˜ê¸°";
        }
        
        function updateDownloadButtonText() {
            const btnText = document.getElementById('downloadBtn').querySelector('span');
            const hasHighlights = pageHighlights[currentPageIdx] && pageHighlights[currentPageIdx].size > 0;
            
            if (hasHighlights) {
                btnText.textContent = "í˜„ì¬ í˜ì´ì§€ ì €ì¥ (í˜•ê´‘íœ ì œì™¸)";
            } else {
                btnText.textContent = "í˜„ì¬ í˜ì´ì§€ ì €ì¥";
            }
        }

        function downloadCurrentPage() {
            const container = document.getElementById('previewContainer');
            
            // Temporarily remove highlight classes for clean capture
            // Actually, users usually want to capture WITH highlights if they added them, 
            // BUT the prompt implied they might want to choose? 
            // The previous logic (btn text) suggests "Save (Excluding Highlights)" implies we should strip them.
            // Let's stick to the implied logic: If highlights exist, we remove them for the "clean" version, 
            // or we could offer two buttons.
            // Given the button text "í˜„ì¬ í˜ì´ì§€ ì €ì¥ (í˜•ê´‘íœ ì œì™¸)", we must hide highlights.
            
            const highlights = container.querySelectorAll('.highlighted');
            highlights.forEach(el => el.classList.add('download-highlighted')); // Add class that overrides bg color

            html2canvas(container, {
                scale: 3, // High res
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                // Restore highlights
                highlights.forEach(el => el.classList.remove('download-highlighted'));

                const link = document.createElement('a');
                link.download = `novel_page_${currentPageIdx + 1}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>
</body>
</html>
