<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸° (A6 ë¬¸ê³ íŒ)</title>
    
    <!-- 1. Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400;500&display=swap" rel="stylesheet">
    
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 3. Libraries (React, ReactDOM, Babel, html-to-image) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"></script>

    <style>
        /* í°íŠ¸ ê°•ì œ ì ìš© */
        * {
            font-family: 'Noto Serif KR', serif !important;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            background: #f0f2f5;
            color: #1a1a1a;
            overscroll-behavior: none; /* ìŠ¤í¬ë¡¤ íŠ•ê¹€ ë°©ì§€ */
        }

        /* í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .highlight {
            display: inline;
            background: rgba(255, 235, 59, 0.4);
            padding: 0;
            margin: 0;
            line-height: normal;
            vertical-align: baseline;
            border: none;
            outline: none;
            cursor: pointer;
        }
        
        .highlight-yellow { background: rgba(255, 235, 59, 0.4); }
        .highlight-pink { background: rgba(255, 182, 193, 0.4); }
        .highlight-mint { background: rgba(178, 255, 222, 0.4); }
        .highlight-blue { background: rgba(173, 216, 230, 0.4); }

        /* í™”ë©´ìš© ìŠ¤íƒ€ì¼ - A6 ë¹„ìœ¨ (105:148) */
        .page-container {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: white;
            margin: 0 auto;
            width: 420px;  
            /* [ì¤‘ìš”] ëª¨ë°”ì¼ì—ì„œ í™”ë©´ í­ì´ ì¢ì•„ë„ ì ˆëŒ€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ê°•ì œ */
            min-width: 420px; 
            flex-shrink: 0;
            
            height: 600px; 
            /* í•˜ë‹¨ ì—¬ë°± 50pxë¡œ í˜ì´ì§€ ë²ˆí˜¸ ìœ„ì¹˜ í™•ë³´ */
            padding: 60px 60px 50px 60px; 
            position: relative;
            display: flex;
            flex-direction: column;
            transform-origin: top center;
        }

        .page-content {
            height: 460px; 
            overflow: hidden;
            font-size: 12px;
            line-height: 1.8 !important;
            text-align: justify;
            letter-spacing: -0.02em;
            word-break: break-all;
            overflow-wrap: anywhere;
            font-weight: 300;
            cursor: text;
        }

        /* ë¬¸ë‹¨ ìŠ¤íƒ€ì¼ */
        .page-content p {
            margin-bottom: 0;
            padding: 0;
            text-indent: 1em;
            line-height: 1.8 !important;
        }

        /* ì´ì–´ì§„ ë¬¸ë‹¨ */
        .page-content p.continued {
            text-indent: 0 !important;
        }
        
        .page-footer-area {
            height: 30px;
            margin-top: auto;
            display: flex;
            align-items: flex-end;
            padding-bottom: 0px;
        }

        /* ì…ë ¥ í™”ë©´ */
        .input-area {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        /* ì¸¡ì •ìš© ìˆ¨ê²¨ì§„ ë°•ìŠ¤ */
        .hidden-measure {
            position: absolute;
            visibility: hidden;
            top: -9999px;
            left: -9999px;
            width: 300px; 
            font-family: 'Noto Serif KR', serif;
            font-size: 12px;
            line-height: 1.8 !important;
            text-align: justify;
            letter-spacing: -0.02em;
            word-break: break-all;
            overflow-wrap: anywhere;
            font-weight: 300;
        }
        
        .hidden-measure p {
            margin-bottom: 0;
            line-height: 1.8 !important;
        }

        /* ìƒ‰ìƒ ì„ íƒ ë²„íŠ¼ */
        .color-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active { border-color: #333; transform: scale(1.1); }

        /* ìœ í‹¸ë¦¬í‹° */
        .btn {
            transition: all 0.2s;
        }
        .btn:active {
            transform: scale(0.98);
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 450px) {
            #bookViewerWrapper {
                transform: scale(0.85);
                transform-origin: top center;
                /* scaleë¡œ ì¸í•´ ì¤„ì–´ë“  ë§Œí¼ ë†’ì´ ê³µê°„ë„ ì¡°ì • */
                height: 520px; 
            }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "html-to-image": "https://aistudiocdn.com/html-to-image@^1.11.13"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
        const { useState, useRef, useEffect } = React;

        // ----------------------------------------------------------------------
        // 1. Utils & Helpers
        // ----------------------------------------------------------------------

        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        function isAndroid() {
            return /Android/i.test(navigator.userAgent);
        }

        // í°íŠ¸ ë¡œë”© í™•ì¸ ë° ë”œë ˆì´
        async function ensureFontsLoaded() {
            console.log('[í°íŠ¸] ë¡œë“œ ìƒíƒœ í™•ì¸ ì¤‘...');
            try {
                await document.fonts.ready;
            } catch (e) {
                console.warn('í°íŠ¸ API í™•ì¸ ì‹¤íŒ¨', e);
            }
            // [ì¤‘ìš”] ì•„ì´íŒ¨ë“œ í°íŠ¸ ì ìš©ì„ ìœ„í•´ ëŒ€ê¸° ì‹œê°„ ì¦ê°€ (300ms -> 800ms)
            await new Promise(resolve => setTimeout(resolve, 800));
        }

        let cachedFontEmbedCSS = null;
        
        // êµ¬ê¸€ í°íŠ¸ë¥¼ Base64ë¡œ ë³€í™˜í•˜ì—¬ CSS ìƒì„± (CORS/ë¡œë”© ì´ìŠˆ í•´ê²°)
        async function prepareFontEmbedCSS() {
            if (cachedFontEmbedCSS) return cachedFontEmbedCSS;
            
            console.log('[í°íŠ¸] Base64 ì„ë² ë“œ CSS ìƒì„± ì‹œì‘...');
            try {
                const cssUrl = 'https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400;500&display=swap';
                const cssRes = await fetch(cssUrl);
                let cssText = await cssRes.text();

                const urlRegex = /url\(([^)]+)\)/g;
                let match;
                const replacements = [];

                while ((match = urlRegex.exec(cssText)) !== null) {
                    const fullUrl = match[1].replace(/['"]/g, ''); 
                    replacements.push({ original: match[0], url: fullUrl });
                }

                await Promise.all(replacements.map(async (item) => {
                    try {
                        const fontRes = await fetch(item.url);
                        const fontBlob = await fontRes.blob();
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                cssText = cssText.replace(item.url, reader.result);
                                resolve();
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(fontBlob);
                        });
                    } catch (e) {
                        console.warn('ê°œë³„ í°íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', item.url, e);
                    }
                }));

                cachedFontEmbedCSS = cssText;
                return cssText;
            } catch (e) {
                console.error('[í°íŠ¸] ìˆ˜ë™ ì„ë² ë“œ ìƒì„± ì‹¤íŒ¨:', e);
                return null;
            }
        }

        // ----------------------------------------------------------------------
        // 2. Application Component
        // ----------------------------------------------------------------------

        const PAGE_CONTENT_HEIGHT = 460;
        const BOTTOM_BUFFER_P1 = 15;

        function App() {
            // -- State --
            const [step, setStep] = useState('input'); // 'input' | 'preview'
            const [textInput, setTextInput] = useState('');
            const [metadata, setMetadata] = useState({
                title: '',
                iconUrl: '',
                author: '',
                producer: ''
            });
            
            const [pages, setPages] = useState([]);
            const [currentPageIdx, setCurrentPageIdx] = useState(0);
            const [pageHighlights, setPageHighlights] = useState({});
            
            // [iOS Fix] Store Base64 icon
            const [currentIconBase64, setCurrentIconBase64] = useState(null);
            
            const [isHighlightMode, setIsHighlightMode] = useState(false);
            const [currentHighlightColor, setCurrentHighlightColor] = useState('highlight-yellow');
            
            const [isGenerating, setIsGenerating] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [loadingProgress, setLoadingProgress] = useState(0);

            const measureContainerRef = useRef(null);
            const viewerRef = useRef(null);
            const contentRef = useRef(null);

            // -- Logic: Pagination --
            const findSplitIndex = (text, maxHeight, isContinued) => {
                const measureBox = measureContainerRef.current;
                if (!measureBox) return 0;
                
                const tempP = document.createElement('p');
                tempP.style.lineHeight = "1.8";
                tempP.style.marginBottom = "0";
                
                if (isContinued) tempP.classList.add('continued');
                else tempP.style.textIndent = '1em';
                
                measureBox.appendChild(tempP);
                
                let low = 0;
                let high = text.length;
                let bestIdx = 0;

                while (low <= high) {
                    const mid = Math.floor((low + high) / 2);
                    const subText = text.substring(0, mid);
                    tempP.textContent = subText;
                    
                    if (tempP.offsetHeight <= maxHeight) {
                        bestIdx = mid;
                        low = mid + 1;
                    } else {
                        high = mid - 1;
                    }
                }
                
                measureBox.removeChild(tempP);
                return bestIdx;
            };

            // [iOS Fix] Helper to convert URL to Base64
            const convertIconToBase64 = async (url) => {
                if (!url) return '';
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (e) {
                    console.error("ì•„ì´ì½˜ ë³€í™˜ ì‹¤íŒ¨:", e);
                    return url; // Fallback to original URL
                }
            };

            const startGeneration = async () => {
                if (!textInput.trim()) {
                    alert("ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                // [Keyboard Fix] Blur active element to dismiss keyboard
                if (document.activeElement instanceof HTMLElement) {
                    document.activeElement.blur();
                }

                setIsGenerating(true);
                
                // [iOS Fix] Pre-fetch icon
                if (metadata.iconUrl) {
                    try {
                        const base64Icon = await convertIconToBase64(metadata.iconUrl);
                        setCurrentIconBase64(base64Icon);
                    } catch (e) {
                        setCurrentIconBase64(null);
                    }
                } else {
                    setCurrentIconBase64(null);
                }
                
                // setTimeout to allow UI update and keyboard dismissal
                setTimeout(() => {
                    const resultPages = [];
                    const measureBox = measureContainerRef.current;
                    
                    if (!measureBox) {
                        setIsGenerating(false);
                        return;
                    }

                    const rawParagraphs = textInput.split('\n').filter(p => p.trim().length > 0);
                    let currentParagraphs = [];
                    let pageNum = 1;
                    
                    let queue = rawParagraphs.map(text => ({ text: text, isContinued: false }));

                    measureBox.innerHTML = ''; 
                    
                    // 1í˜ì´ì§€ ì œëª© ì˜ì—­ í™•ë³´
                    if (metadata.title && pageNum === 1) {
                        const titlePlaceholder = document.createElement('div');
                        titlePlaceholder.style.height = "200px";
                        titlePlaceholder.style.width = "100%";
                        titlePlaceholder.style.marginBottom = "0"; 
                        measureBox.appendChild(titlePlaceholder);
                    }

                    while (queue.length > 0) {
                        const item = queue.shift();
                        
                        const p = document.createElement('p');
                        p.textContent = item.text;
                        p.style.lineHeight = "1.8";
                        p.style.marginBottom = "0";
                        
                        if (item.isContinued) p.classList.add('continued');
                        else p.style.textIndent = '1em';

                        measureBox.appendChild(p);
                        
                        const currentHeight = measureBox.scrollHeight;
                        const currentBuffer = (pageNum === 1) ? BOTTOM_BUFFER_P1 : 0;
                        const limitHeight = PAGE_CONTENT_HEIGHT - currentBuffer;

                        if (currentHeight <= limitHeight) {
                            currentParagraphs.push({
                                text: item.text,
                                isContinued: item.isContinued
                            });
                        } 
                        else {
                            measureBox.removeChild(p); 
                            
                            const currentBaseHeight = measureBox.scrollHeight;
                            const availableHeight = limitHeight - currentBaseHeight;

                            if (availableHeight < 18) {
                                queue.unshift(item);
                            } else {
                                const splitIdx = findSplitIndex(item.text, availableHeight, item.isContinued);
                                
                                if (splitIdx > 0) {
                                    const partA = item.text.substring(0, splitIdx);
                                    const partB = item.text.substring(splitIdx);

                                    currentParagraphs.push({
                                        text: partA,
                                        isContinued: item.isContinued
                                    });

                                    if (partB.length > 0) {
                                        queue.unshift({
                                            text: partB,
                                            isContinued: true
                                        });
                                    }
                                } else {
                                    queue.unshift(item);
                                }
                            }

                            resultPages.push({ paragraphs: currentParagraphs });
                            currentParagraphs = [];
                            
                            pageNum++;
                            measureBox.innerHTML = '';
                        }
                    }

                    if (currentParagraphs.length > 0) {
                        resultPages.push({ paragraphs: currentParagraphs });
                    }

                    setPages(resultPages);
                    setCurrentPageIdx(0);
                    setPageHighlights({});
                    setStep('preview');
                    setIsHighlightMode(true); // Default on
                    setIsGenerating(false);
                    
                    // Scroll to top
                    setTimeout(() => window.scrollTo(0, 0), 100);
                }, 400); // Increased delay for keyboard
            };

            // -- Logic: Highlights --
            const saveCurrentPageState = () => {
                if (contentRef.current && viewerRef.current) {
                     setPageHighlights(prev => ({
                         ...prev,
                         [currentPageIdx]: viewerRef.current.innerHTML
                     }));
                }
            };

            const handleHighlightSelection = () => {
                if (!isHighlightMode) return;

                const selection = window.getSelection();
                if (!selection || !selection.rangeCount || selection.toString().trim() === '') return;

                const range = selection.getRangeAt(0);
                if (!contentRef.current || !contentRef.current.contains(range.commonAncestorContainer)) return;

                try {
                    const span = document.createElement('span');
                    span.className = `highlight ${currentHighlightColor}`;
                    
                    // í´ë¦­ ì‹œ ì‚­ì œ ì´ë²¤íŠ¸
                    span.onclick = (e) => {
                        e.stopPropagation();
                        if (!isHighlightMode) return;
                        const text = span.textContent || '';
                        const textNode = document.createTextNode(text);
                        span.parentNode.replaceChild(textNode, span);
                        saveCurrentPageState();
                    };
                    
                    range.surroundContents(span);
                    selection.removeAllRanges();
                    saveCurrentPageState();
                } catch (e) {
                    // Cross-paragraph selection not supported simply
                    console.log("ë³µì¡í•œ ì„ íƒ ì˜ì—­ì…ë‹ˆë‹¤. ë‹¨ì¼ ë¬¸ë‹¨ ë‚´ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
                }
            };

            useEffect(() => {
                if (step === 'preview' && contentRef.current) {
                     const spans = contentRef.current.querySelectorAll('.highlight');
                     spans.forEach(span => {
                         span.onclick = (e) => {
                            e.stopPropagation();
                            if (!isHighlightMode) return;
                            const target = e.target;
                            const text = target.textContent || '';
                            const textNode = document.createTextNode(text);
                            target.parentNode.replaceChild(textNode, target);
                            saveCurrentPageState();
                         };
                     });
                }
            });

            // -- Logic: Navigation --
            const goToPage = (idx) => {
                saveCurrentPageState();
                setCurrentPageIdx(idx);
            };

            const backToEdit = () => {
                if (window.confirm('í˜•ê´‘íœì´ ëª¨ë‘ ì§€ì›Œì§‘ë‹ˆë‹¤. ìˆ˜ì • í™”ë©´ìœ¼ë¡œ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    setStep('input');
                    // Keep textInput and metadata
                    setPages([]);
                    setPageHighlights({});
                    setCurrentPageIdx(0);
                    window.scrollTo(0, 0);
                }
            };

            const resetApp = () => {
                if (window.confirm('ì‘ì—… ë‚´ìš©ì„ ì§€ìš°ê³  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    setStep('input');
                    setPages([]);
                    setPageHighlights({});
                    setTextInput('');
                    setMetadata({ ...metadata, title: '', author: '', producer: '', iconUrl: '' });
                    window.scrollTo(0, 0);
                }
            };

            // -- Logic: Download --
            const downloadBlobFallback = (blob, fileName) => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = fileName;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            };

            const downloadCurrentPage = async () => {
                const target = document.getElementById('captureTarget');
                if (!target) return;

                const title = metadata.title || 'novel';
                const fileName = `${title}_${currentPageIdx + 1}p.png`;

                setLoadingMessage('ìƒì„± ì¤‘...');
                
                try {
                    // 1. í°íŠ¸ ë¡œë”© í™•ì¸
                    await ensureFontsLoaded();
                    
                    // 2. CSS ì¤€ë¹„
                    const fontEmbedCSS = await prepareFontEmbedCSS();

                    // 3. [ì¤‘ìš”] ì•„ì´íŒ¨ë“œ/PC ë“± ê³ í•´ìƒë„ ë° ë ˆì´ì•„ì›ƒ ì•ˆì •í™”ë¥¼ ìœ„í•œ ì¶”ê°€ ëŒ€ê¸°
                    // PC White Screen Fix(margin reset) ì ìš© í›„ ë Œë”ë§ ì•ˆì •í™” ì‹œê°„ í™•ë³´
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const options = {
                        quality: 1.0,
                        pixelRatio: 2,
                        cacheBust: true,
                        backgroundColor: '#ffffff',
                        preferredFontFormat: 'woff2',
                        skipFonts: true, // Use embedded CSS instead
                        // [FIX] PC/iPad White Screen Fix: Explicit dimensions & Reset margin
                        width: 420,
                        height: 600,
                        style: {
                            fontFamily: '"Noto Serif KR", serif',
                            letterSpacing: '-0.02em',
                            margin: '0',       // Reset centering
                            transform: 'none', // Reset transforms
                            left: 'auto',
                            right: 'auto',
                            top: 'auto',
                            bottom: 'auto'
                        }
                    };
                    if (fontEmbedCSS) options.fontEmbedCSS = fontEmbedCSS;

                    const blob = await htmlToImage.toBlob(target, options);
                    if (!blob) throw new Error('Blob creation failed');

                    if (isIOS() && navigator.share && navigator.canShare) {
                        const file = new File([blob], fileName, { type: 'image/png' });
                        if (navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({ files: [file], title: fileName });
                            } catch (shareError) {
                                if (shareError.name !== 'AbortError') {
                                    downloadBlobFallback(blob, fileName);
                                }
                            }
                        } else {
                            downloadBlobFallback(blob, fileName);
                        }
                    } else {
                        downloadBlobFallback(blob, fileName);
                    }

                } catch (error) {
                    console.error('[ë‹¤ìš´ë¡œë“œ] ì‹¤íŒ¨:', error);
                    alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    setLoadingMessage('');
                }
            };

            const downloadAllPages = async () => {
                if (isIOS() || isAndroid()) {
                    alert('ëª¨ë°”ì¼ í™˜ê²½ì—ì„œëŠ” ì „ì²´ ì €ì¥ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                if (!window.confirm(`ì´ ${pages.length}ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.`)) return;

                saveCurrentPageState();
                const originalPageIdx = currentPageIdx;
                window.scrollTo(0, 0);
                setLoadingMessage('ì¤€ë¹„ ì¤‘...');
                
                try {
                    await ensureFontsLoaded();
                    const fontEmbedCSS = await prepareFontEmbedCSS();

                    for (let i = 0; i < pages.length; i++) {
                        setCurrentPageIdx(i);
                        // Wait for render
                        await new Promise(resolve => setTimeout(resolve, 500)); // Increased for safety
                        setLoadingMessage(`ì €ì¥ ì¤‘... (${i + 1}/${pages.length})`);
                        setLoadingProgress(Math.floor(((i + 1) / pages.length) * 100));

                        const target = document.getElementById('captureTarget');
                        if (target) {
                            const options = {
                                quality: 1.0,
                                pixelRatio: 2,
                                cacheBust: true,
                                backgroundColor: '#ffffff',
                                skipFonts: true,
                                // [FIX] PC/iPad White Screen Fix: Explicit dimensions & Reset margin
                                width: 420,
                                height: 600,
                                style: {
                                    fontFamily: '"Noto Serif KR", serif',
                                    margin: '0',
                                    transform: 'none',
                                    left: 'auto',
                                    right: 'auto'
                                }
                            };
                            if (fontEmbedCSS) options.fontEmbedCSS = fontEmbedCSS;

                            const blob = await htmlToImage.toBlob(target, options);
                            if (blob) {
                                 const fileName = `${metadata.title || 'novel'}_${String(i+1).padStart(3, '0')}p.png`;
                                 downloadBlobFallback(blob, fileName);
                            }
                            // Delay to prevent browser choking
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    }
                    alert("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) {
                    console.error(e);
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                } finally {
                    setLoadingMessage('');
                    setLoadingProgress(0);
                    setCurrentPageIdx(originalPageIdx);
                }
            };

            // -- Render Helpers --
            // ì•„ì´ì½˜ ìœ„ì¹˜ ê²°ì •
            const getIconStyle = () => {
                if (metadata.title && metadata.title.trim().length > 0) {
                    // ì œëª© ìˆìŒ: ìƒë‹¨ ì¤‘ì•™ (ê¸°ì¡´)
                    return {
                        position: 'absolute',
                        top: '50px',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        width: '30px',
                        height: '30px',
                        objectFit: 'cover',
                        borderRadius: '50%',
                        filter: 'grayscale(100%)',
                        opacity: 0.8,
                        zIndex: 10
                    };
                } else {
                    // ì œëª© ì—†ìŒ: ì¢Œì¸¡ í•˜ë‹¨ (ìˆ˜ì •ë¨: 10px ë” ìœ„ë¡œ)
                    return {
                        position: 'absolute',
                        bottom: '55px', // ê¸°ì¡´ 35px -> 45px -> 55pxë¡œ ì¡°ì •
                        left: '60px',
                        width: '30px',
                        height: '30px',
                        objectFit: 'cover',
                        borderRadius: '50%',
                        filter: 'grayscale(100%)',
                        opacity: 0.8,
                        zIndex: 10
                    };
                }
            };

            // -- Render --
            return (
                <div className="min-h-screen font-serif">
                    {/* Measurement Container (Hidden) */}
                    <div ref={measureContainerRef} className="hidden-measure"></div>

                    {/* Loading Overlay */}
                    {loadingMessage && (
                        <div className="fixed inset-0 bg-black/70 text-white flex flex-col items-center justify-center z-[9999]">
                            <div className="text-2xl mb-4">{loadingMessage.includes('ì €ì¥ ì¤‘') ? 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...' : loadingMessage}</div>
                            {loadingProgress > 0 && (
                                <div className="text-sm opacity-80">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” ({loadingProgress}%)</div>
                            )}
                        </div>
                    )}

                    {/* STEP 1: INPUT */}
                    {step === 'input' && (
                        <div className="max-w-[900px] mx-auto my-10 bg-white p-10 rounded-2xl shadow-sm">
                            <div className="flex items-center justify-between mb-6 border-b pb-4">
                                <div className="flex items-center gap-3">
                                    <h1 className="text-2xl font-serif font-medium text-slate-800">ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸°</h1>
                                    <span className="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded font-bold">A6 ë¬¸ê³ íŒ</span>
                                </div>
                                <a href="https://yuliyulidaz.github.io/yulilog/" target="_blank" rel="noreferrer" className="flex items-center gap-1.5 text-slate-400 hover:text-indigo-600 transition-colors py-1 px-2 rounded hover:bg-indigo-50">
                                    <span className="text-lg">ğŸ”—</span>
                                    <span className="text-xs font-medium hidden sm:inline">ë°œì·Œ ë¬¸êµ¬ ìƒì„±ê¸°</span>
                                </a>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm text-slate-500 mb-1">ì œëª© (í•„ìš”ì‹œ ì…ë ¥)</label>
                                    <input 
                                        type="text" 
                                        value={metadata.title}
                                        onChange={(e) => setMetadata({...metadata, title: e.target.value})}
                                        className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all" 
                                        placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" 
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-500 mb-1">í”Œë«í¼ ì•„ì´ì½˜ ì„ íƒ</label>
                                    <select 
                                        value={metadata.iconUrl}
                                        onChange={(e) => setMetadata({...metadata, iconUrl: e.target.value})}
                                        className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all text-slate-700"
                                    >
                                        <option value="">ì„ íƒ ì•ˆí•¨</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/dokichat.jpg">ë„í‚¤ì±—</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/LoveyDovey.jpg">ëŸ¬ë¹„ë”ë¹„</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/reppley.jpg">ë ˆí”Œë¦¬</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/rplay.png">ë¡œë§¨í‹±í”Œë ˆì´</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/rofan.png">ë¡œíŒAI</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/melting.jpg">ë©œíŒ…</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/bloom.jpg">ë¸”ë£¸</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/inkchat.jpg">ì‰í¬ì±—</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/zeta.jpg">ì œíƒ€</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/carat.png">ìºëŸ¿</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/chemi.png">ì¼€ë°</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/Caveduck.jpg">ì¼€ì´ë¸Œë•</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/crack.png">í¬ë™</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/pulse.jpg">í„ìŠ¤</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/Fizzchat.png">í”¼ì¦ˆì±—</option>
                                        <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/whif.jpg">WHIF</option>
                                    </select>
                                    <p className="text-xs text-slate-400 mt-1">* 1í˜ì´ì§€ ì œëª© ìœ„ í˜¹ì€ ì¢Œì¸¡ í•˜ë‹¨ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm text-slate-500 mb-1">ìºë¦­í„°</label>
                                    <input 
                                        type="text" 
                                        value={metadata.author}
                                        onChange={(e) => setMetadata({...metadata, author: e.target.value})}
                                        className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all" 
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-500 mb-1">ì œì‘ì</label>
                                    <input 
                                        type="text" 
                                        value={metadata.producer}
                                        onChange={(e) => setMetadata({...metadata, producer: e.target.value})}
                                        className="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all" 
                                    />
                                </div>
                            </div>

                            <div className="mb-6">
                                <label className="block text-sm text-slate-500 mb-1">ë³¸ë¬¸ ë‚´ìš©</label>
                                <textarea 
                                    value={textInput}
                                    onChange={(e) => setTextInput(e.target.value)}
                                    className="w-full h-[400px] p-5 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all resize-none font-serif leading-loose" 
                                    placeholder={"ì—¬ê¸°ì— ì†Œì„¤ ë³¸ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.\nì—”í„°ë¡œ êµ¬ë¶„ëœ ì¤„ì€ ìë™ìœ¼ë¡œ ë¬¸ë‹¨ ë“¤ì—¬ì“°ê¸°ê°€ ì ìš©ë©ë‹ˆë‹¤."}
                                ></textarea>
                            </div>

                            <button onClick={startGeneration} disabled={isGenerating} className="btn w-full py-4 bg-slate-800 text-white rounded-lg font-medium hover:bg-slate-700 shadow-lg flex justify-center items-center gap-2 disabled:opacity-70">
                                <span>{isGenerating ? 'ìƒì„± ì¤‘...' : 'A6 ë ˆì´ì•„ì›ƒ ìƒì„±í•˜ê¸°'}</span>
                            </button>
                        </div>
                    )}

                    {/* STEP 2: PREVIEW */}
                    {step === 'preview' && (
                        <div className="pb-20">
                            {/* Toolbar */}
                            <div className="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b shadow-sm mb-8">
                                <div className="max-w-6xl mx-auto px-4 py-3 flex flex-wrap justify-center md:justify-between items-center gap-4">
                                    {/* Navigation */}
                                    <div className="flex items-center gap-4">
                                        <button onClick={resetApp} className="text-sm text-slate-500 hover:text-red-600 flex items-center gap-1 border-r pr-4 transition-colors">
                                            <span>â†º ì²˜ìŒìœ¼ë¡œ</span>
                                        </button>
                                        <button onClick={backToEdit} className="text-sm text-slate-500 hover:text-indigo-600 flex items-center gap-1 border-r pr-4 transition-colors">
                                            <span>âœ ë³¸ë¬¸ ìˆ˜ì •</span>
                                        </button>
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => goToPage(currentPageIdx - 1)} disabled={currentPageIdx === 0} className="w-8 h-8 rounded-full border flex items-center justify-center hover:bg-slate-50 disabled:opacity-30">â—€</button>
                                            <span className="font-serif tabular-nums text-sm w-12 text-center">{currentPageIdx + 1} / {pages.length}</span>
                                            <button onClick={() => goToPage(currentPageIdx + 1)} disabled={currentPageIdx === pages.length - 1} className="w-8 h-8 rounded-full border flex items-center justify-center hover:bg-slate-50 disabled:opacity-30">â–¶</button>
                                        </div>
                                    </div>

                                    {/* Highlight Tool */}
                                    <div className="flex items-center gap-3 bg-slate-100 px-3 py-1.5 rounded-full">
                                        <button onClick={() => setIsHighlightMode(!isHighlightMode)} className={`text-xs font-medium px-2 py-1 rounded transition-colors text-slate-600 hover:text-slate-900 ${isHighlightMode ? 'bg-slate-200' : ''}`}>
                                            {isHighlightMode ? 'í˜•ê´‘íœ ë„ê¸°' : 'í˜•ê´‘íœ ì¼œê¸°'}
                                        </button>
                                        <div className="h-4 w-px bg-slate-300"></div>
                                        <div className={`flex gap-1 ${!isHighlightMode ? 'hidden' : ''}`}>
                                            {['highlight-yellow', 'highlight-pink', 'highlight-mint', 'highlight-blue'].map(color => (
                                                <div 
                                                    key={color} 
                                                    onClick={() => setCurrentHighlightColor(color)}
                                                    className={`color-btn w-6 h-6 rounded-full border-2 border-transparent cursor-pointer transition-transform hover:scale-110 ${color} ${currentHighlightColor === color ? 'border-slate-800 scale-110' : ''}`}
                                                ></div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Actions */}
                                    <div className="flex items-center gap-2">
                                        <button onClick={downloadCurrentPage} className="bg-white border border-slate-200 text-slate-700 px-4 py-1.5 rounded-full text-xs hover:bg-slate-50 shadow-sm btn transition-all active:scale-95">
                                            í˜„ì¬ í˜ì´ì§€ ì €ì¥
                                        </button>
                                        {!isIOS() && !isAndroid() && (
                                            <button onClick={downloadAllPages} className="bg-slate-800 text-white px-4 py-1.5 rounded-full text-xs hover:bg-slate-700 shadow-md btn transition-all active:scale-95">
                                                ì „ì²´ ì €ì¥
                                            </button>
                                        )}
                                    </div>
                                </div>
                                {/* Highlight Guide */}
                                {isHighlightMode && (
                                    <div className="w-full bg-yellow-50 border-t border-yellow-100 py-2 text-center">
                                        <p className="text-[11px] text-yellow-800 font-medium leading-relaxed">
                                            ë“œë˜ê·¸ë¡œ í˜•ê´‘íœ ì ìš©, ì ìš© í›„ í„°ì¹˜ì‹œ ì‚­ì œ<br/>
                                            ì—¬ëŸ¬ ë¬¸ë‹¨ì„ í•œ ë²ˆì— ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                                        </p>
                                    </div>
                                )}
                            </div>

                            {/* Viewer */}
                            <div id="bookViewerWrapper" className="flex justify-center overflow-visible px-4 select-text">
                                <div 
                                    ref={viewerRef}
                                    id="captureTarget" 
                                    className="page-container select-text"
                                >
                                    {/* Rendering Logic */}
                                    {pageHighlights[currentPageIdx] ? (
                                        <div 
                                            ref={contentRef}
                                            onMouseUp={handleHighlightSelection}
                                            onTouchEnd={handleHighlightSelection}
                                            dangerouslySetInnerHTML={{ __html: pageHighlights[currentPageIdx] }}
                                            style={{display: 'contents'}}
                                        />
                                    ) : (
                                        <>
                                            {/* Icon (Page 1) - Use Base64 if available, fallback to URL */}
                                            {currentPageIdx === 0 && (currentIconBase64 || metadata.iconUrl) && (
                                                <img 
                                                    src={currentIconBase64 || metadata.iconUrl} 
                                                    style={getIconStyle()}
                                                    alt="icon" 
                                                    crossOrigin="anonymous"
                                                />
                                            )}

                                            <div ref={contentRef} className="page-content" id="pageContentArea" onMouseUp={handleHighlightSelection} onTouchEnd={handleHighlightSelection}>
                                                {/* Title (Page 1) */}
                                                {currentPageIdx === 0 && metadata.title && (
                                                    <div style={{height: '200px', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', marginBottom: 0}}>
                                                        <h1 className="text-base tracking-[0.1em] text-slate-700 font-normal text-center px-4" style={{lineHeight: 1.8, maxHeight: '70px', overflow: 'hidden'}}>
                                                            {metadata.title}
                                                        </h1>
                                                        <div className="w-8 h-[1px] bg-slate-400 opacity-50 mx-auto mt-14"></div>
                                                    </div>
                                                )}

                                                {/* Content */}
                                                {pages[currentPageIdx]?.paragraphs.map((p, i) => (
                                                    <p key={i} className={p.isContinued ? 'continued' : ''} style={{lineHeight: 1.8}}>{p.text}</p>
                                                ))}
                                            </div>

                                            {/* Footer */}
                                            <div className={`page-footer-area text-[9px] text-gray-400 ${(currentPageIdx + 1) % 2 !== 0 ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`flex items-center gap-2 ${(currentPageIdx + 1) % 2 !== 0 ? 'flex-row' : 'flex-row-reverse'}`}>
                                                    {(metadata.producer || metadata.author) && (
                                                        <span>{[metadata.producer, metadata.author].filter(Boolean).join(' Â· ')}</span>
                                                    )}
                                                    <span className="font-normal text-gray-500">{currentPageIdx + 1}</span>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Footer (Global) */}
                    <footer className="max-w-4xl mx-auto px-6 py-10 text-slate-500 text-xs text-center leading-relaxed mt-12 border-t border-slate-200">
                        <p className="font-bold mb-2 text-sm text-slate-700">ğŸ“– ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸° v1.0.1</p>
                        <p className="mb-6">ë³¸ ì‚¬ì´íŠ¸ëŠ” ì–´ë– í•œ ê°œì¸ì •ë³´ë„ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br/>ëª¨ë“  ì‘ì—…ì€ ê·€í•˜ì˜ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</p>
                        
                        <div className="bg-slate-50 rounded-xl p-6 text-left inline-block w-full max-w-2xl border border-slate-100">
                            <p className="font-bold mb-3 text-slate-700 flex items-center gap-2">
                                <span className="text-base">âš ï¸</span> ì´ìš© ì‹œ ì£¼ì˜ì‚¬í•­
                            </p>
                            <ul className="list-disc pl-4 space-y-2 mb-5 text-slate-600">
                                <li><strong className="text-slate-700">í…ìŠ¤íŠ¸ ì¸ìš©:</strong> ì±…ì´ë‚˜ ê¸°íƒ€ ì €ì‘ë¬¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ë°œì·Œí•  ê²½ìš°, ì €ì‘ê¶Œë²•ìƒ í—ˆìš© ë²”ìœ„ ë‚´ì—ì„œ ì‚¬ìš©í•˜ê³  ì¶œì²˜ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.</li>
                                <li><strong className="text-slate-700">í”Œë«í¼ ë¡œê³ :</strong> ê° í”Œë«í¼ì˜ ë¡œê³ ëŠ” í•´ë‹¹ í”Œë«í¼ì˜ ìƒí‘œì´ë©°, ì‚¬ìš© ì‹œ ê° í”Œë«í¼ì˜ ë¸Œëœë“œ ê°€ì´ë“œë¼ì¸ì„ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                                <li><strong className="text-slate-700">ìƒì—…ì  ì´ìš©:</strong> ìƒì„±ëœ ì´ë¯¸ì§€ëŠ” ìƒì—…ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
                            </ul>
                            <p className="text-slate-400 text-[11px] pt-4 border-t border-slate-200">
                                ë³¸ ë„êµ¬ì˜ ì œì‘ìëŠ” ì‚¬ìš©ìê°€ ìƒì„±í•œ ì½˜í…ì¸ ì— ëŒ€í•´ ì–´ë– í•œ ì±…ì„ë„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.<br/>
                                ì´ë¯¸ì§€ ë° í…ìŠ¤íŠ¸ ì‚¬ìš©ìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ëª¨ë“  ë²•ì  ë¬¸ì œëŠ” ì‚¬ìš©ì ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤.
                            </p>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
