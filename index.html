<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸° (B6 ë¬¸ê³ íŒ)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            background: #f5f5f5;
            padding: 20px;
        }

        /* ì…ë ¥ ë‹¨ê³„ */
        .input-section {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .input-section h1 {
            font-size: 24px;
            font-weight: 300;
            margin-bottom: 10px;
            color: #333;
        }

        .input-section .version {
            font-size: 12px;
            font-weight: 200;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .input-section textarea {
            width: 100%;
            min-height: 300px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Noto Serif KR', serif;
            font-size: 14px;
            font-weight: 300;
            line-height: 1.8;
            resize: vertical;
        }

        .input-info {
            margin: 15px 0;
            display: flex;
            gap: 15px;
        }

        .input-info input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Noto Serif KR', serif;
            font-size: 14px;
            font-weight: 300;
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Noto Serif KR', serif;
            font-size: 16px;
            font-weight: 300;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #34495e;
        }

        /* í¸ì§‘ ë‹¨ê³„ */
        .editor-section {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .editor-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .editor-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn-secondary {
            padding: 10px 20px;
            background: white;
            color: #2c3e50;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Noto Serif KR', serif;
            font-size: 14px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #2c3e50;
        }

        .btn-secondary.active {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .highlight-colors {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: 10px;
        }

        .color-btn {
            width: 32px;
            height: 32px;
            border: 2px solid #ddd;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.active {
            border-color: #2c3e50;
            border-width: 3px;
        }

        /* í˜ì´ì§€ - B6 ë¬¸ê³ íŒ (128Ã—188mm) */
        .page-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .book-page {
            width: 384px;
            height: 564px;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
            padding: 55px 65px 70px 65px;
            display: flex;
            flex-direction: column;
        }

        .page-content {
            flex: 1;
            font-family: 'Noto Serif KR', serif;
            font-size: 12px;
            font-weight: 200;
            line-height: 1.85;
            text-align: justify;
            color: #2c3e50;
            letter-spacing: -0.02em;
            word-break: keep-all;
            overflow: hidden;
            user-select: text;
            cursor: text;
        }

        .page-content p {
            text-indent: 1em;
            margin-bottom: 0.7em;
        }

        .page-content p:last-child {
            margin-bottom: 0;
        }

        .highlight {
            background: rgba(255, 235, 59, 0.4);
            padding: 2px 0;
            border-radius: 2px;
        }

        .highlight.pink {
            background: rgba(255, 182, 193, 0.4);
        }

        .highlight.mint {
            background: rgba(178, 255, 222, 0.4);
        }

        .highlight.blue {
            background: rgba(173, 216, 230, 0.4);
        }

        .page-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 9px;
            font-weight: 200;
            color: #7f8c8d;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }

        .page-number {
            text-align: center;
            flex: 1;
        }

        .page-navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .nav-btn {
            padding: 10px 30px;
            background: white;
            color: #2c3e50;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Noto Serif KR', serif;
            font-size: 14px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #2c3e50;
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .book-page {
                width: 100%;
                max-width: 384px;
                height: auto;
                aspect-ratio: 128/188;
            }

            .input-section {
                padding: 20px;
            }

            .editor-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- ì…ë ¥ ë‹¨ê³„ -->
    <div class="input-section" id="inputSection">
        <h1>ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸°</h1>
        <div class="version">B6 ë¬¸ê³ íŒ (128Ã—188mm)</div>
        <textarea id="textInput" placeholder="ì†Œì„¤ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...

ì—”í„° í•œ ë²ˆìœ¼ë¡œ ë¬¸ë‹¨ì´ êµ¬ë¶„ë©ë‹ˆë‹¤."></textarea>
        <div class="input-info">
            <input type="text" id="bookTitle" placeholder="ì œì‘ì" value="">
            <input type="text" id="authorName" placeholder="ìºë¦­í„°" value="">
        </div>
        <button class="btn-primary" onclick="generatePages()">í˜ì´ì§€ ìƒì„±</button>
    </div>

    <!-- í¸ì§‘ ë‹¨ê³„ -->
    <div class="editor-section" id="editorSection">
        <div class="editor-header">
            <div class="editor-controls">
                <button class="btn-secondary" id="highlightBtn" onclick="toggleHighlightMode()">
                    í˜•ê´‘íœ ëª¨ë“œ
                </button>
                <div class="highlight-colors" id="colorPicker" style="display: none;">
                    <span style="font-size: 12px; color: #7f8c8d;">ìƒ‰ìƒ:</span>
                    <div class="color-btn active" style="background: rgba(255, 235, 59, 0.6);" onclick="selectColor('yellow')"></div>
                    <div class="color-btn" style="background: rgba(255, 182, 193, 0.6);" onclick="selectColor('pink')"></div>
                    <div class="color-btn" style="background: rgba(178, 255, 222, 0.6);" onclick="selectColor('mint')"></div>
                    <div class="color-btn" style="background: rgba(173, 216, 230, 0.6);" onclick="selectColor('blue')"></div>
                </div>
                <button class="btn-secondary" onclick="downloadCurrentPage()">
                    í˜„ì¬ í˜ì´ì§€ ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="btn-secondary" onclick="downloadAllPages()">
                    ì „ì²´ í˜ì´ì§€ ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="btn-secondary" onclick="resetToInput()">
                    ìƒˆë¡œ ë§Œë“¤ê¸°
                </button>
            </div>
        </div>

        <div class="page-navigation">
            <button class="nav-btn" id="prevBtn" onclick="changePage(-1)">â—€ ì´ì „</button>
            <span id="pageIndicator" style="font-size: 14px; color: #7f8c8d; font-weight: 300;">1 / 1</span>
            <button class="nav-btn" id="nextBtn" onclick="changePage(1)">ë‹¤ìŒ â–¶</button>
        </div>

        <div class="page-container" id="pageContainer"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let pages = [];
        let currentPage = 0;
        let highlightMode = false;
        let currentColor = 'yellow';
        let bookTitle = '';
        let authorName = '';
        let pageHighlights = {};

        // í˜ì´ì§€ ìƒì„± - ì¤„ ìˆ˜ ê¸°ë°˜ (17ì¤„)
        function generatePages() {
            const text = document.getElementById('textInput').value.trim();
            bookTitle = document.getElementById('bookTitle').value.trim();
            authorName = document.getElementById('authorName').value.trim();

            if (!text) {
                alert('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¬¸ë‹¨ ë¶„ë¦¬
            const paragraphs = text.split('\n').filter(p => p.trim());
            
            // í˜ì´ì§€ ë¶„í•  (ì‹¤ì œ ë Œë”ë§ ë†’ì´ ê¸°ë°˜)
            pages = splitIntoPages(paragraphs);

            // í™”ë©´ ì „í™˜
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('editorSection').style.display = 'block';
            
            currentPage = 0;
            pageHighlights = {};
            renderPage();
        }

        // ì‹¤ì œ ë Œë”ë§ ë†’ì´ ê¸°ë°˜ìœ¼ë¡œ í˜ì´ì§€ ë¶„í• 
        function splitIntoPages(paragraphs) {
            const pages = [];
            
            // ì„ì‹œ ì¸¡ì •ìš© í˜ì´ì§€ ìƒì„± (ì‹¤ì œ í˜ì´ì§€ì™€ ë™ì¼í•œ êµ¬ì¡°)
            const tempPage = document.createElement('div');
            tempPage.style.cssText = `
                position: absolute;
                visibility: hidden;
                width: 254px;
                font-family: 'Noto Serif KR', serif;
                font-size: 12px;
                font-weight: 200;
                line-height: 1.85;
                text-align: justify;
                letter-spacing: -0.02em;
                word-break: keep-all;
            `;
            document.body.appendChild(tempPage);
            
            // í˜ì´ì§€ ì½˜í…ì¸  ìµœëŒ€ ë†’ì´ (ì‹¤ì œ ì¸¡ì •)
            const maxHeight = 415; // B6 í˜ì´ì§€ì—ì„œ ì½˜í…ì¸ ê°€ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ë†’ì´
            console.log('í˜ì´ì§€ ìµœëŒ€ ë†’ì´:', maxHeight);
            
            let remainingParagraphs = [...paragraphs];
            let pageNum = 0;
            
            while (remainingParagraphs.length > 0) {
                pageNum++;
                console.log(`\nğŸ“„ í˜ì´ì§€ ${pageNum} ìƒì„± ì¤‘...`);
                
                tempPage.innerHTML = '';
                const currentPageContent = [];
                
                // ë¬¸ë‹¨ì„ í•˜ë‚˜ì”© ì¶”ê°€í•˜ë©´ì„œ ë†’ì´ ì²´í¬
                for (let i = 0; i < remainingParagraphs.length; i++) {
                    const para = remainingParagraphs[i];
                    
                    // ì„ì‹œë¡œ ì¶”ê°€
                    const p = document.createElement('p');
                    // ë§ˆì§€ë§‰ ë¬¸ë‹¨ì´ ì•„ë‹ˆë©´ margin-bottom ì ìš©
                    const isLast = (i === remainingParagraphs.length - 1);
                    p.style.cssText = isLast ? 
                        'text-indent: 1em; margin-bottom: 0;' : 
                        'text-indent: 1em; margin-bottom: 0.7em;';
                    p.textContent = para;
                    tempPage.appendChild(p);
                    
                    const currentHeight = tempPage.scrollHeight;
                    console.log(`+ ë¬¸ë‹¨ ì¶”ê°€ "${para.substring(0, 20)}..." (í˜„ì¬ ${currentHeight}px)`);
                    
                    // ë†’ì´ ì²´í¬
                    if (currentHeight > maxHeight) {
                        console.log(`âš ï¸ ë†’ì´ ì´ˆê³¼: ${currentHeight}px > ${maxHeight}px`);
                        
                        // ë°©ê¸ˆ ì¶”ê°€í•œ ë¬¸ë‹¨ ì œê±°
                        tempPage.removeChild(p);
                        
                        // ì´ë¯¸ ì¶”ê°€ëœ ë‚´ìš©ì´ ìˆìœ¼ë©´ ê·¸ê²ƒë§Œ ì €ì¥í•˜ê³ , ì´ˆê³¼í•œ ë¬¸ë‹¨ì€ ìª¼ê°œê¸°
                        if (currentPageContent.length > 0) {
                            // í˜„ì¬ í˜ì´ì§€ì— ë“¤ì–´ê°„ ë‚´ìš© ì €ì¥
                            console.log(`ğŸ“„ í˜„ì¬ í˜ì´ì§€ì— ${currentPageContent.length}ê°œ ë¬¸ë‹¨ ì €ì¥`);
                            
                            // ì´ˆê³¼í•œ ë¬¸ë‹¨ì„ ìª¼ê°œì„œ ì¼ë¶€ë¥¼ í˜„ì¬ í˜ì´ì§€ì— ì¶”ê°€ ì‹œë„
                            const remainingSpace = maxHeight - tempPage.scrollHeight;
                            console.log(`ğŸ“ ë‚¨ì€ ê³µê°„: ${remainingSpace}px`);
                            
                            if (remainingSpace > 50) { // ì¶©ë¶„í•œ ê³µê°„ì´ ìˆìœ¼ë©´ ìª¼ê°œê¸° ì‹œë„
                                console.log(`ğŸ”ª ë¬¸ë‹¨ ë¶„í•  ì‹œë„...`);
                                const splitResult = splitParagraphToFit(para, remainingSpace, tempPage);
                                
                                if (splitResult.fitted) {
                                    currentPageContent.push(splitResult.fitted);
                                    console.log(`âœ‚ï¸ ë¬¸ë‹¨ ì¼ë¶€ ì¶”ê°€: "${splitResult.fitted.substring(0, 30)}..."`);
                                    pages.push([...currentPageContent]);
                                    
                                    // ë‚˜ë¨¸ì§€ë¥¼ ë‹¤ìŒ ë¬¸ë‹¨ë“¤ ì•ì— ì¶”ê°€
                                    remainingParagraphs = [splitResult.remaining, ...remainingParagraphs.slice(i + 1)];
                                } else {
                                    // ë¶„í•  ì‹¤íŒ¨ - í˜„ì¬ê¹Œì§€ë§Œ ì €ì¥
                                    pages.push([...currentPageContent]);
                                    remainingParagraphs = remainingParagraphs.slice(i);
                                }
                            } else {
                                // ê³µê°„ ë¶€ì¡± - í˜„ì¬ê¹Œì§€ë§Œ ì €ì¥
                                pages.push([...currentPageContent]);
                                remainingParagraphs = remainingParagraphs.slice(i);
                            }
                            
                            console.log(`âœ… í˜ì´ì§€ ì €ì¥ ì™„ë£Œ`);
                            break;
                        } else {
                            // ì²« ë¬¸ë‹¨ë¶€í„° ë„˜ì¹˜ëŠ” ê²½ìš° - ë¬¸ë‹¨ì„ ìª¼ê°œì•¼ í•¨
                            console.log('ğŸ”ª ë¬¸ë‹¨ì´ ë„ˆë¬´ ê¹€ - ë¶„í•  í•„ìš”');
                            const splitResult = splitLongParagraph(para, maxHeight, tempPage);
                            
                            if (splitResult.fitted) {
                                pages.push([splitResult.fitted]);
                                remainingParagraphs[0] = splitResult.remaining;
                                console.log(`âœ… ë¬¸ë‹¨ ë¶„í•  ì €ì¥`);
                                break;
                            } else {
                                // ë¶„í• ë„ ì‹¤íŒ¨ - ê°•ì œë¡œ ë„£ê¸°
                                pages.push([para]);
                                remainingParagraphs = remainingParagraphs.slice(1);
                                console.log(`âš ï¸ ê°•ì œ ì €ì¥`);
                                break;
                            }
                        }
                    } else {
                        // ë†’ì´ OK - ê³„ì† ì¶”ê°€
                        currentPageContent.push(para);
                        
                        // ë§ˆì§€ë§‰ ë¬¸ë‹¨ì´ë©´ í˜ì´ì§€ ì €ì¥
                        if (i === remainingParagraphs.length - 1) {
                            pages.push([...currentPageContent]);
                            remainingParagraphs = [];
                            console.log(`âœ… ë§ˆì§€ë§‰ í˜ì´ì§€ ì €ì¥ (${currentHeight}px)`);
                        }
                    }
                }
            }
            
            // ì •ë¦¬
            document.body.removeChild(tempPage);
            console.log(`\nğŸ‰ ì´ ${pages.length}í˜ì´ì§€ ìƒì„± ì™„ë£Œ!`);
            
            return pages;
        }
        
        // ë‚¨ì€ ê³µê°„ì— ë§ê²Œ ë¬¸ë‹¨ì„ ìª¼ê°œê¸°
        function splitParagraphToFit(paragraph, remainingHeight, container) {
            // ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„í•  ì‹œë„
            const sentences = paragraph.match(/[^.!?]+[.!?]+/g) || [paragraph];
            
            if (sentences.length > 1) {
                let fitted = [];
                const originalHTML = container.innerHTML;
                
                for (let i = 0; i < sentences.length; i++) {
                    const testText = [...fitted, sentences[i]].join('');
                    const p = document.createElement('p');
                    p.style.cssText = 'text-indent: 1em; margin-bottom: 0;';
                    p.textContent = testText;
                    container.appendChild(p);
                    
                    if (container.scrollHeight - container.scrollHeight + p.offsetHeight <= remainingHeight) {
                        fitted.push(sentences[i]);
                    } else {
                        container.removeChild(p);
                        break;
                    }
                    container.removeChild(p);
                }
                
                container.innerHTML = originalHTML;
                
                if (fitted.length > 0) {
                    return {
                        fitted: fitted.join(''),
                        remaining: sentences.slice(fitted.length).join('')
                    };
                }
            }
            
            // ë¬¸ì¥ ë¶„í•  ì‹¤íŒ¨ - ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì‹œë„
            const words = paragraph.split(' ');
            if (words.length > 1) {
                let fitted = [];
                const originalHTML = container.innerHTML;
                
                for (let i = 0; i < words.length; i++) {
                    const testText = [...fitted, words[i]].join(' ');
                    const p = document.createElement('p');
                    p.style.cssText = 'text-indent: 1em; margin-bottom: 0;';
                    p.textContent = testText;
                    container.appendChild(p);
                    
                    if (p.offsetHeight <= remainingHeight) {
                        fitted.push(words[i]);
                    } else {
                        container.removeChild(p);
                        break;
                    }
                    container.removeChild(p);
                }
                
                container.innerHTML = originalHTML;
                
                if (fitted.length > 0) {
                    return {
                        fitted: fitted.join(' '),
                        remaining: words.slice(fitted.length).join(' ')
                    };
                }
            }
            
            return { fitted: null, remaining: paragraph };
        }
        
        // ê¸´ ë¬¸ë‹¨ì„ ë‘ ë¶€ë¶„ìœ¼ë¡œ ë¶„í• 
        function splitLongParagraph(paragraph, maxHeight, container) {
            // ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„í•  ì‹œë„
            const sentences = paragraph.match(/[^.!?]+[.!?]+/g) || [paragraph];
            
            if (sentences.length > 1) {
                // ë¬¸ì¥ë³„ë¡œ ì¶”ê°€í•˜ë©´ì„œ ìµœëŒ€í•œ ì±„ìš°ê¸°
                container.innerHTML = '';
                let fitted = [];
                
                for (let i = 0; i < sentences.length; i++) {
                    const p = document.createElement('p');
                    p.style.cssText = 'text-indent: 1em; margin-bottom: 0.7em;';
                    p.textContent = [...fitted, sentences[i]].join('');
                    container.innerHTML = '';
                    container.appendChild(p);
                    
                    if (container.scrollHeight <= maxHeight) {
                        fitted.push(sentences[i]);
                    } else {
                        break;
                    }
                }
                
                if (fitted.length > 0) {
                    return {
                        fitted: fitted.join(''),
                        remaining: sentences.slice(fitted.length).join('')
                    };
                }
            }
            
            // ë¬¸ì¥ ë¶„í•  ì‹¤íŒ¨ - ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì‹œë„
            const words = paragraph.split(' ');
            if (words.length > 1) {
                container.innerHTML = '';
                let fitted = [];
                
                for (let i = 0; i < words.length; i++) {
                    const p = document.createElement('p');
                    p.style.cssText = 'text-indent: 1em; margin-bottom: 0.7em;';
                    p.textContent = [...fitted, words[i]].join(' ');
                    container.innerHTML = '';
                    container.appendChild(p);
                    
                    if (container.scrollHeight <= maxHeight) {
                        fitted.push(words[i]);
                    } else {
                        break;
                    }
                }
                
                if (fitted.length > 0) {
                    return {
                        fitted: fitted.join(' '),
                        remaining: words.slice(fitted.length).join(' ')
                    };
                }
            }
            
            // ëª¨ë“  ë¶„í•  ì‹¤íŒ¨
            return { fitted: null, remaining: paragraph };
        }

        // í˜„ì¬ í˜ì´ì§€ ë Œë”ë§
        function renderPage() {
            const container = document.getElementById('pageContainer');
            container.innerHTML = '';

            const pageDiv = document.createElement('div');
            pageDiv.className = 'book-page';
            pageDiv.id = 'currentPage';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'page-content';
            contentDiv.id = 'pageContent';

            // ì €ì¥ëœ HTMLì´ ìˆìœ¼ë©´ ë³µì›, ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            if (pageHighlights[currentPage]) {
                contentDiv.innerHTML = pageHighlights[currentPage];
            } else {
                pages[currentPage].forEach(para => {
                    const p = document.createElement('p');
                    p.textContent = para;
                    contentDiv.appendChild(p);
                });
            }

            // Footer
            const footer = document.createElement('div');
            footer.className = 'page-footer';
            const leftText = bookTitle ? `<span>${bookTitle}</span>` : '<span></span>';
            const rightText = authorName ? `<span>${authorName}</span>` : '<span></span>';
            footer.innerHTML = `
                ${leftText}
                <span class="page-number">${currentPage + 1}</span>
                ${rightText}
            `;

            pageDiv.appendChild(contentDiv);
            pageDiv.appendChild(footer);
            container.appendChild(pageDiv);

            // ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
            document.getElementById('pageIndicator').textContent = `${currentPage + 1} / ${pages.length}`;
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = currentPage === pages.length - 1;

            // í˜•ê´‘íœ ëª¨ë“œ ìœ ì§€
            if (highlightMode) {
                enableHighlightMode();
            }
        }

        // í˜ì´ì§€ ì´ë™
        function changePage(direction) {
            // í˜„ì¬ í˜ì´ì§€ ì €ì¥
            const content = document.getElementById('pageContent');
            if (content) {
                pageHighlights[currentPage] = content.innerHTML;
            }

            const newPage = currentPage + direction;
            if (newPage >= 0 && newPage < pages.length) {
                currentPage = newPage;
                renderPage();
            }
        }

        // í˜•ê´‘íœ ëª¨ë“œ
        function toggleHighlightMode() {
            highlightMode = !highlightMode;
            const btn = document.getElementById('highlightBtn');
            const colorPicker = document.getElementById('colorPicker');
            
            if (highlightMode) {
                btn.classList.add('active');
                btn.textContent = 'í˜•ê´‘íœ ëª¨ë“œ (ON)';
                colorPicker.style.display = 'flex';
                enableHighlightMode();
            } else {
                btn.classList.remove('active');
                btn.textContent = 'í˜•ê´‘íœ ëª¨ë“œ';
                colorPicker.style.display = 'none';
                disableHighlightMode();
            }
        }

        function selectColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function enableHighlightMode() {
            document.addEventListener('mouseup', handleTextSelection);
        }

        function disableHighlightMode() {
            document.removeEventListener('mouseup', handleTextSelection);
        }

        function handleTextSelection() {
            if (!highlightMode) return;

            const selection = window.getSelection();
            if (selection.toString().trim().length === 0) return;

            const range = selection.getRangeAt(0);
            const span = document.createElement('span');
            span.className = `highlight ${currentColor}`;
            
            try {
                range.surroundContents(span);
                selection.removeAllRanges();
                
                // ìƒíƒœ ì €ì¥
                const content = document.getElementById('pageContent');
                if (content) {
                    pageHighlights[currentPage] = content.innerHTML;
                }
            } catch (e) {
                console.log('í•˜ì´ë¼ì´íŠ¸ ì ìš© ì‹¤íŒ¨');
            }
        }

        // ë‹¤ìš´ë¡œë“œ
        async function downloadCurrentPage() {
            const page = document.getElementById('currentPage');
            const canvas = await html2canvas(page, {
                scale: 2,
                backgroundColor: '#ffffff'
            });
            
            const link = document.createElement('a');
            const fileName = bookTitle || 'ì†Œì„¤';
            link.download = `${fileName}_${currentPage + 1}í˜ì´ì§€.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        async function downloadAllPages() {
            if (!confirm(`ì´ ${pages.length}ê°œì˜ í˜ì´ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            const fileName = bookTitle || 'ì†Œì„¤';

            for (let i = 0; i < pages.length; i++) {
                currentPage = i;
                renderPage();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const page = document.getElementById('currentPage');
                const canvas = await html2canvas(page, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                });
                
                const link = document.createElement('a');
                link.download = `${fileName}_${i + 1}í˜ì´ì§€.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            alert('ëª¨ë“  í˜ì´ì§€ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            currentPage = 0;
            renderPage();
        }

        // ì´ˆê¸°í™”
        function resetToInput() {
            if (confirm('ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('inputSection').style.display = 'block';
                document.getElementById('editorSection').style.display = 'none';
                document.getElementById('textInput').value = '';
                document.getElementById('bookTitle').value = '';
                document.getElementById('authorName').value = '';
                pages = [];
                currentPage = 0;
                highlightMode = false;
                pageHighlights = {};
            }
        }
    </script>
</body>
</html>
