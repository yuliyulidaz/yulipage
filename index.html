<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸° (A6 ë¬¸ê³ íŒ)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html-to-image ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
    <style>
        /* í°íŠ¸ ê°•ì œ ì ìš© */
        * {
            font-family: 'Noto Serif KR', serif !important;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            background: #f0f2f5;
            color: #1a1a1a;
        }

        /* í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .highlight {
            display: inline;
            background: rgba(255, 235, 59, 0.4);
            padding: 0;
            margin: 0;
            line-height: normal;
            vertical-align: baseline;
            border: none;
            outline: none;
        }
        
        .highlight-yellow { background: rgba(255, 235, 59, 0.4); }
        .highlight-pink { background: rgba(255, 182, 193, 0.4); }
        .highlight-mint { background: rgba(178, 255, 222, 0.4); }
        .highlight-blue { background: rgba(173, 216, 230, 0.4); }

        /* í™”ë©´ìš© ìŠ¤íƒ€ì¼ - A6 ë¹„ìœ¨ (105:148) */
        .page-container {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: white;
            margin: 0 auto;
            width: 420px;  
            height: 600px; 
            padding: 60px 60px 30px 60px; 
            position: relative;
            display: flex;
            flex-direction: column;
            transform-origin: top center;
        }

        .page-content {
            height: 460px; 
            overflow: hidden;
            font-size: 12px;
            line-height: 1.8 !important;
            text-align: justify;
            letter-spacing: -0.02em;
            word-break: break-all;
            overflow-wrap: anywhere;
            font-weight: 300;
            cursor: text;
        }

        /* ë¬¸ë‹¨ ìŠ¤íƒ€ì¼ */
        .page-content p {
            margin-bottom: 0;
            padding: 0;
            text-indent: 1em;
            line-height: 1.8 !important;
        }

        /* ì´ì–´ì§„ ë¬¸ë‹¨ */
        .page-content p.continued {
            text-indent: 0 !important;
        }
        
        .page-footer-area {
            height: 30px;
            margin-top: auto;
            display: flex;
            align-items: flex-end;
        }

        /* ì…ë ¥ í™”ë©´ */
        .input-area {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        /* ì¸¡ì •ìš© ìˆ¨ê²¨ì§„ ë°•ìŠ¤ */
        .hidden-measure {
            position: absolute;
            visibility: hidden;
            top: -9999px;
            left: -9999px;
            width: 300px; 
            font-family: 'Noto Serif KR', serif;
            font-size: 12px;
            line-height: 1.8 !important;
            text-align: justify;
            letter-spacing: -0.02em;
            word-break: break-all;
            overflow-wrap: anywhere;
            font-weight: 300;
        }
        
        .hidden-measure p {
            margin-bottom: 0;
            line-height: 1.8 !important;
        }

        /* ìƒ‰ìƒ ì„ íƒ ë²„íŠ¼ */
        .color-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.active { border-color: #333; transform: scale(1.1); }

        /* ìœ í‹¸ë¦¬í‹° */
        .btn {
            transition: all 0.2s;
        }
        .btn:active {
            transform: scale(0.98);
        }
        
        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 450px) {
            #bookViewerWrapper {
                transform: scale(0.85);
                transform-origin: top center;
                height: 520px; 
            }
        }
    </style>
</head>
<body>
    <!-- 1. ì…ë ¥ ë‹¨ê³„ -->
    <div id="inputSection" class="input-area">
        <div class="flex items-center justify-between mb-6 border-b pb-4">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-serif font-medium text-slate-800">ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸°</h1>
                <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded font-bold">A6 ë¬¸ê³ íŒ</span>
            </div>
            
            <a href="https://yuliyulidaz.github.io/yulilog/" target="_blank" class="flex items-center gap-1.5 text-slate-400 hover:text-indigo-600 transition-colors py-1 px-2 rounded hover:bg-indigo-50" title="ìë§¤ ì‚¬ì´íŠ¸ë¡œ ì´ë™">
                <span class="text-lg">ğŸ”—</span>
                <span class="text-xs font-medium hidden sm:inline">ë°œì·Œ ë¬¸êµ¬ ìƒì„±ê¸°</span>
            </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-sm text-slate-500 mb-1">ì œëª© (í•„ìš”ì‹œ ì…ë ¥)</label>
                <input type="text" id="novelTitle" class="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div>
                <label class="block text-sm text-slate-500 mb-1">í”Œë«í¼ ì•„ì´ì½˜ ì„ íƒ</label>
                <select id="iconSelect" class="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all text-slate-700">
                    <option value="">ì„ íƒ ì•ˆí•¨</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/dokichat.jpg">ë„í‚¤ì±—</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/LoveyDovey.jpg">ëŸ¬ë¹„ë”ë¹„</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/reppley.jpg">ë ˆí”Œë¦¬</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/rplay.png">ë¡œë§¨í‹±í”Œë ˆì´</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/rofan.png">ë¡œíŒAI</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/melting.jpg">ë©œíŒ…</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/bloom.jpg">ë¸”ë£¸</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/inkchat.jpg">ì‰í¬ì±—</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/zeta.jpg">ì œíƒ€</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/carat.png">ìºëŸ¿</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/chemi.png">ì¼€ë°</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/Caveduck.jpg">ì¼€ì´ë¸Œë•</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/crack.png">í¬ë™</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/pulse.jpg">í„ìŠ¤</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/Fizzchat.png">í”¼ì¦ˆì±—</option>
                    <option value="https://raw.githubusercontent.com/yuliyulidaz/yulilog/refs/heads/logos/whif.jpg">WHIF</option>
                </select>
                <p class="text-xs text-slate-400 mt-1">* 1í˜ì´ì§€ ì œëª© ìœ„ì— ì‘ê²Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
             <div>
                <label class="block text-sm text-slate-500 mb-1">ìºë¦­í„°</label>
                <input type="text" id="authorName" class="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all">
            </div>
            <div>
                <label class="block text-sm text-slate-500 mb-1">ì œì‘ì</label>
                <input type="text" id="producerName" class="w-full p-3 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all">
            </div>
        </div>

        <div class="mb-6">
            <label class="block text-sm text-slate-500 mb-1">ë³¸ë¬¸ ë‚´ìš©</label>
            <textarea id="textInput" class="w-full h-[400px] p-5 border rounded-lg bg-slate-50 focus:bg-white focus:ring-2 ring-slate-200 outline-none transition-all resize-none font-serif leading-loose" placeholder="ì—¬ê¸°ì— ì†Œì„¤ ë³¸ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.&#13;&#10;ì—”í„°ë¡œ êµ¬ë¶„ëœ ì¤„ì€ ìë™ìœ¼ë¡œ ë¬¸ë‹¨ ë“¤ì—¬ì“°ê¸°ê°€ ì ìš©ë©ë‹ˆë‹¤."></textarea>
        </div>

        <button onclick="startGeneration()" class="btn w-full py-4 bg-slate-800 text-white rounded-lg font-medium hover:bg-slate-700 shadow-lg flex justify-center items-center gap-2">
            <span>A6 ë ˆì´ì•„ì›ƒ ìƒì„±í•˜ê¸°</span>
        </button>
    </div>

    <!-- 2. ë¯¸ë¦¬ë³´ê¸° ë° í¸ì§‘ ë‹¨ê³„ -->
    <div id="previewSection" class="hidden pb-20">
        <!-- íˆ´ë°” -->
        <div class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b shadow-sm mb-8">
            <div class="max-w-6xl mx-auto px-4 py-3 flex flex-wrap justify-center md:justify-between items-center gap-4">
                <!-- ì™¼ìª½: í™ˆ/í˜ì´ì§€ì´ë™ -->
                <div class="flex items-center gap-4">
                    <button onclick="resetApp()" class="text-sm text-slate-500 hover:text-red-600 flex items-center gap-1 border-r pr-4">
                        <span>â†º ì²˜ìŒìœ¼ë¡œ</span>
                    </button>
                    <div class="flex items-center gap-2">
                        <button onclick="prevPage()" id="btnPrev" class="w-8 h-8 rounded-full border flex items-center justify-center hover:bg-slate-50 disabled:opacity-30">â—€</button>
                        <span id="pageIndicator" class="font-serif tabular-nums text-sm w-12 text-center">1 / 1</span>
                        <button onclick="nextPage()" id="btnNext" class="w-8 h-8 rounded-full border flex items-center justify-center hover:bg-slate-50 disabled:opacity-30">â–¶</button>
                    </div>
                </div>

                <!-- ì¤‘ê°„: í˜•ê´‘íœ ë„êµ¬ -->
                <div class="flex items-center gap-3 bg-slate-100 px-3 py-1.5 rounded-full">
                    <button id="highlightToggle" onclick="toggleHighlightMode()" class="text-xs font-medium px-2 py-1 rounded transition-colors text-slate-600 hover:text-slate-900">í˜•ê´‘íœ ë„ê¸°</button>
                    <div class="h-4 w-px bg-slate-300"></div>
                    <div class="flex gap-1" id="colorPalette">
                        <div class="color-btn active highlight-yellow" onclick="setHighlightColor('highlight-yellow', this)"></div>
                        <div class="color-btn highlight-pink" onclick="setHighlightColor('highlight-pink', this)"></div>
                        <div class="color-btn highlight-mint" onclick="setHighlightColor('highlight-mint', this)"></div>
                        <div class="color-btn highlight-blue" onclick="setHighlightColor('highlight-blue', this)"></div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ë‹¤ìš´ë¡œë“œ/ê³µìœ  ë²„íŠ¼ (ë™ì  í…ìŠ¤íŠ¸) -->
                <div class="flex items-center gap-2">
                    <button onclick="downloadCurrentPage()" id="downloadBtn" class="bg-white border border-slate-200 text-slate-700 px-4 py-1.5 rounded-full text-xs hover:bg-slate-50 shadow-sm btn">
                        í˜„ì¬ í˜ì´ì§€ ì €ì¥
                    </button>
                    <button onclick="downloadAllPages()" id="downloadAllBtn" class="bg-slate-800 text-white px-4 py-1.5 rounded-full text-xs hover:bg-slate-700 shadow-md btn">
                        ì „ì²´ ì €ì¥
                    </button>
                </div>
            </div>
        </div>

        <!-- ì±… ë·°ì–´ -->
        <div class="flex justify-center overflow-visible px-4 select-text" id="bookViewerWrapper">
            <div id="bookViewer">
                <!-- í˜ì´ì§€ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- í‘¸í„° -->
    <footer class="max-w-4xl mx-auto px-6 py-10 text-slate-500 text-xs text-center leading-relaxed mt-12 border-t border-slate-200">
        <p class="font-bold mb-2 text-sm text-slate-700">ğŸ“– ì†Œì„¤ ë‚´ì§€ ìƒì„±ê¸° v1.0.0</p>
        <p class="mb-6">ë³¸ ì‚¬ì´íŠ¸ëŠ” ì–´ë– í•œ ê°œì¸ì •ë³´ë„ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>ëª¨ë“  ì‘ì—…ì€ ê·€í•˜ì˜ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</p>
        
        <div class="bg-slate-50 rounded-xl p-6 text-left inline-block w-full max-w-2xl border border-slate-100">
            <p class="font-bold mb-3 text-slate-700 flex items-center gap-2">
                <span class="text-base">âš ï¸</span> ì´ìš© ì‹œ ì£¼ì˜ì‚¬í•­
            </p>
            <ul class="list-disc pl-4 space-y-2 mb-5 text-slate-600">
                <li><strong class="text-slate-700">í…ìŠ¤íŠ¸ ì¸ìš©:</strong> ì±…ì´ë‚˜ ê¸°íƒ€ ì €ì‘ë¬¼ì˜ í…ìŠ¤íŠ¸ë¥¼ ë°œì·Œí•  ê²½ìš°, ì €ì‘ê¶Œë²•ìƒ í—ˆìš© ë²”ìœ„ ë‚´ì—ì„œ ì‚¬ìš©í•˜ê³  ì¶œì²˜ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.</li>
                <li><strong class="text-slate-700">í”Œë«í¼ ë¡œê³ :</strong> ê° í”Œë«í¼ì˜ ë¡œê³ ëŠ” í•´ë‹¹ í”Œë«í¼ì˜ ìƒí‘œì´ë©°, ì‚¬ìš© ì‹œ ê° í”Œë«í¼ì˜ ë¸Œëœë“œ ê°€ì´ë“œë¼ì¸ì„ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                <li><strong class="text-slate-700">ìƒì—…ì  ì´ìš©:</strong> ìƒì„±ëœ ì´ë¯¸ì§€ëŠ” ìƒì—…ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
            </ul>
            <p class="text-slate-400 text-[11px] pt-4 border-t border-slate-200">
                ë³¸ ë„êµ¬ì˜ ì œì‘ìëŠ” ì‚¬ìš©ìê°€ ìƒì„±í•œ ì½˜í…ì¸ ì— ëŒ€í•´ ì–´ë– í•œ ì±…ì„ë„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
                ì´ë¯¸ì§€ ë° í…ìŠ¤íŠ¸ ì‚¬ìš©ìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ëª¨ë“  ë²•ì  ë¬¸ì œëŠ” ì‚¬ìš©ì ë³¸ì¸ì˜ ì±…ì„ì…ë‹ˆë‹¤.
            </p>
        </div>
    </footer>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-2xl mb-4">ì´ë¯¸ì§€ ìƒì„± ì¤‘...</div>
        <div class="text-sm opacity-80">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (<span id="loadingProgress">0</span>%)</div>
    </div>

    <!-- ì¸¡ì •ìš© ìˆ¨ê²¨ì§„ ì—˜ë¦¬ë¨¼íŠ¸ -->
    <div id="measureContainer" class="hidden-measure"></div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let pages = []; 
        let pageHighlights = {}; 
        let currentPageIdx = 0;
        
        let isHighlightMode = false;
        let currentHighlightColor = 'highlight-yellow';

        const PAGE_CONTENT_HEIGHT = 460;
        const BOTTOM_BUFFER_P1 = 15;

        let cachedFontEmbedCSS = null;

        // iOS ê°ì§€ í•¨ìˆ˜
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
        window.addEventListener('DOMContentLoaded', () => {
            updateDownloadButtonText();
        });

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (iOSì—ì„œëŠ” ì „ì²´ì €ì¥ ë²„íŠ¼ ìˆ¨ê¹€)
        function updateDownloadButtonText() {
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const isiOSDevice = isIOS();

            if (downloadBtn) {
                downloadBtn.textContent = 'í˜„ì¬ í˜ì´ì§€ ì €ì¥';
            }

            if (downloadAllBtn) {
                if (isiOSDevice) {
                    // [iOS ëŒ€ì‘] ì˜¤ë¥˜ê°€ ì¦ì€ ì „ì²´ ì €ì¥ ê¸°ëŠ¥ì„ ì•„ì˜ˆ ìˆ¨ê¹€ ì²˜ë¦¬
                    downloadAllBtn.style.display = 'none';
                } else {
                    // PC/AndroidëŠ” ì •ìƒ í‘œì‹œ
                    downloadAllBtn.style.display = ''; 
                    downloadAllBtn.textContent = 'ì „ì²´ ì €ì¥';
                }
            }
        }

        // í°íŠ¸ ë¡œë“œ ë³´ì¥ í•¨ìˆ˜
        async function ensureFontsLoaded() {
            console.log('[í°íŠ¸] ë¡œë“œ ìƒíƒœ í™•ì¸ ì¤‘...');
            try {
                await document.fonts.ready;
                if (document.fonts.check('12px "Noto Serif KR"')) {
                    console.log('[í°íŠ¸] ì´ë¯¸ ë¡œë“œë¨');
                    return;
                }
            } catch (e) {
                console.warn('í°íŠ¸ API í™•ì¸ ì‹¤íŒ¨', e);
            }
            // ì•ˆì „ì¥ì¹˜: ì‹œê°„ ì§€ì—°
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        // [í•µì‹¬] í°íŠ¸ ì„ë² ë“œ CSS ìˆ˜ë™ ìƒì„± (Base64 ë³€í™˜) - iOS í°íŠ¸ ê¹¨ì§ ë°©ì§€ìš©
        async function prepareFontEmbedCSS() {
            if (cachedFontEmbedCSS) {
                return cachedFontEmbedCSS;
            }
            
            console.log('[í°íŠ¸] Base64 ì„ë² ë“œ CSS ìƒì„± ì‹œì‘...');
            
            try {
                // 1. êµ¬ê¸€ í°íŠ¸ CSS ê°€ì ¸ì˜¤ê¸°
                const cssUrl = 'https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@200;300;400;500&display=swap';
                const cssRes = await fetch(cssUrl);
                let cssText = await cssRes.text();

                // 2. CSS ë‚´ë¶€ì˜ url(...) íŒ¨í„´ ì°¾ê¸°
                const urlRegex = /url\(([^)]+)\)/g;
                let match;
                const replacements = [];

                while ((match = urlRegex.exec(cssText)) !== null) {
                    const fullUrl = match[1].replace(/['"]/g, ''); 
                    replacements.push({
                        original: match[0], 
                        url: fullUrl
                    });
                }

                // 3. ê° í°íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë° Base64 ë³€í™˜
                await Promise.all(replacements.map(async (item) => {
                    try {
                        const fontRes = await fetch(item.url);
                        const fontBlob = await fontRes.blob();
                        
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                const base64data = reader.result;
                                cssText = cssText.replace(item.url, base64data);
                                resolve();
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(fontBlob);
                        });
                    } catch (e) {
                        console.warn('ê°œë³„ í°íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', item.url, e);
                    }
                }));

                cachedFontEmbedCSS = cssText;
                return cssText;

            } catch (e) {
                console.error('[í°íŠ¸] ìˆ˜ë™ ì„ë² ë“œ ìƒì„± ì‹¤íŒ¨:', e);
                return null;
            }
        }

        // --- í•µì‹¬ ë¡œì§: í˜ì´ì§€ ë¶„í•  ì—”ì§„ ---
        function startGeneration() {
            const text = document.getElementById('textInput').value;
            const novelTitle = document.getElementById('novelTitle').value;
            
            if (!text.trim()) {
                alert("ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            document.querySelector('.btn span').textContent = "ìƒì„± ì¤‘...";
            
            setTimeout(() => {
                pageHighlights = {}; 
                cachedFontEmbedCSS = null; // ìºì‹œ ì´ˆê¸°í™”
                pages = splitTextIntoPages(text, novelTitle);
                currentPageIdx = 0;
                
                document.getElementById('inputSection').classList.add('hidden');
                document.getElementById('previewSection').classList.remove('hidden');
                
                window.scrollTo(0, 0); // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™
                
                document.querySelector('.btn span').textContent = "A6 ë ˆì´ì•„ì›ƒ ìƒì„±í•˜ê¸°";
                
                isHighlightMode = true;
                updateHighlightUI();
                updateDownloadButtonText(); // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                
                renderCurrentPage();
            }, 50);
        }

        function splitTextIntoPages(fullText, title) {
            const resultPages = [];
            const measureBox = document.getElementById('measureContainer');
            
            const rawParagraphs = fullText.split('\n').filter(p => p.trim().length > 0);
            
            let currentParagraphs = [];
            let pageNum = 1;
            
            let queue = rawParagraphs.map(text => ({ text: text, isContinued: false }));

            measureBox.innerHTML = ''; 
            
            if (title && pageNum === 1) {
                const titlePlaceholder = document.createElement('div');
                titlePlaceholder.style.height = "200px";
                titlePlaceholder.style.width = "100%";
                titlePlaceholder.style.marginBottom = "0"; 
                measureBox.appendChild(titlePlaceholder);
            }

            while (queue.length > 0) {
                const item = queue.shift();
                
                const p = document.createElement('p');
                p.textContent = item.text;
                p.style.lineHeight = "1.8";
                p.style.marginBottom = "0";
                
                if (item.isContinued) p.classList.add('continued');
                else p.style.textIndent = '1em';

                measureBox.appendChild(p);
                
                const currentHeight = measureBox.scrollHeight;

                const currentBuffer = (pageNum === 1) ? BOTTOM_BUFFER_P1 : 0;
                const limitHeight = PAGE_CONTENT_HEIGHT - currentBuffer;

                if (currentHeight <= limitHeight) {
                    currentParagraphs.push({
                        text: item.text,
                        isContinued: item.isContinued
                    });
                } 
                else {
                    measureBox.removeChild(p); 
                    
                    const currentBaseHeight = measureBox.scrollHeight;
                    const availableHeight = limitHeight - currentBaseHeight;

                    if (availableHeight < 18) {
                        queue.unshift(item);
                    } else {
                        const splitIdx = findSplitIndex(item.text, availableHeight, item.isContinued);
                        
                        if (splitIdx > 0) {
                            const partA = item.text.substring(0, splitIdx);
                            const partB = item.text.substring(splitIdx);

                            currentParagraphs.push({
                                text: partA,
                                isContinued: item.isContinued
                            });

                            if (partB.length > 0) {
                                queue.unshift({
                                    text: partB,
                                    isContinued: true
                                });
                            }
                        } else {
                            queue.unshift(item);
                        }
                    }

                    resultPages.push(currentParagraphs);
                    currentParagraphs = [];
                    
                    pageNum++;
                    measureBox.innerHTML = '';
                }
            }

            if (currentParagraphs.length > 0) {
                resultPages.push(currentParagraphs);
            }

            return resultPages;
        }

        function findSplitIndex(text, maxHeight, isContinued) {
            const measureBox = document.getElementById('measureContainer');
            const tempP = document.createElement('p');
            tempP.style.lineHeight = "1.8";
            tempP.style.marginBottom = "0";
            
            if (isContinued) tempP.classList.add('continued');
            else tempP.style.textIndent = '1em';
            
            measureBox.appendChild(tempP);
            
            let low = 0;
            let high = text.length;
            let bestIdx = 0;

            while (low <= high) {
                const mid = Math.floor((low + high) / 2);
                const subText = text.substring(0, mid);
                tempP.textContent = subText;
                
                if (tempP.offsetHeight <= maxHeight) {
                    bestIdx = mid;
                    low = mid + 1;
                } else {
                    high = mid - 1;
                }
            }
            
            measureBox.removeChild(tempP);
            return bestIdx;
        }


        // --- ë Œë”ë§ ë° UI ---
        function renderCurrentPage() {
            const viewer = document.getElementById('bookViewer');
            
            if (pageHighlights[currentPageIdx]) {
                viewer.innerHTML = pageHighlights[currentPageIdx];
                attachHighlightEvents(); 
                updateNavButtons();
                return;
            }

            const pageData = pages[currentPageIdx];
            const novelTitle = document.getElementById('novelTitle').value;
            const authorName = document.getElementById('authorName').value;
            const producerName = document.getElementById('producerName').value;
            const iconUrl = document.getElementById('iconSelect').value;
            
            const pageNum = currentPageIdx + 1;
            const isOdd = pageNum % 2 !== 0;

            let html = `
                <div id="captureTarget" class="page-container">
            `;

            // [ê¸°ëŠ¥ ì¶”ê°€] 1í˜ì´ì§€ ìƒë‹¨ ì•„ì´ì½˜
            if (currentPageIdx === 0 && iconUrl) {
                html += `
                    <img src="${iconUrl}" 
                         style="position: absolute; top: 50px; left: 50%; transform: translateX(-50%); 
                                width: 36px; height: 36px; object-fit: cover; 
                                border-radius: 50%; filter: grayscale(100%); opacity: 0.8; z-index: 10;"
                         alt="icon" crossorigin="anonymous"
                    >
                `;
            }

            html += `<div class="page-content" id="pageContentArea">`;

            if (currentPageIdx === 0 && novelTitle) {
                html += `
                    <div style="height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 0;">
                        <h1 class="text-base tracking-[0.1em] text-slate-700 font-normal text-center px-4" style="line-height: 1.8; max-height: 70px; overflow: hidden;">${novelTitle}</h1>
                        <div class="w-8 h-[1px] bg-slate-400 opacity-50 mx-auto mt-14"></div>
                    </div>
                `;
            }

            pageData.forEach(p => {
                const className = p.isContinued ? 'continued' : '';
                html += `<p class="${className}" style="line-height: 1.8 !important">${p.text}</p>`;
            });

            html += `</div>`;

            const footerInfo = [producerName, authorName].filter(Boolean).join(' Â· ');
            
            html += `
                <div class="page-footer-area text-[9px] text-gray-400 ${isOdd ? 'justify-end' : 'justify-start'}">
                    <div class="flex items-center gap-2 ${isOdd ? 'flex-row' : 'flex-row-reverse'}">
                        ${footerInfo ? `<span>${footerInfo}</span>` : ''}
                        <span class="font-normal text-gray-500">${pageNum}</span>
                    </div>
                </div>
            </div>`;

            viewer.innerHTML = html;
            attachHighlightEvents();
            updateNavButtons();
        }

        function updateNavButtons() {
            const pageNum = currentPageIdx + 1;
            document.getElementById('pageIndicator').textContent = `${pageNum} / ${pages.length}`;
            document.getElementById('btnPrev').disabled = currentPageIdx === 0;
            document.getElementById('btnNext').disabled = currentPageIdx === pages.length - 1;
        }

        function saveCurrentPageState() {
            const target = document.getElementById('captureTarget');
            if (target) {
                pageHighlights[currentPageIdx] = document.getElementById('bookViewer').innerHTML;
            }
        }

        function prevPage() {
            if (currentPageIdx > 0) {
                saveCurrentPageState();
                currentPageIdx--;
                renderCurrentPage();
            }
        }

        function nextPage() {
            if (currentPageIdx < pages.length - 1) {
                saveCurrentPageState();
                currentPageIdx++;
                renderCurrentPage();
            }
        }

        // --- í˜•ê´‘íœ ê¸°ëŠ¥ ---
        function toggleHighlightMode() {
            isHighlightMode = !isHighlightMode;
            updateHighlightUI();
        }

        function updateHighlightUI() {
            const btn = document.getElementById('highlightToggle');
            const palette = document.getElementById('colorPalette');
            
            if (isHighlightMode) {
                btn.textContent = "í˜•ê´‘íœ ë„ê¸°";
                btn.classList.add('bg-slate-200');
                palette.style.display = 'flex';
            } else {
                btn.textContent = "í˜•ê´‘íœ ì¼œê¸°";
                btn.classList.remove('bg-slate-200');
                palette.style.display = 'none';
            }
        }

        function setHighlightColor(colorClass, btnElement) {
            currentHighlightColor = colorClass;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
        }

        function attachHighlightEvents() {
            const contentArea = document.getElementById('pageContentArea');
            if (!contentArea) return;

            contentArea.addEventListener('mouseup', handleSelection);
            contentArea.addEventListener('touchend', handleSelection); 
            
            contentArea.querySelectorAll('.highlight').forEach(span => {
                span.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (!isHighlightMode) return;
                    const text = this.textContent;
                    const textNode = document.createTextNode(text);
                    this.parentNode.replaceChild(textNode, this);
                    saveCurrentPageState();
                });
            });
        }

        function handleSelection() {
            if (!isHighlightMode) return;

            const selection = window.getSelection();
            if (!selection.rangeCount || selection.toString().trim() === '') return;

            const range = selection.getRangeAt(0);
            const contentArea = document.getElementById('pageContentArea');
            if (!contentArea.contains(range.commonAncestorContainer)) return;

            try {
                const span = document.createElement('span');
                span.className = `highlight ${currentHighlightColor}`;
                
                span.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (!isHighlightMode) return;
                    const text = this.textContent;
                    const textNode = document.createTextNode(text);
                    this.parentNode.replaceChild(textNode, this);
                    saveCurrentPageState();
                });
                
                range.surroundContents(span);
                selection.removeAllRanges();
                saveCurrentPageState();
            } catch (e) {
                console.log("ë³µì¡í•œ ì„ íƒ ì˜ì—­ì…ë‹ˆë‹¤. ë‹¨ì¼ ë¬¸ë‹¨ ë‚´ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
            }
        }

        // --- ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ (html-to-image ì‚¬ìš©) ---
        async function downloadCurrentPage() {
            const page = document.getElementById('captureTarget');
            const title = document.getElementById('novelTitle').value || 'novel';
            const fileName = `${title}_${currentPageIdx + 1}p.png`;
            
            if (typeof htmlToImage === 'undefined') {
                alert('ì´ë¯¸ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë¡œë”© í‘œì‹œ
            const downloadBtn = document.getElementById('downloadBtn');
            const originalBtnText = downloadBtn.textContent;
            downloadBtn.textContent = 'ìƒì„± ì¤‘...';
            downloadBtn.disabled = true;

            try {
                console.log('[ë‹¤ìš´ë¡œë“œ] ì´ë¯¸ì§€ ìƒì„± ì‹œì‘...');
                
                // 1. í°íŠ¸ ë¡œë“œ ë³´ì¥
                await ensureFontsLoaded();
                
                // 2. iOS ëŒ€ì‘: í°íŠ¸ ì„ë² ë“œ CSS
                const fontEmbedCSS = await prepareFontEmbedCSS();
                
                // 3. ì˜µì…˜
                const options = {
                    quality: 1.0,
                    pixelRatio: 2,
                    cacheBust: true,
                    backgroundColor: '#ffffff',
                    preferredFontFormat: 'woff2',
                    skipFonts: true 
                };
                
                if (fontEmbedCSS) {
                    options.fontEmbedCSS = fontEmbedCSS;
                }
                
                // 4. Blob ìƒì„±
                const blob = await htmlToImage.toBlob(page, options);
                
                console.log('[ë‹¤ìš´ë¡œë“œ] ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ, í¬ê¸°:', blob.size);
                
                // 5. iOS ê³µìœ  ë˜ëŠ” ë‹¤ìš´ë¡œë“œ
                if (isIOS() && navigator.share && navigator.canShare) {
                    const file = new File([blob], fileName, { type: 'image/png' });
                    if (navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: fileName
                            });
                        } catch (shareError) {
                            if (shareError.name !== 'AbortError') {
                                console.error('ê³µìœ  ì‹¤íŒ¨:', shareError);
                                downloadBlobFallback(blob, fileName);
                            }
                        }
                    } else {
                        downloadBlobFallback(blob, fileName);
                    }
                } else {
                    downloadBlobFallback(blob, fileName);
                }
                
            } catch (error) {
                console.error('[ë‹¤ìš´ë¡œë“œ] ì‹¤íŒ¨:', error);
                alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                downloadBtn.textContent = originalBtnText;
                downloadBtn.disabled = false;
            }
        }

        function downloadBlobFallback(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = fileName;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }

        async function downloadAllPages() {
            const title = document.getElementById('novelTitle').value || 'novel';
            const total = pages.length;
            
            // [iOS ëŒ€ì‘] ë²„íŠ¼ì´ ìˆ¨ê²¨ì ¸ ìˆì§€ë§Œ í˜¹ì‹œ ì‹¤í–‰ë  ê²½ìš° ì°¨ë‹¨
            if (isIOS()) {
                alert('iOSì—ì„œëŠ” í˜„ì¬ í˜ì´ì§€ ì €ì¥ ê¸°ëŠ¥ë§Œ ì§€ì›í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (typeof htmlToImage === 'undefined') {
                alert('ì´ë¯¸ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!confirm(`ì´ ${total}ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.`)) return;

            // 1. í˜„ì¬ ìƒíƒœ ì €ì¥
            saveCurrentPageState();
            const originalPageIdx = currentPageIdx;
            
            window.scrollTo(0, 0);

            // 2. ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
            const overlay = document.getElementById('loadingOverlay');
            const progress = document.getElementById('loadingProgress');
            overlay.style.display = 'flex';
            progress.textContent = 'ì¤€ë¹„ ì¤‘...';

            // 3. í°íŠ¸ CSS ì¤€ë¹„
            await ensureFontsLoaded();
            const fontEmbedCSS = await prepareFontEmbedCSS();

            // 4. PC/ì•ˆë“œë¡œì´ë“œ ìˆœì°¨ ë‹¤ìš´ë¡œë“œ
            for (let i = 0; i < total; i++) {
                currentPageIdx = i;
                renderCurrentPage();
                
                // ë Œë”ë§ ëŒ€ê¸° (PCëŠ” ì§§ì•„ë„ ë¨)
                await new Promise(resolve => setTimeout(resolve, 300));
                progress.textContent = Math.floor(((i + 1) / total) * 100);
                
                try {
                    const page = document.getElementById('captureTarget');
                    const options = {
                        quality: 1.0,
                        pixelRatio: 2,
                        cacheBust: true,
                        backgroundColor: '#ffffff',
                        skipFonts: true
                    };
                    
                    if (fontEmbedCSS) options.fontEmbedCSS = fontEmbedCSS;
                    
                    const blob = await htmlToImage.toBlob(page, options);
                    const fileName = `${title}_${String(i+1).padStart(3, '0')}p.png`;
                    
                    downloadBlobFallback(blob, fileName);
                    
                    // ë¸Œë¼ìš°ì € ë¶€í•˜ ë°©ì§€ìš© ë”œë ˆì´
                    await new Promise(resolve => setTimeout(resolve, 200));

                } catch (error) {
                    console.error(`[ë‹¤ìš´ë¡œë“œ] í˜ì´ì§€ ${i+1} ìƒì„± ì‹¤íŒ¨:`, error);
                }
            }

            overlay.style.display = 'none';
            currentPageIdx = originalPageIdx;
            renderCurrentPage();
            alert("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function resetApp() {
            if (confirm('ì‘ì—… ë‚´ìš©ì„ ì§€ìš°ê³  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                location.reload();
            }
        }
    </script>
</body>
</html>
